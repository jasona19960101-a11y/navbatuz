<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ ‚Äî Admin</title>
  <style>
    :root{
      --bg1:#070b16; --bg2:#0b1020;
      --card:rgba(255,255,255,.06);
      --b:rgba(255,255,255,.14);
      --t:#e8eeff; --muted:rgba(232,238,255,.65);
      --ok:#52ffa8; --bad:#ff6b6b; --warn:#ffd166;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--t);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(82,255,168,.15), transparent 55%),
        radial-gradient(900px 500px at 90% 35%, rgba(120,130,255,.18), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .badge{
      width:38px;height:38px;border-radius:14px;border:1px solid var(--b);
      background:rgba(255,255,255,.06);display:grid;place-items:center;box-shadow:var(--shadow)
    }
    .title{font-weight:900;letter-spacing:.6px;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    input,select{
      background:rgba(255,255,255,.06);color:var(--t);
      border:1px solid var(--b);border-radius:12px;padding:10px 12px;outline:none;
    }
    input::placeholder{color:rgba(232,238,255,.45)}
    input.mid{min-width:240px}
    input.wide{min-width:320px}

    button{
      border:1px solid var(--b);
      background:rgba(255,255,255,.08);
      color:var(--t);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.12)}
    button.primary{border-color:rgba(82,255,168,.35);background:rgba(82,255,168,.12)}
    button.danger{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12)}
    button.warn{border-color:rgba(255,209,102,.35);background:rgba(255,209,102,.12)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
    @media (max-width:980px){.kpis{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:620px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05)
    }
    .kpi .l{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:900;margin-top:2px}

    .msg{margin-top:10px;font-size:13px;color:var(--muted)}
    .msg .ok{color:var(--ok)}
    .msg .bad{color:var(--bad)}
    .msg .warn{color:var(--warn)}

    table{width:100%;border-collapse:collapse;margin-top:10px;overflow:hidden;border-radius:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:middle}
    th{color:rgba(232,238,255,.75);text-align:left;font-weight:800}
    tr:hover td{background:rgba(255,255,255,.03)}
    .pill{
      display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);font-size:12px
    }
    .pill.ok{border-color:rgba(82,255,168,.35);background:rgba(82,255,168,.10)}
    .pill.warn{border-color:rgba(255,209,102,.35);background:rgba(255,209,102,.10)}
    .pill.bad{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.10)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .small{font-size:12px;color:rgba(232,238,255,.6)}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
    .btnMini{padding:7px 10px;border-radius:10px;font-size:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}

    /* Searchable org dropdown */
    .dropWrap{position:relative;min-width:260px;flex:1}
    .dropList{
      position:absolute; left:0; right:0; top:44px;
      background:rgba(10,16,32,.95);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,.45);
      max-height:280px;
      overflow:auto;
      z-index:999;
      display:none;
    }
    .dropItem{
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
      color:rgba(232,238,255,.9);
    }
    .dropItem:hover{background:rgba(255,255,255,.06)}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="badge">üõ†Ô∏è</div>
        <div>
          <div class="title">NAVBATUZ ‚Äî Admin Panel</div>
          <div class="sub">Viloyat ‚Üí Tuman ‚Üí Muassasa ‚Ä¢ Barcha statuslar ‚Ä¢ Next / Delete / Skip</div>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="btnRefresh" onclick="loadQueue()">üîÑ Yangilash</button>
        <button id="btnAuto" onclick="toggleAuto()">‚è± Auto: OFF</button>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT -->
      <div class="card">

        <div class="row">
          <select id="selRegion" onchange="onRegionChange()">
            <option value="">Viloyat tanlang...</option>
          </select>

          <select id="selDistrict" onchange="onDistrictChange()">
            <option value="">Tuman tanlang...</option>
          </select>

          <!-- MUASSASA: searchable -->
          <div class="dropWrap">
            <input id="orgSearch" placeholder="Muassasa qidiring / tanlang..." oninput="filterOrgList()" onclick="openOrgList()" />
            <div id="orgList" class="dropList"></div>
          </div>
          <input id="orgIdHidden" type="hidden" />

          <input id="adminKey" class="wide" placeholder="ADMIN_KEY (Render env dagi)" />
        </div>

        <div class="row" style="margin-top:10px">
          <input id="search" class="mid" placeholder="Search: ism / #raqam / status" oninput="renderTable()" />
          <select id="statusFilter" onchange="renderTable()">
            <option value="all">Status: hammasi</option>
            <option value="waiting">waiting</option>
            <option value="missed">missed</option>
            <option value="served">served</option>
            <option value="cancelled">cancelled</option>
          </select>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="l">Now serving</div><div class="v" id="kNow">‚Äî</div></div>
          <div class="kpi"><div class="l">Last number</div><div class="v" id="kLast">‚Äî</div></div>
          <div class="kpi"><div class="l">Avg service</div><div class="v" id="kAvg">‚Äî</div></div>
          <div class="kpi"><div class="l">Jami (total)</div><div class="v" id="kTotal">‚Äî</div></div>
          <div class="kpi"><div class="l">Kutayotgan</div><div class="v" id="kWaiting">‚Äî</div></div>
          <div class="kpi"><div class="l">Xizmat ko‚Äòrsatilgan</div><div class="v" id="kServed">‚Äî</div></div>
        </div>

        <div class="small" style="margin-top:8px">
          Bekor qilingan: <b id="kCancelled">‚Äî</b> ‚Ä¢ Missed: <b id="kMissed">‚Äî</b>
        </div>

        <div id="msg" class="msg"></div>

        <div class="toolbar" id="orgToolbar" style="display:none">
          <button class="primary" onclick="nextOne()">‚û°Ô∏è NEXT (navbatni chaqirish)</button>
          <span class="small">* Xizmat tugagach bosib, keyingi navbatchini chaqirasiz</span>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:80px">#</th>
              <th>Ism familiya</th>
              <th style="width:120px">ETA</th>
              <th style="width:190px">Ticket olgan</th>
              <th style="width:110px">Status</th>
              <th style="width:230px">Amallar</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="small" style="margin-top:10px">
          * ETA faqat waiting/missed uchun hisoblanadi: (qolgan navbat soni) √ó avgServiceSec.
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div style="font-weight:900">Tez amallar</div>
        <div class="small">Tanlangan muassasa bo‚Äòyicha.</div>

        <div class="divider"></div>

        <div class="row">
          <button class="warn" onclick="deleteAll()">üßπ Delete ALL (waiting/missed)</button>
          <button class="danger" onclick="resetOrg()">üí£ RESET</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <label class="small">Auto refresh:</label>
          <select id="autoEvery" onchange="applyAutoInterval()">
            <option value="0">OFF</option>
            <option value="3">3s</option>
            <option value="5">5s</option>
            <option value="10" selected>10s</option>
            <option value="20">20s</option>
            <option value="30">30s</option>
          </select>
          <button onclick="applyAutoInterval()">‚úÖ Apply</button>
        </div>

        <div class="divider"></div>

        <div class="small">
          Admin URL: <span class="mono">/admin.html</span>
        </div>
      </div>

    </div>
  </div>

<script>
  let GEO = null;
  let REGIONS = [];
  let DISTRICTS = [];
  let ORGS_BY_KEY = {}; // orgsByUnitUzKey

  let ORG_LIST = [];
  let lastData = null;

  let autoTimer = null;
  let autoOn = false;

  function $(id){ return document.getElementById(id); }
  function esc(s){ return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function key(){ return ($("adminKey").value || "").trim(); }

  function setMsg(type, text){
    const cls = type === "ok" ? "ok" : (type === "warn" ? "warn" : "bad");
    $("msg").innerHTML = `<span class="${cls}">${type.toUpperCase()}:</span> ${esc(text)}`;
  }

  async function api(url, opts={}){
    const headers = Object.assign({}, opts.headers || {}, {
      "Content-Type": "application/json",
      "X-Admin-Key": key()
    });
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=>({ ok:false, error:"JSON parse error" }));
    if (!res.ok) throw new Error(data?.error || ("HTTP " + res.status));
    return data;
  }

  // -------------------------
  // Name helpers
  // -------------------------
  function pickName(o){
    if (!o) return "";
    if (typeof o.name === "object" && o.name) return o.name.uz || o.name.ru || o.name.en || "";
    return o.name_uz || o.nameUz || o.name || o.title || o.label || "";
  }
  function regionName(r){ return pickName(r) || String(r.id ?? ""); }
  function districtName(d){ return pickName(d) || String(d.id ?? ""); }
  function districtRegionId(d){
    return d.region_id ?? d.regionId ?? d.parent_id ?? d.parentId ?? d.region ?? null;
  }

  // -------------------------
  // GEO load
  // -------------------------
  async function loadGeo(){
    const r = await fetch("/api/geo");
    GEO = await r.json();

    ORGS_BY_KEY = GEO.orgsByUnitUzKey || {};

    const srcRegions = GEO?.sources?.regions;
    const srcDistricts = GEO?.sources?.districts;

    if (!srcRegions || !srcDistricts){
      throw new Error("geo.json ichida sources.regions yoki sources.districts yo‚Äòq");
    }

    const [rg, ds] = await Promise.all([
      fetch(srcRegions).then(x => x.json()),
      fetch(srcDistricts).then(x => x.json()),
    ]);

    REGIONS = Array.isArray(rg) ? rg : [];
    DISTRICTS = Array.isArray(ds) ? ds : [];

    if (!REGIONS.length) throw new Error("regions list bo‚Äòsh");
    if (!DISTRICTS.length) throw new Error("districts list bo‚Äòsh");
  }

  // -------------------------
  // Fill selects
  // -------------------------
  function fillRegions(){
    const sel = $("selRegion");
    sel.innerHTML = `<option value="">Viloyat tanlang...</option>`;
    for (const r of REGIONS){
      sel.innerHTML += `<option value="${esc(String(r.id))}">${esc(regionName(r))}</option>`;
    }
    $("selDistrict").innerHTML = `<option value="">Tuman tanlang...</option>`;
    resetOrgPicker();
  }

  function onRegionChange(){
    const rid = ($("selRegion").value || "").trim();
    $("selDistrict").innerHTML = `<option value="">Tuman tanlang...</option>`;
    resetOrgPicker();
    clearTable();

    if (!rid) return;

    const list = DISTRICTS.filter(d => String(districtRegionId(d)) === String(rid));
    for (const d of list){
      $("selDistrict").innerHTML += `<option value="${esc(String(d.id))}">${esc(districtName(d))}</option>`;
    }
  }

  function onDistrictChange(){
    resetOrgPicker();
    clearTable();

    const rid = ($("selRegion").value || "").trim();
    const did = ($("selDistrict").value || "").trim();
    if (!rid || !did) return;

    const rObj = REGIONS.find(r => String(r.id) === String(rid));
    const dObj = DISTRICTS.find(d => String(d.id) === String(did));
    if (!rObj || !dObj) return;

    const rName = regionName(rObj);
    const dName = districtName(dObj);

    const k = `${rName}|${dName}`;
    ORG_LIST = (ORGS_BY_KEY[k] || []).slice();

    if (!ORG_LIST.length){
      setMsg("warn", `Bu joy uchun muassasa topilmadi: "${k}" (geo.json orgsByUnitUzKey tekshir).`);
      return;
    }

    renderOrgList(ORG_LIST);
    setMsg("ok", `Muassasa tanlang (topildi: ${ORG_LIST.length} ta)`);
  }

  // -------------------------
  // Searchable org dropdown
  // -------------------------
  function resetOrgPicker(){
    ORG_LIST = [];
    $("orgSearch").value = "";
    $("orgIdHidden").value = "";
    $("orgList").style.display = "none";
    $("orgToolbar").style.display = "none";
  }

  function openOrgList(){
    if (!ORG_LIST.length) return;
    $("orgList").style.display = "block";
  }
  function closeOrgList(){ $("orgList").style.display = "none"; }

  function renderOrgList(list){
    const box = $("orgList");
    box.innerHTML = "";
    const show = list.slice(0, 800);
    for (const o of show){
      const item = document.createElement("div");
      item.className = "dropItem";
      item.textContent = pickName(o) || String(o.id);
      item.onclick = () => selectOrg(o);
      box.appendChild(item);
    }
    box.style.display = "block";
  }

  function filterOrgList(){
    const q = ($("orgSearch").value || "").trim().toLowerCase();
    if (!ORG_LIST.length) return;
    const filtered = !q ? ORG_LIST : ORG_LIST.filter(o => (pickName(o) || "").toLowerCase().includes(q));
    renderOrgList(filtered);
  }

  function selectOrg(o){
    $("orgSearch").value = pickName(o) || String(o.id);
    $("orgIdHidden").value = String(o.id);
    closeOrgList();
    $("orgToolbar").style.display = "flex";
    loadQueue();
  }

  document.addEventListener("click", (e) => {
    const wrap = e.target.closest(".dropWrap");
    if (!wrap) closeOrgList();
  });

  function selectedOrgId(){ return ($("orgIdHidden").value || "").trim(); }

  // -------------------------
  // Queue table
  // -------------------------
  function clearTable(){
    $("tbody").innerHTML = `<tr><td colspan="6" class="small">Muassasa tanlang...</td></tr>`;
    $("kNow").textContent="‚Äî"; $("kLast").textContent="‚Äî"; $("kAvg").textContent="‚Äî";
    $("kTotal").textContent="‚Äî"; $("kWaiting").textContent="‚Äî"; $("kServed").textContent="‚Äî";
    $("kCancelled").textContent="‚Äî"; $("kMissed").textContent="‚Äî";
    lastData = null;
  }

  function updateKPIs(data){
    $("kNow").textContent  = data?.nowServing ?? "‚Äî";
    $("kLast").textContent = data?.lastNumber ?? "‚Äî";
    $("kAvg").textContent  = (data?.avgServiceSec ? (Math.round(data.avgServiceSec/60) + " min") : "‚Äî");

    const c = data?.counts || {};
    $("kTotal").textContent = (c.total ?? 0);
    $("kWaiting").textContent = (c.waiting ?? 0);
    $("kServed").textContent = (c.served ?? 0);
    $("kCancelled").textContent = (c.cancelled ?? 0);
    $("kMissed").textContent = (c.missed ?? 0);
  }

  function statusPill(s){
    if (s === "waiting") return `<span class="pill ok">waiting</span>`;
    if (s === "missed") return `<span class="pill warn">missed</span>`;
    if (s === "served") return `<span class="pill ok">served</span>`;
    if (s === "cancelled") return `<span class="pill bad">cancelled</span>`;
    return `<span class="pill">${esc(s)}</span>`;
  }

  function createdText(t){
    try{ return t.createdAt ? new Date(t.createdAt).toLocaleString() : ""; }
    catch{ return t.createdAt || ""; }
  }

  function etaText(t){
    if (t.status !== "waiting" && t.status !== "missed") return "‚Äî";
    if (t.etaMinutes === null || t.etaMinutes === undefined) return "‚Äî";
    return `${t.etaMinutes} min`;
  }

  function renderTable(){
    const tb = $("tbody");
    const q = ($("search").value || "").trim().toLowerCase();
    const sf = $("statusFilter").value;

    const list = (lastData?.tickets || []).filter(t => {
      if (sf !== "all" && (t.status !== sf)) return false;
      if (!q) return true;
      const num = (t.number ?? "").toString();
      const name = (t.fullName || "").toLowerCase();
      const st = (t.status || "").toLowerCase();
      return num.includes(q.replace("#","")) || name.includes(q) || st.includes(q);
    });

    if (!list.length){
      tb.innerHTML = `<tr><td colspan="6" class="small">Ro‚Äòyxat bo‚Äòsh (filter/search bilan ham topilmadi).</td></tr>`;
      return;
    }

    tb.innerHTML = list.map(t => {
      const ct = createdText(t);
      const eta = etaText(t);

      const canSkip = (t.status === "waiting");
      const canDelete = (t.status === "waiting" || t.status === "missed");

      return `
        <tr>
          <td><span class="pill">#${esc(t.number)}</span></td>
          <td>${esc(t.fullName || "")}</td>
          <td><b>${esc(eta)}</b></td>
          <td class="small">${esc(ct)}</td>
          <td>${statusPill(t.status)}</td>
          <td>
            <button class="btnMini danger" ${canDelete ? "" : "disabled"} onclick="deleteTicket('${esc(t.id)}')">Delete</button>
            <button class="btnMini warn" ${canSkip ? "" : "disabled"} onclick="skipTicket('${esc(t.id)}')">Skip</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function loadQueue(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");

    $("btnRefresh").disabled = true;
    try{
      const data = await api(`/api/admin/queue?orgId=${encodeURIComponent(orgId)}`, { method:"GET" });
      lastData = data;
      updateKPIs(data);
      renderTable();
      setMsg("ok", `Yangilandi. Jami: ${(data.counts?.total ?? 0)} ta, waiting: ${(data.counts?.waiting ?? 0)} ta`);
    }catch(e){
      setMsg("bad", e.message);
    }finally{
      $("btnRefresh").disabled = false;
    }
  }

  // Actions
  async function nextOne(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("NEXT qilamizmi? (navbat oldinga suriladi)")) return;

    try{
      await api(`/api/admin/next`, { method:"POST", body: JSON.stringify({ orgId }) });
      setMsg("ok","NEXT OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function deleteTicket(ticketId){
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("Ticket CANCEL (delete) qilinsinmi?")) return;

    try{
      await api(`/api/admin/delete`, { method:"POST", body: JSON.stringify({ ticketId }) });
      setMsg("ok","Delete OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function skipTicket(ticketId){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("O‚Äòtkazib yuboramizmi? (waiting -> missed)")) return;

    try{
      await api(`/api/admin/skip`, { method:"POST", body: JSON.stringify({ orgId, ticketId }) });
      setMsg("ok","Skip OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function deleteAll(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("HAMMASI (waiting/missed) CANCEL bo‚Äòlsinmi?")) return;

    try{
      const r = await api(`/api/admin/deleteAll`, { method:"POST", body: JSON.stringify({ orgId }) });
      setMsg("ok", `DeleteAll OK. cancelledCount: ${r.cancelledCount ?? 0}`);
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function resetOrg(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("RESET xavfli: current=0 next=1 va waiting/missed CANCEL. Davom etamizmi?")) return;

    try{
      await api(`/api/admin/reset`, { method:"POST", body: JSON.stringify({ orgId }) });
      setMsg("warn","RESET OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  // Auto refresh
  function toggleAuto(){
    autoOn = !autoOn;
    if (autoOn) applyAutoInterval(true);
    else stopAuto();
  }
  function stopAuto(){
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
    autoOn = false;
    $("btnAuto").textContent = "‚è± Auto: OFF";
  }
  function applyAutoInterval(forceOn=false){
    const sec = Number(($("autoEvery").value || 0));
    if (!sec || sec <= 0) { stopAuto(); return; }
    if (forceOn) autoOn = true;
    if (!autoOn) autoOn = true;

    if (autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(() => loadQueue(), sec * 1000);
    $("btnAuto").textContent = `‚è± Auto: ON (${sec}s)`;
    loadQueue();
  }

  // boot
  async function init(){
    try{
      await loadGeo();
      fillRegions();
      clearTable();
      setMsg("warn","Viloyat ‚Üí Tuman tanlang, keyin muassasa qidirib tanlang. ADMIN_KEY kiriting.");
    }catch(e){
      setMsg("bad", "GEO xato: " + e.message);
      clearTable();
    }
  }
  init();
</script>
</body>
</html>

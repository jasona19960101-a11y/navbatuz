<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ ‚Äî Admin</title>
  <style>
    :root{
      --bg:#0b1020; --card:rgba(255,255,255,.06); --b:rgba(255,255,255,.12);
      --t:#e8eeff; --muted:rgba(232,238,255,.65); --ok:#52ffa8; --bad:#ff6b6b; --warn:#ffd166;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--t); background:radial-gradient(900px 500px at 10% 10%, rgba(82,255,168,.15), transparent 55%),
          radial-gradient(900px 500px at 90% 35%, rgba(120,130,255,.18), transparent 55%),
          linear-gradient(180deg, #070b16, #0b1020);}
    .wrap{max-width:1100px; margin:0 auto; padding:20px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px;}
    .brand{display:flex; gap:10px; align-items:center;}
    .badge{width:34px;height:34px;border-radius:12px;border:1px solid var(--b); background:rgba(255,255,255,.06); display:grid; place-items:center; box-shadow:var(--shadow);}
    .title{font-weight:800; letter-spacing:.7px}
    .sub{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{background:var(--card); border:1px solid var(--b); border-radius:var(--r); padding:14px; box-shadow:var(--shadow);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input, select{
      background:rgba(255,255,255,.06); color:var(--t);
      border:1px solid var(--b); border-radius:12px; padding:10px 12px;
      outline:none; min-width: 240px;
    }
    input::placeholder{color:rgba(232,238,255,.45)}
    button{
      border:1px solid var(--b); background:rgba(255,255,255,.08);
      color:var(--t); border-radius:12px; padding:10px 12px;
      cursor:pointer;
    }
    button:hover{background:rgba(255,255,255,.12)}
    button.primary{border-color:rgba(82,255,168,.35); background:rgba(82,255,168,.12)}
    button.danger{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.12)}
    button.warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.12)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px;}
    @media (max-width: 760px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    .kpi{padding:10px 12px; border-radius:14px; border:1px solid var(--b); background:rgba(255,255,255,.05)}
    .kpi .l{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:20px; font-weight:800; margin-top:2px}

    table{width:100%; border-collapse:collapse; margin-top:10px; overflow:hidden; border-radius:14px;}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:13px;}
    th{color:rgba(232,238,255,.75); text-align:left; font-weight:700}
    tr:hover td{background:rgba(255,255,255,.03)}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--b); background:rgba(255,255,255,.06); font-size:12px;}
    .pill.ok{border-color:rgba(82,255,168,.35); background:rgba(82,255,168,.10)}
    .pill.bad{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.10)}
    .pill.warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.10)}
    .msg{margin-top:10px; font-size:13px; color:var(--muted)}
    .err{color:var(--bad)}
    .oktxt{color:var(--ok)}
    .small{font-size:12px; color:rgba(232,238,255,.6)}
    .rightActions{display:flex; gap:10px; flex-wrap:wrap}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="badge">üõ†Ô∏è</div>
      <div>
        <div class="title">NAVBATUZ ‚Äî Admin Panel</div>
        <div class="sub">Next / Delete / Live queue monitoring</div>
      </div>
    </div>
    <div class="small">URL: <span id="baseUrl"></span></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <input id="orgId" placeholder="orgId (masalan: yallama_moyka)" />
        <button class="primary" id="btnLoad">Load</button>
        <button id="btnRefresh">Refresh</button>
        <label class="small"><input type="checkbox" id="auto" checked /> auto (5s)</label>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="l">Now serving</div><div class="v" id="kNow">‚Äî</div></div>
        <div class="kpi"><div class="l">Last number</div><div class="v" id="kLast">‚Äî</div></div>
        <div class="kpi"><div class="l">Avg service</div><div class="v" id="kAvg">‚Äî</div></div>
        <div class="kpi"><div class="l">Waiting count</div><div class="v" id="kCnt">‚Äî</div></div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:space-between;">
        <div class="rightActions">
          <button class="warn" id="btnNext">NEXT ‚ûú</button>
          <button class="danger" id="btnDelSelected">Delete selected</button>
          <button class="danger" id="btnDelAll">Delete ALL (waiting/missed)</button>
        </div>
        <div class="small">Delete bosilganda admin parol so‚Äòraladi.</div>
      </div>

      <div class="msg" id="msg"></div>

      <table>
        <thead>
          <tr>
            <th style="width:42px;">Sel</th>
            <th style="width:70px;">No</th>
            <th style="width:110px;">Status</th>
            <th>Name</th>
            <th style="width:170px;">Created</th>
            <th style="width:110px;">Ticket ID</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="small">Load qiling‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:8px;">Qo‚Äòshimcha admin funksiyalar</div>
      <div class="small">
        ‚úÖ Next (navbatni oldinga surish)<br/>
        ‚úÖ Bitta userni (ticket) bekor qilish (cancel/delete)<br/>
        ‚úÖ Hammasini (waiting/missed) bekor qilish<br/>
        ‚úÖ Live refresh (auto polling)<br/><br/>
        Tavsiya (xohlasang keyin qo‚Äòshamiz):<br/>
        ‚Ä¢ Admin log/audit (kim, qachon delete qildi)<br/>
        ‚Ä¢ Org ro‚Äòyxatini dropdown qilib chiqarish (geo.json dan)<br/>
        ‚Ä¢ ‚ÄúMark missed/served‚Äù tugmalar (agar kerak bo‚Äòlsa)<br/>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  const state = {
    orgId: "",
    timer: null,
    selectedId: null
  };

  $("baseUrl").textContent = location.origin;

  function setMsg(text, kind=""){
    $("msg").className = "msg " + (kind || "");
    $("msg").textContent = text || "";
  }

  async function api(url, opts={}){
    const r = await fetch(url, opts);
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j || !j.ok){
      const msg = (j && j.error) ? j.error : ("API error: " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  function askAdminKey(){
    const v = prompt("Admin parol (ADMIN_KEY) ni kiriting:");
    if (!v || v.length < 4) return null;
    return v;
  }

  function fmtDate(d){
    if (!d) return "-";
    try { return new Date(d).toLocaleString(); } catch { return String(d); }
  }

  function statusPill(st){
    const s = (st||"").toLowerCase();
    if (s === "waiting") return `<span class="pill ok">waiting</span>`;
    if (s === "missed")  return `<span class="pill warn">missed</span>`;
    if (s === "served")  return `<span class="pill ok">served</span>`;
    if (s === "cancelled") return `<span class="pill bad">cancelled</span>`;
    return `<span class="pill">${st||"-"}</span>`;
  }

  function render(data){
    $("kNow").textContent  = (data.nowServing ?? "‚Äî");
    $("kLast").textContent = (data.lastNumber ?? "‚Äî");
    $("kAvg").textContent  = (data.avgServiceSec ? (Math.round(data.avgServiceSec/60) + " min") : "‚Äî");
    $("kCnt").textContent  = (Array.isArray(data.tickets) ? data.tickets.length : 0);

    const rows = (data.tickets || []).map(t => {
      const id = String(t.id ?? "");
      const num = (t.number ?? "-");
      const st = (t.status ?? "-");
      const name = (t.fullName ?? t.full_name ?? "-");
      const created = fmtDate(t.createdAt ?? t.created_at);

      return `
        <tr>
          <td>
            <input type="radio" name="sel" value="${id}" ${state.selectedId===id?"checked":""}/>
          </td>
          <td><b>#${num}</b></td>
          <td>${statusPill(st)}</td>
          <td>${escapeHtml(name)}</td>
          <td class="small">${escapeHtml(created)}</td>
          <td class="small">${escapeHtml(id.slice(0,8))}</td>
        </tr>
      `;
    }).join("");

    $("tbody").innerHTML = rows || `<tr><td colspan="6" class="small">Hech narsa yo‚Äòq</td></tr>`;

    document.querySelectorAll('input[name="sel"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        state.selectedId = r.value;
      });
    });
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function load(){
    const org = ($("orgId").value || "").trim();
    if (!org) { setMsg("orgId kiriting", "err"); return; }
    state.orgId = org;
    setMsg("Loading‚Ä¶");

    const j = await api(`/api/admin/queue?orgId=${encodeURIComponent(org)}`);
    render(j);
    setMsg("OK", "oktxt");
  }

  async function doNext(){
    if (!state.orgId) { setMsg("Avval orgId Load qiling", "err"); return; }
    setMsg("NEXT‚Ä¶");
    const key = askAdminKey();
    if (!key) { setMsg("Bekor qilindi", ""); return; }

    const j = await api("/api/admin/next", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "X-Admin-Key": key },
      body: JSON.stringify({ orgId: state.orgId })
    });

    // next endpoint qaytargan current/nowServing/lastNumber bo‚Äòyicha darhol refresh qilamiz
    await load();
    setMsg("NEXT ‚úÖ", "oktxt");
  }

  async function deleteSelected(){
    if (!state.orgId) { setMsg("Avval orgId Load qiling", "err"); return; }
    if (!state.selectedId) { setMsg("Select qiling (radio)", "err"); return; }

    const ok = confirm("Tanlangan ticketni DELETE (cancel) qilamizmi?");
    if (!ok) return;

    const key = askAdminKey();
    if (!key) { setMsg("Bekor qilindi", ""); return; }

    setMsg("Deleting‚Ä¶");
    await api("/api/admin/delete", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "X-Admin-Key": key },
      body: JSON.stringify({ ticketId: state.selectedId })
    });

    state.selectedId = null;
    await load();
    setMsg("Deleted ‚úÖ", "oktxt");
  }

  async function deleteAll(){
    if (!state.orgId) { setMsg("Avval orgId Load qiling", "err"); return; }

    const ok = confirm("DIQQAT: Bu org bo‚Äòyicha barcha waiting/missed ticketlar CANCEL bo‚Äòladi. Davom etamizmi?");
    if (!ok) return;

    const key = askAdminKey();
    if (!key) { setMsg("Bekor qilindi", ""); return; }

    setMsg("Deleting ALL‚Ä¶");
    await api("/api/admin/deleteAll", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "X-Admin-Key": key },
      body: JSON.stringify({ orgId: state.orgId })
    });

    state.selectedId = null;
    await load();
    setMsg("Delete ALL ‚úÖ", "oktxt");
  }

  function startAuto(){
    stopAuto();
    state.timer = setInterval(()=>{
      if ($("auto").checked && state.orgId) load().catch(e=>setMsg(e.message,"err"));
    }, 5000);
  }
  function stopAuto(){
    if (state.timer) clearInterval(state.timer);
    state.timer = null;
  }

  $("btnLoad").addEventListener("click", ()=> load().catch(e=>setMsg(e.message,"err")));
  $("btnRefresh").addEventListener("click", ()=> load().catch(e=>setMsg(e.message,"err")));
  $("btnNext").addEventListener("click", ()=> doNext().catch(e=>setMsg(e.message,"err")));
  $("btnDelSelected").addEventListener("click", ()=> deleteSelected().catch(e=>setMsg(e.message,"err")));
  $("btnDelAll").addEventListener("click", ()=> deleteAll().catch(e=>setMsg(e.message,"err")));
  $("auto").addEventListener("change", startAuto);

  startAuto();
</script>
</body>
</html>

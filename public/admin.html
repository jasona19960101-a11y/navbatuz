<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ ‚Äî Admin</title>
  <style>
    :root{
      --bg1:#070b16; --bg2:#0b1020;
      --card:rgba(255,255,255,.06);
      --b:rgba(255,255,255,.14);
      --t:#e8eeff; --muted:rgba(232,238,255,.65);
      --ok:#52ffa8; --bad:#ff6b6b; --warn:#ffd166;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--t);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(82,255,168,.15), transparent 55%),
        radial-gradient(900px 500px at 90% 35%, rgba(120,130,255,.18), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .badge{
      width:38px;height:38px;border-radius:14px;border:1px solid var(--b);
      background:rgba(255,255,255,.06);display:grid;place-items:center;box-shadow:var(--shadow)
    }
    .title{font-weight:900;letter-spacing:.6px;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}

    .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{
      background:rgba(255,255,255,.06);color:var(--t);
      border:1px solid var(--b);border-radius:12px;padding:10px 12px;outline:none;
    }
    input::placeholder{color:rgba(232,238,255,.45)}
    input.mid{min-width:240px}
    input.wide{min-width:320px}

    button{
      border:1px solid var(--b);
      background:rgba(255,255,255,.08);
      color:var(--t);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.12)}
    button.primary{border-color:rgba(82,255,168,.35);background:rgba(82,255,168,.12)}
    button.danger{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12)}
    button.warn{border-color:rgba(255,209,102,.35);background:rgba(255,209,102,.12)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    @media (max-width:760px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05)
    }
    .kpi .l{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:900;margin-top:2px}

    .msg{margin-top:10px;font-size:13px;color:var(--muted)}
    .msg .ok{color:var(--ok)}
    .msg .bad{color:var(--bad)}
    .msg .warn{color:var(--warn)}

    table{width:100%;border-collapse:collapse;margin-top:10px;overflow:hidden;border-radius:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:middle}
    th{color:rgba(232,238,255,.75);text-align:left;font-weight:800}
    tr:hover td{background:rgba(255,255,255,.03)}
    .pill{
      display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);font-size:12px
    }
    .pill.ok{border-color:rgba(82,255,168,.35);background:rgba(82,255,168,.10)}
    .pill.warn{border-color:rgba(255,209,102,.35);background:rgba(255,209,102,.10)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .small{font-size:12px;color:rgba(232,238,255,.6)}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
    .btnMini{padding:7px 10px;border-radius:10px;font-size:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="badge">üõ†Ô∏è</div>
        <div>
          <div class="title">NAVBATUZ ‚Äî Admin Panel</div>
          <div class="sub">Viloyat ‚Üí Tuman ‚Üí Muassasa ‚Ä¢ Aktiv navbat ‚Ä¢ Next / Delete / Skip</div>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="btnRefresh" onclick="loadQueue()">üîÑ Yangilash</button>
        <button id="btnAuto" onclick="toggleAuto()">‚è± Auto: OFF</button>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT -->
      <div class="card">

        <div class="row">
          <select id="selRegion" onchange="onRegionChange()">
            <option value="">Viloyat tanlang...</option>
          </select>

          <select id="selDistrict" onchange="onDistrictChange()">
            <option value="">Tuman tanlang...</option>
          </select>

          <select id="selOrg" onchange="onOrgChange()">
            <option value="">Muassasa tanlang...</option>
          </select>

          <input id="adminKey" class="wide" placeholder="ADMIN_KEY (Render env dagi)" />
        </div>

        <div class="row" style="margin-top:10px">
          <input id="search" class="mid" placeholder="Search: ism / #raqam / status" oninput="renderTable()" />
          <select id="statusFilter" onchange="renderTable()">
            <option value="all">Status: hammasi</option>
            <option value="waiting">waiting</option>
            <option value="missed">missed</option>
          </select>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="l">Now serving</div>
            <div class="v" id="kNow">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="l">Last number</div>
            <div class="v" id="kLast">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="l">Avg service</div>
            <div class="v" id="kAvg">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="l">Aktiv navbat</div>
            <div class="v" id="kCnt">‚Äî</div>
          </div>
        </div>

        <div id="msg" class="msg"></div>

        <!-- NEXT tugma faqat muassasa tanlangandan keyin ko'rinadi -->
        <div class="toolbar" id="orgToolbar" style="display:none">
          <button class="primary" onclick="nextOne()">‚û°Ô∏è NEXT (navbatni chaqirish)</button>
          <span class="small">* Xizmat tugagach shu tugmani bosib keyingi navbatchini chaqirasiz</span>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:80px">#</th>
              <th>Ism familiya</th>
              <th style="width:120px">ETA</th>
              <th style="width:190px">Ticket olgan</th>
              <th style="width:110px">Status</th>
              <th style="width:230px">Amallar</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="small" style="margin-top:10px">
          * ETA = (qolgan navbat soni) √ó avgServiceSec. Agar avg topilmasa ‚Äú‚Äî‚Äù.
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div style="font-weight:900">Tez amallar</div>
        <div class="small">Tanlangan muassasa bo‚Äòyicha.</div>

        <div class="divider"></div>

        <div class="row">
          <button class="warn" onclick="deleteAll()">üßπ Delete ALL</button>
          <button class="danger" onclick="resetOrg()">üí£ RESET</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <label class="small">Auto refresh:</label>
          <select id="autoEvery" onchange="applyAutoInterval()">
            <option value="0">OFF</option>
            <option value="3">3s</option>
            <option value="5">5s</option>
            <option value="10" selected>10s</option>
            <option value="20">20s</option>
            <option value="30">30s</option>
          </select>
          <button onclick="applyAutoInterval()">‚úÖ Apply</button>
        </div>

        <div class="divider"></div>

        <div class="small">
          Admin URL: <span class="mono">/admin.html</span>
        </div>
      </div>

    </div>
  </div>

<script>
  let GEO = null;
  let lastData = null;
  let autoTimer = null;
  let autoOn = false;

  function $(id){ return document.getElementById(id); }
  function esc(s){ return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function key(){ return ($("adminKey").value || "").trim(); }

  function setMsg(type, text){
    const cls = type === "ok" ? "ok" : (type === "warn" ? "warn" : "bad");
    $("msg").innerHTML = `<span class="${cls}">${type.toUpperCase()}:</span> ${esc(text)}`;
  }

  async function api(url, opts={}){
    const headers = Object.assign({}, opts.headers || {}, {
      "Content-Type": "application/json",
      "X-Admin-Key": key()
    });
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=>({ ok:false, error:"JSON parse error" }));
    if (!res.ok) throw new Error(data?.error || ("HTTP " + res.status));
    return data;
  }

  // -------- GEO helpers (moslashuvchan) --------
  function getRegions(){ return GEO?.regions || GEO?.viloyatlar || []; }
  function getDistricts(){ return GEO?.districts || GEO?.tumanlar || GEO?.units || []; }

  function regionName(r){ return r.name_uz || r.nameUz || r.name || r.title || String(r.id); }
  function districtName(d){ return d.name_uz || d.nameUz || d.name || d.title || String(d.id); }
  function orgName(o){ return o.name_uz || o.nameUz || o.name || o.title || String(o.id); }

  function districtRegionId(d){
    return d.region_id ?? d.regionId ?? d.parent_id ?? d.parentId ?? d.region ?? null;
  }

  function getOrgsByUnitId(unitId){
    // asosiy mapping (senda bor)
    if (GEO?.orgsByUnitId) return GEO.orgsByUnitId[String(unitId)] || [];

    // fallback mapping (eski validateOrgId shu bilan ishlaydi)
    if (GEO?.orgsByUnitUzKey){
      const m = GEO.orgsByUnitUzKey;
      for (const k of Object.keys(m)){
        if (k.includes(String(unitId))) return m[k] || [];
      }
    }
    return [];
  }

  function selectedRegionId(){ return ($("selRegion").value || "").trim(); }
  function selectedDistrictId(){ return ($("selDistrict").value || "").trim(); }
  function selectedOrgId(){ return ($("selOrg").value || "").trim(); }

  async function init(){
    try{
      const r = await fetch("/api/geo");
      GEO = await r.json();
      fillRegions();
      setMsg("warn","Viloyat ‚Üí Tuman ‚Üí Muassasa tanlang, ADMIN_KEY kiriting.");
    }catch(e){
      setMsg("bad","/api/geo yuklanmadi: " + e.message);
    }
  }

  function fillRegions(){
    const sel = $("selRegion");
    sel.innerHTML = `<option value="">Viloyat tanlang...</option>`;
    for (const r of getRegions()){
      sel.innerHTML += `<option value="${esc(r.id)}">${esc(regionName(r))}</option>`;
    }
    $("selDistrict").innerHTML = `<option value="">Tuman tanlang...</option>`;
    $("selOrg").innerHTML = `<option value="">Muassasa tanlang...</option>`;
    $("orgToolbar").style.display = "none";
  }

  function onRegionChange(){
    const rid = selectedRegionId();
    const selD = $("selDistrict");
    selD.innerHTML = `<option value="">Tuman tanlang...</option>`;
    $("selOrg").innerHTML = `<option value="">Muassasa tanlang...</option>`;
    $("orgToolbar").style.display = "none";
    clearTable();

    if (!rid) return;

    const dlist = getDistricts().filter(d => String(districtRegionId(d)) === String(rid));
    for (const d of dlist){
      selD.innerHTML += `<option value="${esc(d.id)}">${esc(districtName(d))}</option>`;
    }
  }

  function onDistrictChange(){
    const did = selectedDistrictId();
    const selO = $("selOrg");
    selO.innerHTML = `<option value="">Muassasa tanlang...</option>`;
    $("orgToolbar").style.display = "none";
    clearTable();

    if (!did) return;

    // unitId = district id (senda Chinaz=160 kabi)
    const orgs = getOrgsByUnitId(did);
    for (const o of orgs){
      selO.innerHTML += `<option value="${esc(o.id)}">${esc(orgName(o))}</option>`;
    }
  }

  function onOrgChange(){
    const oid = selectedOrgId();
    $("orgToolbar").style.display = oid ? "flex" : "none";
    loadQueue();
  }

  function clearTable(){
    $("tbody").innerHTML = `<tr><td colspan="6" class="small">Muassasa tanlang...</td></tr>`;
    $("kNow").textContent="‚Äî"; $("kLast").textContent="‚Äî"; $("kAvg").textContent="‚Äî"; $("kCnt").textContent="‚Äî";
    lastData = null;
  }

  function updateKPIs(data){
    $("kNow").textContent  = data?.nowServing ?? "‚Äî";
    $("kLast").textContent = data?.lastNumber ?? "‚Äî";
    $("kAvg").textContent  = (data?.avgServiceSec ? (Math.round(data.avgServiceSec/60) + " min") : "‚Äî");
    $("kCnt").textContent  = (data?.tickets?.length ?? 0);
  }

  function statusPill(s){
    if (s === "waiting") return `<span class="pill ok">waiting</span>`;
    if (s === "missed") return `<span class="pill warn">missed</span>`;
    return `<span class="pill">${esc(s)}</span>`;
  }

  function etaText(t, nowServing, avgServiceSec){
    const num = Number(t.number || 0);
    if (!avgServiceSec) return "‚Äî";
    const remaining = Math.max(0, num - Number(nowServing || 0));
    const minutes = Math.max(0, Math.round((remaining * avgServiceSec) / 60));
    return minutes + " min";
  }

  function createdText(t){
    try{ return t.createdAt ? new Date(t.createdAt).toLocaleString() : ""; }
    catch{ return t.createdAt || ""; }
  }

  function renderTable(){
    const tb = $("tbody");
    const q = ($("search").value || "").trim().toLowerCase();
    const sf = $("statusFilter").value;

    const nowServing = lastData?.nowServing ?? 0;
    const avg = lastData?.avgServiceSec ?? null;

    const list = (lastData?.tickets || []).filter(t => {
      if (sf !== "all" && (t.status !== sf)) return false;
      if (!q) return true;
      const num = (t.number ?? "").toString();
      const name = (t.fullName || "").toLowerCase();
      const st = (t.status || "").toLowerCase();
      return num.includes(q.replace("#","")) || name.includes(q) || st.includes(q);
    });

    if (!list.length){
      tb.innerHTML = `<tr><td colspan="6" class="small">Aktiv navbat topilmadi.</td></tr>`;
      return;
    }

    tb.innerHTML = list.map(t => {
      const eta = etaText(t, nowServing, avg);
      const ct = createdText(t);
      return `
        <tr>
          <td><span class="pill">#${esc(t.number)}</span></td>
          <td>${esc(t.fullName || "")}</td>
          <td><b>${esc(eta)}</b></td>
          <td class="small">${esc(ct)}</td>
          <td>${statusPill(t.status)}</td>
          <td>
            <button class="btnMini danger" onclick="deleteTicket('${esc(t.id)}')">Delete</button>
            <button class="btnMini warn" onclick="skipTicket('${esc(t.id)}')">Skip</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  async function loadQueue(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");

    $("btnRefresh").disabled = true;
    try{
      const data = await api(`/api/admin/queue?orgId=${encodeURIComponent(orgId)}`, { method:"GET" });
      lastData = data;
      updateKPIs(data);
      renderTable();
      setMsg("ok", `Yangilandi. Aktiv navbat: ${(data.tickets||[]).length}`);
    }catch(e){
      setMsg("bad", e.message);
    }finally{
      $("btnRefresh").disabled = false;
    }
  }

  // --- Actions ---
  async function nextOne(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("NEXT qilamizmi? (navbat oldinga suriladi)")) return;

    try{
      await api(`/api/admin/next`, { method:"POST", body: JSON.stringify({ orgId }) });
      setMsg("ok","NEXT OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function deleteTicket(ticketId){
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("Ticket CANCEL (delete) qilinsinmi?")) return;

    try{
      await api(`/api/admin/delete`, { method:"POST", body: JSON.stringify({ ticketId }) });
      setMsg("ok","Delete OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function skipTicket(ticketId){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("O‚Äòtkazib yuboramizmi? (missed)")) return;

    try{
      await api(`/api/admin/skip`, { method:"POST", body: JSON.stringify({ orgId, ticketId }) });
      setMsg("ok","Skip OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function deleteAll(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("HAMMASI (waiting/missed) CANCEL bo‚Äòlsinmi?")) return;

    try{
      const r = await api(`/api/admin/deleteAll`, { method:"POST", body: JSON.stringify({ orgId }) });
      setMsg("ok", `DeleteAll OK. cancelledCount: ${r.cancelledCount ?? 0}`);
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  async function resetOrg(){
    const orgId = selectedOrgId();
    if (!orgId) return setMsg("warn","Muassasa tanlang");
    if (!key()) return setMsg("bad","ADMIN_KEY kiriting");
    if (!confirm("RESET xavfli: current=0 next=1 va waiting/missed CANCEL. Davom etamizmi?")) return;

    try{
      await api(`/api/admin/reset`, { method:"POST", body: JSON.stringify({ orgId }) });
      setMsg("warn","RESET OK");
      await loadQueue();
    }catch(e){
      setMsg("bad", e.message);
    }
  }

  // --- Auto refresh ---
  function toggleAuto(){
    autoOn = !autoOn;
    if (autoOn) applyAutoInterval(true);
    else stopAuto();
  }
  function stopAuto(){
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
    autoOn = false;
    $("btnAuto").textContent = "‚è± Auto: OFF";
  }
  function applyAutoInterval(forceOn=false){
    const sec = Number(($("autoEvery").value || 0));
    if (!sec || sec <= 0) { stopAuto(); return; }
    if (forceOn) autoOn = true;
    if (!autoOn) autoOn = true;

    if (autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(() => loadQueue(), sec * 1000);
    $("btnAuto").textContent = `‚è± Auto: ON (${sec}s)`;
    loadQueue();
  }

  // right panel select (hidden) ‚Äì keep compatibility
  // (we keep autoEvery default without UI clutter)
  (function ensureAutoSelect(){
    if (!$("autoEvery")){
      const s = document.createElement("select");
      s.id="autoEvery";
      s.style.display="none";
      s.innerHTML = `<option value="0">OFF</option><option value="10" selected>10s</option>`;
      document.body.appendChild(s);
    }
  })();

  init();
  clearTable();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ</title>
  <meta name="theme-color" content="#0b1020" />

  <style>
    :root{
      --bg0:#050712;
      --bg1:#070a18;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.70);
      --muted2: rgba(234,240,255,.52);
      --shadow: 0 30px 100px rgba(0,0,0,.60);
      --r: 22px;

      --a1: rgba(120,82,255,.95);
      --a2: rgba(0,199,255,.70);
      --a3: rgba(0,255,163,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(120,82,255,.30), transparent 55%),
        radial-gradient(900px 650px at 90% 30%, rgba(0,199,255,.20), transparent 55%),
        radial-gradient(900px 650px at 55% 95%, rgba(0,255,163,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .noise{
      pointer-events:none;
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.35;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 44px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:16px;}
    .logo{display:flex;align-items:center;gap:12px;user-select:none}
    .mark{
      width:42px;height:42px;border-radius:16px;
      background:
        radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, var(--a1), var(--a2));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(120,82,255,.18);
    }
    .brand{font-weight:900;letter-spacing:.7px;font-size:18px;line-height:1.1;}
    .tagline{font-size:12px;color:var(--muted2);margin-top:2px}

    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(0,255,163,.95);
      box-shadow: 0 0 0 6px rgba(0,255,163,.12);
    }

    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}

    .card{
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 260px at 18% 0%, rgba(120,82,255,.16), transparent 60%),
        radial-gradient(600px 240px at 90% 25%, rgba(0,199,255,.12), transparent 60%);
      pointer-events:none;
      z-index:0;
    }
    .card-inner{position:relative;z-index:1;padding:20px 18px;}

    .hero-title{font-size:34px;letter-spacing:.2px;margin:6px 0 8px;line-height:1.08;}
    .hero-sub{margin:0 0 14px;color:var(--muted);line-height:1.5;font-size:14px;max-width:62ch;}

    .panel{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(9,12,24,.50);
      padding:14px 14px;
    }

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .label{font-size:12px;color:var(--muted2);display:flex;gap:8px;align-items:center;}
    .label .icon{opacity:.9}

    .select{
      width:100%;
      appearance:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
      transition: .12s ease;
    }
    .select:focus{
      border-color: rgba(0,199,255,.35);
      box-shadow: 0 0 0 4px rgba(0,199,255,.12);
    }
    option{background:#0b1020;color:#eaf0ff;}

    .hint{font-size:12px;color:var(--muted2);margin-top:8px;line-height:1.5}
    .hr{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);margin:12px 0;}

    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      padding:13px 14px;
      border-radius:16px;
      color:#081022;
      font-weight:850;
      letter-spacing:.2px;
      background: linear-gradient(135deg, rgba(120,82,255,.95), rgba(0,199,255,.72), rgba(0,255,163,.40));
      box-shadow: 0 18px 50px rgba(0,199,255,.14);
      transition: transform .10s ease;
      margin-top:12px;
    }
    .btn:active{transform:scale(.99)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .side .mini{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:14px;margin-bottom:12px;
    }
    .mini h3{margin:0 0 8px;font-size:13px;letter-spacing:.2px;color:rgba(234,240,255,.88);}
    .mini p{margin:0;font-size:12px;color:var(--muted2);line-height:1.5;}
    .footer{margin-top:14px;color:rgba(234,240,255,.45);font-size:11px;text-align:center;}
    .badge{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.78);
      white-space:nowrap;
    }
    .stack{display:flex;flex-direction:column;gap:10px;}
    .toast{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      font-size:12px;
      color: rgba(234,240,255,.85);
    }
    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="noise"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <div class="mark"></div>
        <div>
          <div class="brand">NAVBATUZ</div>
          <div class="tagline">Queue management system</div>
        </div>
      </div>
      <div class="pill"><div class="dot"></div><div id="statusText">Online ‚Ä¢ Ready</div></div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-inner">
          <div class="hero-title" id="heroTitle">NAVBATUZ</div>
          <p class="hero-sub" id="heroSub">‚Äî</p>

          <div class="panel">
            <div class="stack">

              <!-- LANGUAGE (SCROLL SELECT) -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üåê</span><span id="lblLang">Til</span></div>
                  <span class="badge" id="bLang">Now</span>
                </div>
                <select id="langSel" class="select">
                  <option value="uz">O‚Äòzbek</option>
                  <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                  <option value="en">English</option>
                </select>
                <div class="hint" id="hintLang">Tilni ro‚Äòyxatdan tanlang (yozib kiritish yo‚Äòq).</div>
              </div>

              <div class="hr"></div>

              <!-- REGION -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üìç</span><span id="lblRegion">Viloyat</span></div>
                  <span class="badge" id="bRegion">Next</span>
                </div>
                <select id="regionSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintRegion">Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.</div>
              </div>

              <!-- UNIT -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üèô</span><span id="lblUnit">Tuman/Shahar</span></div>
                  <span class="badge" id="bUnit">Next</span>
                </div>
                <select id="unitSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintUnit">Viloyatni tanlasangiz, shu viloyatga tegishli tuman/shaharlar chiqadi.</div>
              </div>

              <!-- ORG -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üèõ</span><span id="lblOrg">Muassasa</span></div>
                  <span class="badge" id="bOrg">Next</span>
                </div>
                <select id="orgSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintOrg">Hozircha test uchun faqat Chinoz tumani (Toshkent viloyati) muassasalari bor.</div>
              </div>

              <button id="saveBtn" class="btn" disabled>‚úÖ Tanlovni saqlash</button>
              <div id="toast" class="toast hidden"></div>

            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-inner side">
          <div class="mini">
            <h3 id="howTitle">‚ö° Qanday ishlaydi?</h3>
            <p id="howText">Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa</p>
          </div>

          <div class="mini">
            <h3>üîí Xavfsiz</h3>
            <p id="safeText">Tanlov localStorage‚Äôda saqlanadi. Serverga faqat kerakli ma‚Äôlumot yuboriladi.</p>
          </div>

          <div class="mini">
            <h3>üì≤ Telegram bot</h3>
            <p id="botText">Telegram bot orqali ham navbat olishingiz mumkin (tezkor va qulay).</p>
          </div>

          <div class="footer">¬© NAVBATUZ ‚Ä¢ Render + PostgreSQL ‚Ä¢ Web + Telegram</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== UI TEXTS (100% label tarjima) ======
    const UI = {
      uz: {
        heroTitle: "Navbatni tez va oson oling.",
        heroSub: "Tilni tanlang, keyin viloyat ‚Üí tuman/shahar ‚Üí muassasani ro‚Äòyxatdan (scroll/select) tanlang.",
        status: "Online ‚Ä¢ Ready",
        lblLang: "Til",
        lblRegion: "Viloyat",
        lblUnit: "Tuman/Shahar",
        lblOrg: "Muassasa",
        hintLang: "Tilni ro‚Äòyxatdan tanlang (yozib kiritish yo‚Äòq).",
        hintRegion: "Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.",
        hintUnit: "Viloyatni tanlasangiz, shu viloyatga tegishli tuman/shaharlar chiqadi.",
        hintOrg: "Hozircha test uchun faqat Chinoz tumani (Toshkent viloyati) muassasalari bor.",
        save: "‚úÖ Tanlovni saqlash",
        howTitle: "‚ö° Qanday ishlaydi?",
        howText: "Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa",
        safe: "Tanlov localStorage‚Äôda saqlanadi. Serverga faqat kerakli ma‚Äôlumot yuboriladi.",
        bot: "Telegram bot orqali ham navbat olishingiz mumkin (tezkor va qulay).",
        saved: "‚úÖ Saqlandi!",
        notFoundOrg: "Hozircha bu tuman/shahar uchun muassasa yo‚Äòq."
      },
      ru: {
        heroTitle: "–ü–æ–ª—É—á–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ.",
        heroSub: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫, –∑–∞—Ç–µ–º –æ–±–ª–∞—Å—Ç—å ‚Üí —Ä–∞–π–æ–Ω/–≥–æ—Ä–æ–¥ ‚Üí —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ (–≤—Å—ë —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫/scroll).",
        status: "Online ‚Ä¢ Ready",
        lblLang: "–Ø–∑—ã–∫",
        lblRegion: "–û–±–ª–∞—Å—Ç—å",
        lblUnit: "–†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥",
        lblOrg: "–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ",
        hintLang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ (–±–µ–∑ –≤–≤–æ–¥–∞).",
        hintRegion: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ ‚Äî –∑–∞—Ç–µ–º –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π.",
        hintUnit: "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏ –ø–æ—è–≤—è—Ç—Å—è —Ä–∞–π–æ–Ω—ã/–≥–æ—Ä–æ–¥–∞ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏.",
        hintOrg: "–ü–æ–∫–∞ —Ç–µ—Å—Ç: —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ß–∏–Ω–∞–∑—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ (–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å).",
        save: "‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä",
        howTitle: "‚ö° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
        howText: "–Ø–∑—ã–∫ ‚Üí –û–±–ª–∞—Å—Ç—å ‚Üí –†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥ ‚Üí –£—á—Ä–µ–∂–¥–µ–Ω–∏–µ",
        safe: "–í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage. –ù–∞ —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.",
        bot: "–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç (–±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ).",
        saved: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
        notFoundOrg: "–ü–æ–∫–∞ –Ω–µ—Ç —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞/–≥–æ—Ä–æ–¥–∞."
      },
      en: {
        heroTitle: "Get your queue fast and easily.",
        heroSub: "Pick language first, then choose region ‚Üí district/city ‚Üí organization (all via scroll/select).",
        status: "Online ‚Ä¢ Ready",
        lblLang: "Language",
        lblRegion: "Region",
        lblUnit: "District/City",
        lblOrg: "Organization",
        hintLang: "Select language from the list (no typing).",
        hintRegion: "Choose language first, then regions will appear.",
        hintUnit: "After selecting a region, its districts/cities will appear.",
        hintOrg: "Test only: organizations exist only for Chinaz district (Tashkent region) for now.",
        save: "‚úÖ Save selection",
        howTitle: "‚ö° How it works?",
        howText: "Language ‚Üí Region ‚Üí District/City ‚Üí Organization",
        safe: "Selection is stored in localStorage. Only required data is sent to the server.",
        bot: "You can also take a ticket via Telegram bot (fast and convenient).",
        saved: "‚úÖ Saved!",
        notFoundOrg: "No organizations for this district/city yet."
      }
    };

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);
    const normKey = (s) => (s || "").toString().trim();

    function setOptions(sel, items, placeholder="‚Äî") {
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      sel.appendChild(opt0);

      for (const it of items) {
        const o = document.createElement("option");
        o.value = it.value;
        o.textContent = it.label;
        sel.appendChild(o);
      }
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.add("hidden"), 2200);
    }

    // ====== STATE ======
    let CFG = null;
    let regions = [];
    let unitsByRegionId = new Map(); // regionId -> units[]
    let orgsByUzKey = {};

    const state = {
      lang: localStorage.getItem("lang") || "uz",
      regionId: localStorage.getItem("regionId") || "",
      unitId: localStorage.getItem("unitId") || "",
      orgId: localStorage.getItem("orgId") || ""
    };

    // ====== DATA LOADING ======
    async function loadJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch failed: " + url);
      return await r.json();
    }

    function toUnit(obj, kind){
      // dataset fieldlar (taxminan): id, region_id, name_uz, name_oz, name_ru
      const id = obj.id ?? obj.soato_id ?? obj.soatoId ?? obj.code ?? (obj.name_uz || obj.name_ru || Math.random().toString(16).slice(2));
      return {
        id: String(id),
        region_id: String(obj.region_id ?? obj.regionId ?? obj.parent_id ?? obj.parentId ?? obj.region ?? ""),
        kind,
        name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
        name_ru: obj.name_ru ?? obj.nameRu ?? "",
        name_oz: obj.name_oz ?? obj.nameOz ?? "" // kirill
      };
    }

    function toRegion(obj){
      return {
        id: String(obj.id ?? obj.soato_id ?? obj.soatoId ?? obj.code),
        name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
        name_ru: obj.name_ru ?? obj.nameRu ?? "",
        name_oz: obj.name_oz ?? obj.nameOz ?? ""
      };
    }

    function labelByLang(obj, lang){
      // en: name_uz ni ishlatamiz (100% to‚Äòliq EN tarjima datasetda yo‚Äòq)
      if (lang === "ru") return obj.name_ru || obj.name_uz;
      if (lang === "en") return obj.name_uz || obj.name_ru;
      return obj.name_uz || obj.name_ru;
    }

    async function loadAllData(){
      CFG = await loadJSON("/geo.json");
      orgsByUzKey = CFG.orgsByUnitUzKey || {};

      // regions
      regions = (await loadJSON(CFG.sources.regions)).map(toRegion);

      // districts (katta)
      const districtsRaw = await loadJSON(CFG.sources.districts);
      const districts = (Array.isArray(districtsRaw) ? districtsRaw : []).map(x => toUnit(x, "district"));

      // cities (ba‚Äôzi repo‚Äôda juda katta bo‚Äòlishi mumkin; bo‚Äòlmasa skip)
      let cities = [];
      try {
        const citiesRaw = await loadJSON(CFG.sources.cities);
        cities = (Array.isArray(citiesRaw) ? citiesRaw : []).map(x => toUnit(x, "city"));
      } catch(e) {
        // cities.json bo‚Äòlmasa yoki juda katta bo‚Äòlsa ‚Äî districts ichida ham shaharlar aralash bo‚Äòlishi mumkin
        cities = [];
      }

      // group units by region
      unitsByRegionId = new Map();
      for (const u of [...districts, ...cities]) {
        if (!u.region_id) continue;
        if (!unitsByRegionId.has(u.region_id)) unitsByRegionId.set(u.region_id, []);
        unitsByRegionId.get(u.region_id).push(u);
      }

      // sort units
      for (const [rid, arr] of unitsByRegionId.entries()) {
        arr.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
      }
      regions.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
    }

    // ====== UI APPLY ======
    function applyLang(lang){
      const t = UI[lang] || UI.uz;

      $("heroTitle").textContent = t.heroTitle;
      $("heroSub").textContent = t.heroSub;
      $("statusText").textContent = t.status;

      $("lblLang").textContent = t.lblLang;
      $("lblRegion").textContent = t.lblRegion;
      $("lblUnit").textContent = t.lblUnit;
      $("lblOrg").textContent = t.lblOrg;

      $("hintLang").textContent = t.hintLang;
      $("hintRegion").textContent = t.hintRegion;
      $("hintUnit").textContent = t.hintUnit;
      $("hintOrg").textContent = t.hintOrg;

      $("saveBtn").textContent = t.save;
      $("howTitle").textContent = t.howTitle;
      $("howText").textContent = t.howText;
      $("safeText").textContent = t.safe;
      $("botText").textContent = t.bot;
    }

    function rebuildRegions(){
      const lang = state.lang;
      const items = regions.map(r => ({ value: r.id, label: labelByLang(r, lang) }));
      setOptions($("regionSel"), items, "‚Äî");
      $("regionSel").disabled = false;

      if (state.regionId) $("regionSel").value = state.regionId;
    }

    function rebuildUnits(){
      const lang = state.lang;
      const rid = state.regionId;
      const sel = $("unitSel");

      state.unitId = "";
      state.orgId = "";
      $("orgSel").disabled = true;
      setOptions($("orgSel"), [], "‚Äî");

      if (!rid) {
        sel.disabled = true;
        setOptions(sel, [], "‚Äî");
        return;
      }

      const units = unitsByRegionId.get(String(rid)) || [];

      const items = units.map(u => {
        // tuman/shahar labelini chiroyli chiqaramiz
        const base = labelByLang(u, lang);
        const prefix = (u.kind === "city")
          ? (lang==="uz" ? "Shahar: " : lang==="ru" ? "–ì–æ—Ä–æ–¥: " : "City: ")
          : (lang==="uz" ? "Tuman: " : lang==="ru" ? "–†–∞–π–æ–Ω: " : "District: ");
        return { value: u.id, label: prefix + base };
      });

      setOptions(sel, items, "‚Äî");
      sel.disabled = false;

      if (state.unitId) sel.value = state.unitId;
    }

    function rebuildOrgs(){
      const lang = state.lang;

      const rid = state.regionId;
      const uid = state.unitId;

      if (!rid || !uid) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        return;
      }

      // region & unit ni topamiz
      const region = regions.find(r => String(r.id) === String(rid));
      const units = unitsByRegionId.get(String(rid)) || [];
      const unit = units.find(u => String(u.id) === String(uid));

      if (!region || !unit) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        return;
      }

      // MUHIM: org key har doim UZ-lotin nom bilan bo‚Äòladi (til almashsa ham muammo bo‚Äòlmaydi)
      const uzKey = normKey(region.name_uz) + "|" + normKey(unit.name_uz);
      const orgs = orgsByUzKey[uzKey] || [];

      if (!orgs.length) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        toast((UI[lang]||UI.uz).notFoundOrg);
        return;
      }

      const items = orgs.map(o => ({
        value: o.id,
        label: (o.name && o.name[lang]) ? o.name[lang] : (o.name?.uz || o.id)
      }));

      setOptions($("orgSel"), items, "‚Äî");
      $("orgSel").disabled = false;

      if (state.orgId) $("orgSel").value = state.orgId;
    }

    function updateSaveBtn(){
      const ok = !!(state.lang && state.regionId && state.unitId && state.orgId);
      $("saveBtn").disabled = !ok;
    }

    // ====== EVENTS ======
    $("langSel").addEventListener("change", () => {
      state.lang = $("langSel").value;
      localStorage.setItem("lang", state.lang);
      applyLang(state.lang);

      // rebuild labels
      rebuildRegions();
      rebuildUnits();
      rebuildOrgs();
      updateSaveBtn();
    });

    $("regionSel").addEventListener("change", () => {
      state.regionId = $("regionSel").value;
      localStorage.setItem("regionId", state.regionId);

      state.unitId = "";
      state.orgId = "";
      localStorage.removeItem("unitId");
      localStorage.removeItem("orgId");

      rebuildUnits();
      rebuildOrgs();
      updateSaveBtn();
    });

    $("unitSel").addEventListener("change", () => {
      state.unitId = $("unitSel").value;
      localStorage.setItem("unitId", state.unitId);

      state.orgId = "";
      localStorage.removeItem("orgId");

      rebuildOrgs();
      updateSaveBtn();
    });

    $("orgSel").addEventListener("change", () => {
      state.orgId = $("orgSel").value;
      localStorage.setItem("orgId", state.orgId);
      updateSaveBtn();
    });

    $("saveBtn").addEventListener("click", async () => {
      const lang = state.lang;
      localStorage.setItem("navbatuz_selection", JSON.stringify(state));

      // xohlasang serverga ham yuboramiz (keyinchalik)
      // await fetch("/api/selection", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(state) })

      toast((UI[lang]||UI.uz).saved);
    });

    // ====== BOOT ======
    (async function boot(){
      try{
        $("langSel").value = state.lang;
        applyLang(state.lang);

        // yuklash
        await loadAllData();

        rebuildRegions();

        // restore previous selection
        if (state.regionId) $("regionSel").value = state.regionId;

        rebuildUnits();
        if (state.unitId) $("unitSel").value = state.unitId;

        rebuildOrgs();
        if (state.orgId) $("orgSel").value = state.orgId;

        updateSaveBtn();
      } catch(e){
        console.error(e);
        toast("Data yuklanmadi. geo.json yoki internet tekshir.");
      }
    })();
  </script>
</body>
</html>

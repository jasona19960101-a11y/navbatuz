<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg0:#050712; --bg1:#070a18;
      --stroke: rgba(255,255,255,.12);
      --text:#eaf0ff; --muted2: rgba(234,240,255,.52);
      --shadow: 0 30px 100px rgba(0,0,0,.60);
      --r: 22px;
      --a1: rgba(120,82,255,.95);
      --a2: rgba(0,199,255,.70);
      --a3: rgba(0,255,163,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(120,82,255,.30), transparent 55%),
        radial-gradient(900px 650px at 90% 30%, rgba(0,199,255,.20), transparent 55%),
        radial-gradient(900px 650px at 55% 95%, rgba(0,255,163,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .noise{pointer-events:none; position:fixed; inset:0; opacity:.35; mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 44px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:16px;}
    .logo{display:flex;align-items:center;gap:12px;user-select:none}
    .mark{
      width:42px;height:42px;border-radius:16px;
      background: radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
                  linear-gradient(135deg, var(--a1), var(--a2));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(120,82,255,.18);
    }
    .brand{font-weight:900;letter-spacing:.7px;font-size:18px;line-height:1.1;}
    .tagline{font-size:12px;color:var(--muted2);margin-top:2px}
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      font-size:12px;
      color: rgba(234,240,255,.70);
    }
    .dot{width:8px;height:8px;border-radius:50%; background: rgba(0,255,163,.95); box-shadow: 0 0 0 6px rgba(0,255,163,.12);}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 260px at 18% 0%, rgba(120,82,255,.16), transparent 60%),
        radial-gradient(600px 240px at 90% 25%, rgba(0,199,255,.12), transparent 60%);
      pointer-events:none;
      z-index:0;
    }
    .card-inner{position:relative;z-index:1;padding:20px 18px;}
    .hero-title{font-size:34px;letter-spacing:.2px;margin:6px 0 8px;line-height:1.08;}
    .hero-sub{margin:0 0 14px;color:rgba(234,240,255,.70);line-height:1.5;font-size:14px;max-width:62ch;}
    .panel{margin-top:14px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background: rgba(9,12,24,.50);padding:14px;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .label{font-size:12px;color:rgba(234,240,255,.52);display:flex;gap:8px;align-items:center;}
    .select{
      width:100%;
      appearance:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    option{background:#0b1020;color:#eaf0ff;}
    .hint{font-size:12px;color:rgba(234,240,255,.52);margin-top:8px;line-height:1.5}
    .hr{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);margin:12px 0;}
    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      padding:13px 14px;
      border-radius:16px;
      color:#081022;
      font-weight:850;
      letter-spacing:.2px;
      background: linear-gradient(135deg, rgba(120,82,255,.95), rgba(0,199,255,.72), rgba(0,255,163,.40));
      box-shadow: 0 18px 50px rgba(0,199,255,.14);
      margin-top:12px;
    }
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .toast{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      font-size:12px;
      color: rgba(234,240,255,.85);
    }
    .hidden{display:none !important;}
    .ticketBox{border-radius:18px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);padding:14px;}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.05);color: rgba(234,240,255,.78);white-space:nowrap;}
    .ticketTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px;}
    .ticketNo{font-size:30px;font-weight:900;letter-spacing:.5px;line-height:1;}
    .ticketMeta{font-size:12px;color:rgba(234,240,255,.52);line-height:1.45;}
    .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .kpi{border-radius:14px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.16);padding:10px;}
    .kpi .k{font-size:11px;color:rgba(234,240,255,.52)}
    .kpi .v{font-size:14px;font-weight:800;margin-top:4px}
    .subActions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btn2{flex:1;min-width:170px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);color: var(--text);
      padding:12px;border-radius:16px;cursor:pointer;font-weight:800;}
    .warn{margin-top:10px;border-radius:14px;border:1px solid rgba(255,199,0,.22);background: rgba(255,199,0,.08);
      padding:10px 12px;color: rgba(255,240,210,.92);font-size:12px;line-height:1.5;}
    .side .mini{border-radius:18px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);padding:14px;margin-bottom:12px;}
    .mini h3{margin:0 0 8px;font-size:13px;color:rgba(234,240,255,.88);}
    .mini p{margin:0;font-size:12px;color:rgba(234,240,255,.52);line-height:1.5;}
    .footer{margin-top:14px;color:rgba(234,240,255,.45);font-size:11px;text-align:center;}
  </style>
</head>
<body>
  <div class="noise"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <div class="mark"></div>
        <div>
          <div class="brand">NAVBATUZ</div>
          <div class="tagline">Queue management system</div>
        </div>
      </div>
      <div class="pill"><div class="dot"></div><div id="statusText">Online ‚Ä¢ Ready</div></div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-inner">
          <div class="hero-title" id="heroTitle">NAVBATUZ</div>
          <p class="hero-sub" id="heroSub">‚Äî</p>

          <div class="panel">
            <div>

              <!-- LANGUAGE -->
              <div>
                <div class="row">
                  <div class="label"><span>üåê</span><span id="lblLang">Til</span></div>
                  <span class="badge" id="bLang">Now</span>
                </div>
                <select id="langSel" class="select">
                  <option value="uz">O‚Äòzbek</option>
                  <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                  <option value="en">English</option>
                </select>
                <div class="hint" id="hintLang">Tilni ro‚Äòyxatdan tanlang.</div>
              </div>

              <div class="hr"></div>

              <!-- REGION -->
              <div>
                <div class="row">
                  <div class="label"><span>üìç</span><span id="lblRegion">Viloyat</span></div>
                  <span class="badge" id="bRegion">Next</span>
                </div>
                <select id="regionSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintRegion">Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.</div>
              </div>

              <!-- UNIT -->
              <div>
                <div class="row">
                  <div class="label"><span>üèô</span><span id="lblUnit">Tuman/Shahar</span></div>
                  <span class="badge" id="bUnit">Next</span>
                </div>
                <select id="unitSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintUnit">Viloyatni tanlasangiz, tuman/shaharlar chiqadi.</div>
              </div>

              <!-- ORG -->
              <div>
                <div class="row">
                  <div class="label"><span>üèõ</span><span id="lblOrg">Muassasa</span></div>
                  <span class="badge" id="bOrg">Next</span>
                </div>
                <select id="orgSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintOrg">Hozircha test uchun Chinoz tumani muassasalari bor.</div>
              </div>

              <!-- FULL NAME -->
              <div style="margin-top:12px;">
                <div class="row">
                  <div class="label"><span>üë§</span><span id="lblFullName">Ism familiya</span></div>
                  <span class="badge" id="bName">Required</span>
                </div>
                <input id="fullNameInp" class="select" placeholder="Masalan: Ali Valiyev" />
                <div class="hint" id="hintName">Navbat olishdan oldin ism familiyangizni kiriting.</div>
              </div>

              <button id="saveBtn" class="btn" disabled>‚úÖ Tanlovni saqlash</button>
              <div id="toast" class="toast hidden"></div>

              <div class="hr"></div>

              <!-- TICKET -->
              <div class="ticketBox">
                <div class="row" style="margin-bottom:8px;">
                  <div class="label"><span>üé´</span><span id="lblTicket">Navbat</span></div>
                  <span class="badge" id="ticketState">‚Äî</span>
                </div>

                <button id="takeBtn" class="btn" disabled>üéü Navbat olish</button>

                <div id="ticketInfo" class="hidden" style="margin-top:12px;">
                  <div class="ticketTop">
                    <div>
                      <div class="ticketNo" id="ticketNo">‚Äî</div>
                      <div class="ticketMeta" id="ticketMeta">‚Äî</div>
                    </div>
                    <div style="text-align:right;">
                      <div class="badge" id="nowServingBadge">Now: ‚Äî</div>
                      <div class="ticketMeta" style="margin-top:8px;" id="etaText">ETA: ‚Äî</div>
                      <div class="ticketMeta" style="margin-top:4px;" id="countdownText">Countdown: ‚Äî</div>
                    </div>
                  </div>

                  <div class="kpiGrid">
                    <div class="kpi"><div class="k" id="kpiAheadLbl">Oldinda</div><div class="v" id="aheadKpi">‚Äî</div></div>
                    <div class="kpi"><div class="k" id="kpiBehindLbl">Keyinda</div><div class="v" id="behindKpi">‚Äî</div></div>
                    <div class="kpi"><div class="k" id="kpiAvgLbl">O‚Äòrtacha</div><div class="v" id="avgKpi">‚Äî</div></div>
                    <div class="kpi"><div class="k" id="kpiStatusLbl">Holat</div><div class="v" id="statusKpi">‚Äî</div></div>
                  </div>

                  <div id="warnBox" class="warn hidden"></div>

                  <div class="subActions">
                    <button id="refreshBtn" class="btn2">üîÑ Yangilash</button>
                    <button id="cancelBtn" class="btn2">üóë Bekor</button>
                    <button id="servedBtn" class="btn2">‚úÖ Xizmat ko‚Äòrsatildi</button>
                    <button id="openTicketBtn" class="btn2">üßæ Chek (ticket)</button>
                  </div>
                </div>
              </div>
              <!-- /TICKET -->
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-inner side">
          <div class="mini">
            <h3 id="howTitle">‚ö° Qanday ishlaydi?</h3>
            <p id="howText">Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa</p>
          </div>
          <div class="mini">
            <h3 id="notifTitle">üîî Bildirishnoma</h3>
            <p id="notifText">Navbatingiz 10 ta qolganda avtomatik xabar beradi (browser permission kerak).</p>
          </div>
          <div class="mini">
            <h3 id="botTitle">üì≤ Telegram bot</h3>
            <p id="botText">Telegram bot orqali ham navbat olishingiz mumkin.</p>
          </div>
          <div class="footer">¬© NAVBATUZ ‚Ä¢ Render + PostgreSQL ‚Ä¢ Web + Telegram</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = window.location.origin;
  const $ = (id) => document.getElementById(id);

  // ===== i18n =====
  const UI = {
    uz: {
      heroTitle: "Navbatni tez va oson oling.",
      heroSub: "Tilni tanlang, keyin viloyat ‚Üí tuman/shahar ‚Üí muassasani tanlang.",
      lblLang: "Til",
      lblRegion: "Viloyat",
      lblUnit: "Tuman/Shahar",
      lblOrg: "Muassasa",
      lblFullName: "Ism familiya",
      lblTicket: "Navbat",
      hintLang: "Tilni ro‚Äòyxatdan tanlang.",
      hintRegion: "Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.",
      hintUnit: "Viloyatni tanlasangiz, tuman/shaharlar chiqadi.",
      hintOrg: "Hozircha test uchun Chinoz tumani muassasalari bor.",
      hintName: "Navbat olishdan oldin ism familiyangizni kiriting.",
      needName: "Ism familiya kiriting.",
      saved: "‚úÖ Saqlandi!",
      taken: "‚úÖ Navbat olindi!",
      cancelled: "üóë Navbat bekor qilindi.",
      servedOk: "‚úÖ Served qilindi (o‚Äòrtacha vaqt hisoblanadi).",
      apiFail: "Server bilan aloqa yo‚Äòq. Keyinroq urinib ko‚Äòring.",
      online: "Online ‚Ä¢ Ready",
      offline: "Offline ‚Ä¢ Aloqa yo‚Äòq",
      notFoundOrg: "Hozircha bu tuman/shahar uchun muassasa yo‚Äòq.",
      served: "üéâ Navbatingiz keldi!",
      missed: "‚ö†Ô∏è Navbatingiz o‚Äòtib ketgan. 5 ta ichida saqlanadi.",
      autoCancelled: "‚õî 5 tadan o‚Äòtib ketdi. Avtomat bekor qilindi.",
      btnSave: "‚úÖ Tanlovni saqlash",
      btnTake: "üéü Navbat olish",
      btnRefresh: "üîÑ Yangilash",
      btnCancel: "üóë Bekor",
      btnServed: "‚úÖ Xizmat ko‚Äòrsatildi",
      btnOpen: "üßæ Chek (ticket)",
      now: "Now",
      eta: "ETA",
      countdown: "Countdown",
      kpiAhead: "Oldinda",
      kpiBehind: "Keyinda",
      kpiAvg: "O‚Äòrtacha",
      kpiStatus: "Holat",
      howTitle: "‚ö° Qanday ishlaydi?",
      howText: "Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa",
      notifTitle: "üîî Bildirishnoma",
      notifText: "Navbatingiz 10 ta qolganda avtomatik xabar beradi (browser permission kerak).",
      botTitle: "üì≤ Telegram bot",
      botText: "Telegram bot orqali ham navbat olishingiz mumkin.",
      statusWaiting: "Kutilmoqda",
      statusNow: "Navbat sizniki",
      statusGrace: "O‚Äòtib ketdi (grace)",
      statusCancelled: "Bekor qilingan",
    },
    ru: {
      heroTitle: "–ü–æ–ª—É—á–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ.",
      heroSub: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫, –∑–∞—Ç–µ–º –æ–±–ª–∞—Å—Ç—å ‚Üí —Ä–∞–π–æ–Ω/–≥–æ—Ä–æ–¥ ‚Üí —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ.",
      lblLang: "–Ø–∑—ã–∫",
      lblRegion: "–û–±–ª–∞—Å—Ç—å",
      lblUnit: "–†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥",
      lblOrg: "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
      lblFullName: "–ò–º—è –§–∞–º–∏–ª–∏—è",
      lblTicket: "–¢–∞–ª–æ–Ω",
      hintLang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–∑ —Å–ø–∏—Å–∫–∞.",
      hintRegion: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ ‚Äî –∑–∞—Ç–µ–º –ø–æ—è–≤—è—Ç—Å—è –æ–±–ª–∞—Å—Ç–∏.",
      hintUnit: "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏ –ø–æ—è–≤—è—Ç—Å—è —Ä–∞–π–æ–Ω—ã/–≥–æ—Ä–æ–¥–∞.",
      hintOrg: "–ü–æ–∫–∞ —Ç–µ—Å—Ç: –ß–∏–Ω–∞–∑—Å–∫–∏–π —Ä–∞–π–æ–Ω.",
      hintName: "–ü–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ç–∞–ª–æ–Ω–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é.",
      needName: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é.",
      saved: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
      taken: "‚úÖ –¢–∞–ª–æ–Ω –ø–æ–ª—É—á–µ–Ω!",
      cancelled: "üóë –¢–∞–ª–æ–Ω –æ—Ç–º–µ–Ω—ë–Ω.",
      servedOk: "‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ–±—Å–ª—É–∂–µ–Ω–æ.",
      apiFail: "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
      online: "Online ‚Ä¢ Ready",
      offline: "Offline ‚Ä¢ –ù–µ—Ç —Å–≤—è–∑–∏",
      notFoundOrg: "–ü–æ–∫–∞ –Ω–µ—Ç —É—á—Ä–µ–∂–¥–µ–Ω–∏–π.",
      served: "üéâ –í–∞—à–∞ –æ—á–µ—Ä–µ–¥—å –ø–æ–¥–æ—à–ª–∞!",
      missed: "‚ö†Ô∏è –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏. –î–µ—Ä–∂–∏–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5.",
      autoCancelled: "‚õî –ü—Ä–æ—à–ª–æ +5. –ê–≤—Ç–æ-–æ—Ç–º–µ–Ω–∞.",
      btnSave: "‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä",
      btnTake: "üéü –ü–æ–ª—É—á–∏—Ç—å —Ç–∞–ª–æ–Ω",
      btnRefresh: "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
      btnCancel: "üóë –û—Ç–º–µ–Ω–∏—Ç—å",
      btnServed: "‚úÖ –û–±—Å–ª—É–∂–µ–Ω–æ",
      btnOpen: "üßæ –û—Ç–∫—Ä—ã—Ç—å —Ç–∞–ª–æ–Ω",
      now: "Now",
      eta: "ETA",
      countdown: "Countdown",
      kpiAhead: "–ü–µ—Ä–µ–¥ –≤–∞–º–∏",
      kpiBehind: "–ü–æ—Å–ª–µ –≤–∞—Å",
      kpiAvg: "–°—Ä–µ–¥–Ω–µ–µ",
      kpiStatus: "–°—Ç–∞—Ç—É—Å",
      howTitle: "‚ö° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
      howText: "–Ø–∑—ã–∫ ‚Üí –û–±–ª–∞—Å—Ç—å ‚Üí –†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥ ‚Üí –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
      notifTitle: "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
      notifText: "–ö–æ–≥–¥–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 10 ‚Äî –ø–æ–∫–∞–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞).",
      botTitle: "üì≤ Telegram –±–æ—Ç",
      botText: "–ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç.",
      statusWaiting: "–û–∂–∏–¥–∞–Ω–∏–µ",
      statusNow: "–í–∞—à —á–µ—Ä—ë–¥",
      statusGrace: "–ü—Ä–æ–ø—É—â–µ–Ω (grace)",
      statusCancelled: "–û—Ç–º–µ–Ω—ë–Ω",
    },
    en: {
      heroTitle: "Get your queue fast and easily.",
      heroSub: "Pick language, then region ‚Üí district/city ‚Üí organization.",
      lblLang: "Language",
      lblRegion: "Region",
      lblUnit: "District/City",
      lblOrg: "Organization",
      lblFullName: "Full name",
      lblTicket: "Ticket",
      hintLang: "Select language.",
      hintRegion: "Choose language first, then regions appear.",
      hintUnit: "After selecting region, units appear.",
      hintOrg: "Test only for now.",
      hintName: "Enter your full name before taking a ticket.",
      needName: "Enter full name.",
      saved: "‚úÖ Saved!",
      taken: "‚úÖ Ticket taken!",
      cancelled: "üóë Ticket cancelled.",
      servedOk: "‚úÖ Marked as served.",
      apiFail: "Cannot reach server. Try later.",
      online: "Online ‚Ä¢ Ready",
      offline: "Offline ‚Ä¢ No connection",
      notFoundOrg: "No orgs for this unit.",
      served: "üéâ It‚Äôs your turn!",
      missed: "‚ö†Ô∏è Missed. Grace within next 5.",
      autoCancelled: "‚õî Passed +5. Auto-cancelled.",
      btnSave: "‚úÖ Save selection",
      btnTake: "üéü Take ticket",
      btnRefresh: "üîÑ Refresh",
      btnCancel: "üóë Cancel",
      btnServed: "‚úÖ Served",
      btnOpen: "üßæ Open ticket",
      now: "Now",
      eta: "ETA",
      countdown: "Countdown",
      kpiAhead: "Ahead",
      kpiBehind: "Behind",
      kpiAvg: "Average",
      kpiStatus: "Status",
      howTitle: "‚ö° How it works?",
      howText: "Language ‚Üí Region ‚Üí District/City ‚Üí Organization",
      notifTitle: "üîî Notifications",
      notifText: "When 10 left, it will notify (needs browser permission).",
      botTitle: "üì≤ Telegram bot",
      botText: "You can also take a ticket via Telegram bot.",
      statusWaiting: "Waiting",
      statusNow: "Your turn",
      statusGrace: "Missed (grace)",
      statusCancelled: "Cancelled",
    }
  };
  function getT(lang){ return UI[lang] || UI.uz; }

  // ===== helpers =====
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.add("hidden"), 2200);
  }

  function setOnlineBadge(isOnline){
    const t = getT(state.lang);
    $("statusText").textContent = isOnline ? t.online : t.offline;
  }

  function setOptions(sel, items, placeholder="‚Äî") {
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    sel.appendChild(opt0);
    for (const it of items) {
      const o = document.createElement("option");
      o.value = it.value;
      o.textContent = it.label;
      sel.appendChild(o);
    }
  }

  function labelByLang(obj, lang){
    if (lang === "ru") return obj.name_ru || obj.name_uz || "";
    if (lang === "en") return obj.name_uz || obj.name_ru || "";
    return obj.name_uz || obj.name_ru || "";
  }

  function fmtCountdown(ms){
    if (!Number.isFinite(ms) || ms <= 0) return "00:00:00";
    let s = Math.floor(ms / 1000);
    const hrs = Math.floor(s / 3600); s -= hrs*3600;
    const mins = Math.floor(s / 60); s -= mins*60;
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(hrs)}:${pad(mins)}:${pad(s)}`;
  }

  async function apiGet(path){
    const r = await fetch(API_BASE + path, { cache:"no-store" });
    if (!r.ok) throw new Error("API GET fail " + path);
    return await r.json();
  }
  async function apiPost(path, body){
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body),
      cache:"no-store"
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok) throw new Error(j?.error || ("API POST fail " + path));
    return j;
  }

  async function fetchJsonSmart(url){
    const tries = [];
    if (url) tries.push(url);
    if (url && url.includes("/master/")) tries.push(url.replace("/master/","/main/"));
    if (url && url.includes("/main/")) tries.push(url.replace("/main/","/master/"));
    if (url && url.includes("/JSON/")) tries.push(url.replace("/JSON/","/json/"));
    if (url && url.includes("/json/")) tries.push(url.replace("/json/","/JSON/"));
    const uniq = [...new Set(tries)].filter(Boolean);

    let lastErr = null;
    for (const u of uniq){
      try{
        const res = await fetch(u, { cache:"no-store" });
        if (!res.ok) { lastErr = new Error(`Fetch ${u} -> ${res.status}`); continue; }
        return await res.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("fetchJsonSmart failed");
  }

  // ===== Data state =====
  let CFG = null;
  let regions = [];
  let unitsByRegionId = new Map();
  let orgsByUzKey = {};

  const state = {
    lang: (localStorage.getItem("lang") || "uz").toLowerCase(),
    regionId: localStorage.getItem("regionId") || "",
    unitId: localStorage.getItem("unitId") || "",
    orgId: localStorage.getItem("orgId") || "",
    fullName: localStorage.getItem("fullName") || ""
  };

  // ===== Ticket state =====
  const TICKET_KEY = "navbatuz_ticket";
  let ticket = null;

  let pollTimer = null;
  let countdownTimer = null;
  let etaEndTs = null;

  // notification state
  let notified10 = false;

  function loadTicket(){
    try{
      const raw = localStorage.getItem(TICKET_KEY);
      ticket = raw ? JSON.parse(raw) : null;
    }catch{ ticket = null; }
  }
  function saveTicket(){
    if (!ticket) localStorage.removeItem(TICKET_KEY);
    else localStorage.setItem(TICKET_KEY, JSON.stringify(ticket));
  }

  function toUnit(obj, kind){
    const id = obj.id ?? obj.soato_id ?? obj.code ?? (obj.name_uz || obj.name_ru || Math.random().toString(16).slice(2));
    return {
      id: String(id),
      region_id: String(obj.region_id ?? obj.regionId ?? obj.parent_id ?? obj.parentId ?? ""),
      kind,
      name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
      name_ru: obj.name_ru ?? obj.nameRu ?? "",
    };
  }
  function toRegion(obj){
    return {
      id: String(obj.id ?? obj.soato_id ?? obj.code),
      name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
      name_ru: obj.name_ru ?? obj.nameRu ?? "",
    };
  }

  async function loadAllData(){
    CFG = await apiGet("/api/geo");
    orgsByUzKey = CFG.orgsByUnitUzKey || {};

    const regionsRaw = await fetchJsonSmart(CFG.sources?.regions);
    regions = (Array.isArray(regionsRaw) ? regionsRaw : []).map(toRegion);

    const districtsRaw = await fetchJsonSmart(CFG.sources?.districts);
    const districts = (Array.isArray(districtsRaw) ? districtsRaw : []).map(x => toUnit(x, "district"));

    let cities = [];
    try {
      const citiesRaw = await fetchJsonSmart(CFG.sources?.cities);
      cities = (Array.isArray(citiesRaw) ? citiesRaw : []).map(x => toUnit(x, "city"));
    } catch { cities = []; }

    unitsByRegionId = new Map();
    for (const u of [...districts, ...cities]) {
      if (!u.region_id) continue;
      if (!unitsByRegionId.has(u.region_id)) unitsByRegionId.set(u.region_id, []);
      unitsByRegionId.get(u.region_id).push(u);
    }
    for (const [rid, arr] of unitsByRegionId.entries()) {
      arr.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
    }
    regions.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
  }

  function applyLang(lang){
    const t = getT(lang);

    // titles/hints
    $("heroTitle").textContent = t.heroTitle;
    $("heroSub").textContent = t.heroSub;

    $("lblLang").textContent = t.lblLang;
    $("lblRegion").textContent = t.lblRegion;
    $("lblUnit").textContent = t.lblUnit;
    $("lblOrg").textContent = t.lblOrg;
    $("lblFullName").textContent = t.lblFullName;
    $("lblTicket").textContent = t.lblTicket;

    $("hintLang").textContent = t.hintLang;
    $("hintRegion").textContent = t.hintRegion;
    $("hintUnit").textContent = t.hintUnit;
    $("hintOrg").textContent = t.hintOrg;
    $("hintName").textContent = t.hintName;

    // side
    $("howTitle").textContent = t.howTitle;
    $("howText").textContent = t.howText;
    $("notifTitle").textContent = t.notifTitle;
    $("notifText").textContent = t.notifText;
    $("botTitle").textContent = t.botTitle;
    $("botText").textContent = t.botText;

    // buttons
    $("saveBtn").textContent = t.btnSave;
    $("takeBtn").textContent = t.btnTake;
    $("refreshBtn").textContent = t.btnRefresh;
    $("cancelBtn").textContent = t.btnCancel;
    $("servedBtn").textContent = t.btnServed;
    $("openTicketBtn").textContent = t.btnOpen;

    // kpi labels
    $("kpiAheadLbl").textContent = t.kpiAhead;
    $("kpiBehindLbl").textContent = t.kpiBehind;
    $("kpiAvgLbl").textContent = t.kpiAvg;
    $("kpiStatusLbl").textContent = t.kpiStatus;

    // placeholders
    $("fullNameInp").placeholder =
      (lang==="uz" ? "Masalan: Ali Valiyev" : lang==="ru" ? "–ù–∞–ø—Ä–∏–º–µ—Ä: Ali Valiyev" : "e.g. Ali Valiyev");

    // live ticket texts refresh
    if (ticket && ticket.status === "active") {
      fetchTicketStatus().catch(()=>{});
    }
  }

  function rebuildRegions(){
    const lang = state.lang;
    const items = regions.map(r => ({ value: r.id, label: labelByLang(r, lang) }));
    setOptions($("regionSel"), items, "‚Äî");
    $("regionSel").disabled = false;
    if (state.regionId) $("regionSel").value = state.regionId;
  }

  function rebuildUnits(){
    const lang = state.lang;
    const rid = state.regionId;
    const sel = $("unitSel");

    state.unitId = "";
    state.orgId = "";
    localStorage.setItem("unitId", "");
    localStorage.setItem("orgId", "");

    $("orgSel").disabled = true;
    setOptions($("orgSel"), [], "‚Äî");

    if (!rid) {
      sel.disabled = true;
      setOptions(sel, [], "‚Äî");
      return;
    }

    const units = unitsByRegionId.get(String(rid)) || [];
    const items = units.map(u => {
      const base = labelByLang(u, lang);
      const prefix = (u.kind === "city")
        ? (lang==="uz" ? "Shahar: " : lang==="ru" ? "–ì–æ—Ä–æ–¥: " : "City: ")
        : (lang==="uz" ? "Tuman: " : lang==="ru" ? "–†–∞–π–æ–Ω: " : "District: ");
      return { value: u.id, label: prefix + base };
    });

    setOptions(sel, items, "‚Äî");
    sel.disabled = false;
  }

  function rebuildOrgs(){
    const lang = state.lang;
    const rid = state.regionId;
    const uid = state.unitId;

    if (!rid || !uid) {
      $("orgSel").disabled = true;
      setOptions($("orgSel"), [], "‚Äî");
      return;
    }

    const region = regions.find(r => String(r.id) === String(rid));
    const units = unitsByRegionId.get(String(rid)) || [];
    const unit = units.find(u => String(u.id) === String(uid));

    if (!region || !unit) {
      $("orgSel").disabled = true;
      setOptions($("orgSel"), [], "‚Äî");
      return;
    }

    const uzKey = (region.name_uz || "").trim() + "|" + (unit.name_uz || "").trim();
    const orgs = orgsByUzKey[uzKey] || [];

    if (!orgs.length) {
      $("orgSel").disabled = true;
      setOptions($("orgSel"), [], "‚Äî");
      toast(getT(lang).notFoundOrg);
      return;
    }

    const items = orgs.map(o => ({
      value: o.id,
      label: (o.name && o.name[lang]) ? o.name[lang] : (o.name?.uz || o.id)
    }));

    setOptions($("orgSel"), items, "‚Äî");
    $("orgSel").disabled = false;
    if (state.orgId) $("orgSel").value = state.orgId;
  }

  function setTicketUIVisible(on){ $("ticketInfo").classList.toggle("hidden", !on); }
  function setWarn(msg){
    const w = $("warnBox");
    if (!msg) { w.classList.add("hidden"); w.textContent=""; return; }
    w.textContent = msg;
    w.classList.remove("hidden");
  }
  function setTicketStateBadge(txt){ $("ticketState").textContent = txt || "‚Äî"; }

  function updateSaveBtn(){
    const okSelect = !!(state.lang && state.regionId && state.unitId && state.orgId);
    const okName = !!(state.fullName && state.fullName.length >= 3);

    $("saveBtn").disabled = !(okSelect && okName);

    const hasActive = (ticket && ticket.status === "active");
    $("takeBtn").disabled = !(okSelect && okName) || hasActive;
  }

  function computeAheadBehind(nowServing, lastNumber, myNumber){
    if (![nowServing,lastNumber,myNumber].every(x=>Number.isFinite(x))) return { ahead:null, behind:null };
    return {
      ahead: Math.max(0, myNumber - nowServing),
      behind: Math.max(0, lastNumber - myNumber),
    };
  }

  function stopCountdown(){
    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = null;
  }
  function startCountdown(){
    stopCountdown();
    countdownTimer = setInterval(()=>{
      const t = getT(state.lang);
      if (!etaEndTs) { $("countdownText").textContent = `${t.countdown}: ‚Äî`; return; }
      const left = etaEndTs - Date.now();
      $("countdownText").textContent = `${t.countdown}: ` + (left <= 0 ? "00:00:00" : fmtCountdown(left));
    }, 1000);
  }

  function stopPolling(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
  }
  function startPolling(){
    stopPolling();
    pollTimer = setInterval(()=>fetchTicketStatus().catch(()=>{}), 5000);
  }

  async function ensureNotifyPermission(){
    if (!("Notification" in window)) return false;
    if (Notification.permission === "granted") return true;
    if (Notification.permission === "denied") return false;
    try{
      const p = await Notification.requestPermission();
      return p === "granted";
    }catch{ return false; }
  }

  function maybeNotifyAhead(ahead){
    // 10 ta qolganda 1 marta notify
    if (!Number.isFinite(ahead)) return;
    if (ahead > 10) { notified10 = false; return; }
    if (ahead <= 10 && !notified10) {
      notified10 = true;
      ensureNotifyPermission().then((ok)=>{
        if (!ok) return;
        const t = getT(state.lang);
        try{
          new Notification("NAVBATUZ", { body: t.served.replace("üéâ ","") + " (" + (ahead===0 ? "NOW" : ("left: " + ahead)) + ")" });
        }catch{}
      });
    }
  }

  function renderTicketStatus(data){
  const t = getT(state.lang);

  if (!ticket || !ticket.number) {
    setTicketUIVisible(false);
    setTicketStateBadge("‚Äî");
    $("etaText").textContent = `${t.eta}: ‚Äî`;
    $("countdownText").textContent = `${t.countdown}: ‚Äî`;
    stopCountdown();
    return;
  }

  const my = Number(ticket.number);
  const nowServing = Number.isFinite(data?.nowServing) ? Number(data.nowServing) : null;
  const lastNumber = Number.isFinite(data?.lastNumber) ? Number(data.lastNumber) : my;

  const avgSec = Number.isFinite(data?.avgServiceSec) && Number(data.avgServiceSec) > 0
    ? Math.round(Number(data.avgServiceSec))
    : null;

  const ahead = (Number.isFinite(nowServing) ? Math.max(0, my - nowServing) : null);
  const behind = (Number.isFinite(nowServing) ? Math.max(0, lastNumber - my) : null);

  const serverStatus = (data?.ticket?.status || "").toLowerCase();

  let uiStatusText = t.statusWaiting;
  let warn = null;
  let badge = "WAIT";

  if (serverStatus === "cancelled") {
    uiStatusText = t.statusCancelled;
    warn = t.autoCancelled;
    badge = "CANCELLED";
  }
  else if (serverStatus === "served") {
    uiStatusText = "Xizmat ko‚Äòrsatildi";
    badge = "SERVED";
  }
  else {
    if (!Number.isFinite(nowServing)) {
      uiStatusText = t.statusWaiting;
      badge = "WAIT";
    } 
    else if (my === nowServing) {
      uiStatusText = t.statusNow;
      warn = t.served;
      badge = "NOW";
    } 
    else if (my > nowServing) {
      uiStatusText = t.statusWaiting;
      badge = "WAIT";
    } 
    else if (my < nowServing) {
      const diff = nowServing - my;
      if (diff <= 5) {
        uiStatusText = t.statusGrace;
        warn = t.missed;
        badge = "GRACE";
      } else {
        uiStatusText = t.statusCancelled;
        warn = t.autoCancelled;
        badge = "CANCELLED";
      }
    }
  }

  $("ticketNo").textContent = "#" + my;
  $("nowServingBadge").textContent = Number.isFinite(nowServing) ? `${t.now}: ${nowServing}` : `${t.now}: ‚Äî`;

  $("aheadKpi").textContent = ahead ?? "‚Äî";
  $("behindKpi").textContent = behind ?? "‚Äî";
  $("avgKpi").textContent = avgSec ? `${avgSec}s` : "‚Äî";
  $("statusKpi").textContent = uiStatusText;

  setWarn(warn);
  setTicketStateBadge(badge);
  setTicketUIVisible(true);

  let etaMin = null;
  if (avgSec && Number.isFinite(ahead)) etaMin = (ahead * avgSec) / 60;

  if (avgSec && Number.isFinite(ahead)) {
    const etaMs = Math.max(0, Math.round(ahead * avgSec * 1000));
    etaEndTs = Date.now() + etaMs;
    startCountdown();
  } else {
    etaEndTs = null;
    stopCountdown();
  }

  $("etaText").textContent = `${t.eta}: ` + (etaMin === null ? "‚Äî" : (Math.round(etaMin) + " min"));
  if (!etaEndTs) $("countdownText").textContent = `${t.countdown}: ‚Äî`;

  $("takeBtn").disabled = true;
}


    const my = Number(ticket.number);
    const nowServing = Number.isFinite(data?.nowServing) ? Number(data.nowServing) : null;
    const avgSec = Number.isFinite(data?.avgServiceSec) && Number(data.avgServiceSec) > 0 ? Math.round(Number(data.avgServiceSec)) : null;

    const lastNumber = Number.isFinite(data?.lastNumber) ? Number(data.lastNumber) : my;
    const { ahead, behind } = computeAheadBehind(nowServing, lastNumber, my);

    const serverStatus = (data?.ticket?.status || "").toLowerCase();

    let uiStatus = t.statusWaiting;
    let badge = "Waiting";
    setWarn(null);

    $("nowServingBadge").textContent = Number.isFinite(nowServing) ? `${t.now}: ${nowServing}` : `${t.now}: ‚Äî`;

    if (serverStatus === "cancelled") {
      uiStatus = t.statusCancelled; badge = "CANCELLED";
      setWarn(t.autoCancelled);
      ticket.status = "cancelled"; saveTicket();
      stopPolling(); updateSaveBtn();
    } else if (serverStatus === "served") {
      uiStatus = t.statusNow; badge = "NOW";
      setWarn(t.served);
    } else if (serverStatus === "missed") {
      uiStatus = t.statusGrace; badge = "GRACE";
      setWarn(t.missed);
    } else {
      // compute by numbers too
      if (Number.isFinite(nowServing) && my === nowServing) {
        uiStatus = t.statusNow; badge = "NOW"; setWarn(t.served);
      } else if (Number.isFinite(nowServing) && my < nowServing) {
        const diff = nowServing - my;
        if (diff <= 5) { uiStatus = t.statusGrace; badge="GRACE"; setWarn(t.missed); }
        else {
          uiStatus = t.statusCancelled; badge="CANCELLED"; setWarn(t.autoCancelled);
          ticket.status="cancelled"; saveTicket(); stopPolling(); updateSaveBtn();
        }
      }
    }

    // ETA + countdown
    let etaMin = null;
    if (avgSec && Number.isFinite(ahead)) etaMin = (ahead * avgSec) / 60;

    if (avgSec && Number.isFinite(ahead)) {
      const etaMs = Math.max(0, Math.round(ahead * avgSec * 1000));
      etaEndTs = Date.now() + etaMs;
      startCountdown();
    } else {
      etaEndTs = null;
      stopCountdown();
    }

    // Notify logic (10 left)
    maybeNotifyAhead(ahead);

    $("ticketNo").textContent = "#" + my;
    const createdAt = ticket.createdAt ? new Date(ticket.createdAt) : new Date();
    $("ticketMeta").textContent = `ORG: ${ticket.orgId} ‚Ä¢ ${createdAt.toLocaleString()} ‚Ä¢ ${state.fullName}`;

    $("aheadKpi").textContent = (ahead===null ? "‚Äî" : ahead);
    $("behindKpi").textContent = (behind===null ? "‚Äî" : behind);
    $("avgKpi").textContent = avgSec ? `${avgSec}s` : "‚Äî";
    $("statusKpi").textContent = uiStatus;

    $("etaText").textContent = `${t.eta}: ` + (etaMin===null ? "‚Äî" : (Math.round(etaMin) + " min"));
    if (!etaEndTs) $("countdownText").textContent = `${t.countdown}: ‚Äî`;

    setTicketStateBadge(badge);
    setTicketUIVisible(true);
    $("takeBtn").disabled = true;
  }

  async function fetchTicketStatus(){
    if (!ticket || ticket.status !== "active") return;
    const data = await apiGet(`/api/ticket?orgId=${encodeURIComponent(ticket.orgId)}&number=${encodeURIComponent(ticket.number)}`);
    setOnlineBadge(true);
    renderTicketStatus(data);
  }

  async function takeTicket(){
    const t = getT(state.lang);

    if (!state.fullName || state.fullName.length < 3) {
      toast(t.needName);
      updateSaveBtn();
      return;
    }

    $("takeBtn").disabled = true;
    setTicketStateBadge("‚Ä¶");

    try{
      const j = await apiPost("/api/take", {
        orgId: state.orgId,
        platform: "web",
        userId: null,
        fullName: state.fullName
      });

      if (!j?.ok) throw new Error(j?.error || "take failed");

      const num = Number(j.number ?? j.ticket?.number);
      ticket = {
        orgId: state.orgId,
        ticketId: j.ticketId ?? j.ticket?.id ?? null,
        number: num,
        createdAt: Date.now(),
        status: "active"
      };
      saveTicket();
      notified10 = false;

      toast(t.taken);

      renderTicketStatus(j);
      startPolling();
      updateSaveBtn();

    }catch(e){
      console.error(e);
      setOnlineBadge(false);
      toast(t.apiFail);
      setTicketStateBadge("‚Äî");
      $("takeBtn").disabled = false;
    }
  }

  async function cancelTicket(){
    const t = getT(state.lang);
    if (!ticket || ticket.status !== "active") return;

    try{
      await apiPost("/api/cancel", { orgId: ticket.orgId, number: ticket.number });
    }catch(e){
      console.error(e);
    }

    ticket = null;
    saveTicket();
    stopPolling();
    stopCountdown();
    setWarn(null);
    setTicketUIVisible(false);
    setTicketStateBadge("‚Äî");
    $("etaText").textContent = `${t.eta}: ‚Äî`;
    $("countdownText").textContent = `${t.countdown}: ‚Äî`;
    toast(t.cancelled);
    updateSaveBtn();
  }

  // ===== Events =====
  $("langSel").addEventListener("change", () => {
    state.lang = ($("langSel").value || "uz").toLowerCase();
    localStorage.setItem("lang", state.lang);

    applyLang(state.lang);

    // language changes should rebuild visible labels
    rebuildRegions();
    if (state.regionId) $("regionSel").value = state.regionId;

    // keep selection ids, but rebuild text options based on lang
    // units/orgs: rebuild without clearing selection if possible
    // We'll attempt to keep current unit/org values:
    const prevUnit = state.unitId;
    const prevOrg = state.orgId;

    // rebuild units list
    if (state.regionId){
      const rid = state.regionId;
      const units = unitsByRegionId.get(String(rid)) || [];
      const items = units.map(u => {
        const base = labelByLang(u, state.lang);
        const prefix = (u.kind === "city")
          ? (state.lang==="uz" ? "Shahar: " : state.lang==="ru" ? "–ì–æ—Ä–æ–¥: " : "City: ")
          : (state.lang==="uz" ? "Tuman: " : state.lang==="ru" ? "–†–∞–π–æ–Ω: " : "District: ");
        return { value: u.id, label: prefix + base };
      });
      setOptions($("unitSel"), items, "‚Äî");
      $("unitSel").disabled = false;
      if (prevUnit) { $("unitSel").value = prevUnit; state.unitId = prevUnit; }
    }

    // rebuild orgs list
    rebuildOrgs();
    if (prevOrg) { $("orgSel").value = prevOrg; state.orgId = prevOrg; }

    updateSaveBtn();
    if (ticket && ticket.status === "active") fetchTicketStatus().catch(()=>{});
  });

  $("fullNameInp").addEventListener("input", () => {
    state.fullName = ($("fullNameInp").value || "").trim().replace(/\s+/g, " ").slice(0, 80);
    localStorage.setItem("fullName", state.fullName);
    updateSaveBtn();
  });

  $("regionSel").addEventListener("change", () => {
    state.regionId = $("regionSel").value;
    localStorage.setItem("regionId", state.regionId);

    state.unitId = ""; state.orgId = "";
    localStorage.setItem("unitId", "");
    localStorage.setItem("orgId", "");

    rebuildUnits();
    rebuildOrgs();
    updateSaveBtn();
  });

  $("unitSel").addEventListener("change", () => {
    state.unitId = $("unitSel").value;
    localStorage.setItem("unitId", state.unitId);

    state.orgId = "";
    localStorage.setItem("orgId", "");

    rebuildOrgs();
    updateSaveBtn();
  });

  $("orgSel").addEventListener("change", () => {
    state.orgId = $("orgSel").value;
    localStorage.setItem("orgId", state.orgId);
    updateSaveBtn();
  });

  $("saveBtn").addEventListener("click", () => {
    toast(getT(state.lang).saved);
    updateSaveBtn();
  });

  $("takeBtn").addEventListener("click", () => takeTicket());

  $("refreshBtn").addEventListener("click", () => {
    fetchTicketStatus().catch((e)=>{
      console.error(e);
      setOnlineBadge(false);
      toast(getT(state.lang).apiFail);
    });
  });

  $("cancelBtn").addEventListener("click", () => cancelTicket());

  $("servedBtn").addEventListener("click", async () => {
    const t = getT(state.lang);
    if (!ticket?.ticketId) { toast("ticketId yo‚Äòq"); return; }
    try{
      const j = await apiPost("/api/ticket/served", { ticketId: ticket.ticketId });
      if (!j?.ok) throw new Error(j?.error || "served error");
      toast(t.servedOk);
      fetchTicketStatus().catch(()=>{});
    }catch(e){
      console.error(e);
      toast("Served xato");
    }
  });

  $("openTicketBtn").addEventListener("click", () => {
    if (!ticket?.ticketId) { toast("ticketId yo‚Äòq"); return; }
    window.open(`/ticket.html?id=${encodeURIComponent(ticket.ticketId)}`, "_blank");
  });

  // ===== Boot =====
  (async function boot(){
    try{
      // init UI state
      $("langSel").value = state.lang;
      $("fullNameInp").value = state.fullName || "";
      applyLang(state.lang);

      // quick health check
      try { await apiGet("/api/health"); setOnlineBadge(true); }
      catch { setOnlineBadge(false); }

      await loadAllData();

      // build selects
      rebuildRegions();
      if (state.regionId) $("regionSel").value = state.regionId;

      // rebuild units + restore selected unit if still exists
      if (state.regionId){
        const rid = state.regionId;
        const units = unitsByRegionId.get(String(rid)) || [];
        const items = units.map(u => {
          const base = labelByLang(u, state.lang);
          const prefix = (u.kind === "city")
            ? (state.lang==="uz" ? "Shahar: " : state.lang==="ru" ? "–ì–æ—Ä–æ–¥: " : "City: ")
            : (state.lang==="uz" ? "Tuman: " : state.lang==="ru" ? "–†–∞–π–æ–Ω: " : "District: ");
          return { value: u.id, label: prefix + base };
        });
        setOptions($("unitSel"), items, "‚Äî");
        $("unitSel").disabled = false;
        if (state.unitId) $("unitSel").value = state.unitId;
      } else {
        $("unitSel").disabled = true;
        setOptions($("unitSel"), [], "‚Äî");
      }

      rebuildOrgs();
      if (state.orgId) $("orgSel").value = state.orgId;

      // ticket restore
      loadTicket();
      if (ticket && ticket.status === "active") {
        setTicketUIVisible(true);
        setTicketStateBadge("Active");
        updateSaveBtn();
        fetchTicketStatus().catch(()=>{});
        startPolling();
      } else {
        ticket = null;
        saveTicket();
        setTicketUIVisible(false);
        setTicketStateBadge("‚Äî");
        updateSaveBtn();
      }

    }catch(e){
      console.error(e);
      toast(getT(state.lang).apiFail);
      setOnlineBadge(false);
    }
  })();
</script>
</body>
</html>


<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ</title>
  <meta name="theme-color" content="#0b1020" />

  <style>
    :root{
      --bg0:#050712;
      --bg1:#070a18;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.70);
      --muted2: rgba(234,240,255,.52);
      --shadow: 0 30px 100px rgba(0,0,0,.60);
      --r: 22px;

      --a1: rgba(120,82,255,.95);
      --a2: rgba(0,199,255,.70);
      --a3: rgba(0,255,163,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(120,82,255,.30), transparent 55%),
        radial-gradient(900px 650px at 90% 30%, rgba(0,199,255,.20), transparent 55%),
        radial-gradient(900px 650px at 55% 95%, rgba(0,255,163,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .noise{
      pointer-events:none;
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.35;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 44px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:16px;}
    .logo{display:flex;align-items:center;gap:12px;user-select:none}
    .mark{
      width:42px;height:42px;border-radius:16px;
      background:
        radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, var(--a1), var(--a2));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(120,82,255,.18);
    }
    .brand{font-weight:900;letter-spacing:.7px;font-size:18px;line-height:1.1;}
    .tagline{font-size:12px;color:var(--muted2);margin-top:2px}

    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(0,255,163,.95);
      box-shadow: 0 0 0 6px rgba(0,255,163,.12);
    }

    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}

    .card{
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 260px at 18% 0%, rgba(120,82,255,.16), transparent 60%),
        radial-gradient(600px 240px at 90% 25%, rgba(0,199,255,.12), transparent 60%);
      pointer-events:none;
      z-index:0;
    }
    .card-inner{position:relative;z-index:1;padding:20px 18px;}

    .hero-title{font-size:34px;letter-spacing:.2px;margin:6px 0 8px;line-height:1.08;}
    .hero-sub{margin:0 0 14px;color:var(--muted);line-height:1.5;font-size:14px;max-width:62ch;}

    .panel{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(9,12,24,.50);
      padding:14px 14px;
    }

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .label{font-size:12px;color:var(--muted2);display:flex;gap:8px;align-items:center;}
    .label .icon{opacity:.9}

    .select{
      width:100%;
      appearance:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
      transition: .12s ease;
    }
    .select:focus{
      border-color: rgba(0,199,255,.35);
      box-shadow: 0 0 0 4px rgba(0,199,255,.12);
    }
    option{background:#0b1020;color:#eaf0ff;}

    .hint{font-size:12px;color:var(--muted2);margin-top:8px;line-height:1.5}
    .hr{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);margin:12px 0;}

    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      padding:13px 14px;
      border-radius:16px;
      color:#081022;
      font-weight:850;
      letter-spacing:.2px;
      background: linear-gradient(135deg, rgba(120,82,255,.95), rgba(0,199,255,.72), rgba(0,255,163,.40));
      box-shadow: 0 18px 50px rgba(0,199,255,.14);
      transition: transform .10s ease;
      margin-top:12px;
    }
    .btn:active{transform:scale(.99)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .side .mini{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:14px;margin-bottom:12px;
    }
    .mini h3{margin:0 0 8px;font-size:13px;letter-spacing:.2px;color:rgba(234,240,255,.88);}
    .mini p{margin:0;font-size:12px;color:var(--muted2);line-height:1.5;}
    .footer{margin-top:14px;color:rgba(234,240,255,.45);font-size:11px;text-align:center;}
    .badge{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.78);
      white-space:nowrap;
    }
    .stack{display:flex;flex-direction:column;gap:10px;}
    .toast{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      font-size:12px;
      color: rgba(234,240,255,.85);
    }
    .hidden{display:none !important;}

    /* ===== Added: Ticket UI ===== */
    .ticketBox{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:14px;
    }
    .ticketTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin-bottom:10px;
    }
    .ticketNo{
      font-size:30px;font-weight:900;letter-spacing:.5px;line-height:1;
    }
    .ticketMeta{
      font-size:12px;color:var(--muted2);line-height:1.45;
    }
    .kpiGrid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;
    }
    .kpi{
      border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding:10px 10px;
    }
    .kpi .k{font-size:11px;color:var(--muted2)}
    .kpi .v{font-size:14px;font-weight:800;margin-top:4px}
    .subActions{display:flex;gap:10px;margin-top:10px}
    .btn2{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      font-weight:800;
    }
    .btn2:active{transform:scale(.99)}
    .warn{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,199,0,.22);
      background: rgba(255,199,0,.08);
      padding:10px 12px;
      color: rgba(255,240,210,.92);
      font-size:12px;
      line-height:1.5;
    }
  </style>
</head>

<body>
  <div class="noise"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <div class="mark"></div>
        <div>
          <div class="brand">NAVBATUZ</div>
          <div class="tagline">Queue management system</div>
        </div>
      </div>
      <div class="pill"><div class="dot"></div><div id="statusText">Online ‚Ä¢ Ready</div></div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-inner">
          <div class="hero-title" id="heroTitle">NAVBATUZ</div>
          <p class="hero-sub" id="heroSub">‚Äî</p>

          <div class="panel">
            <div class="stack">

              <!-- LANGUAGE (SCROLL SELECT) -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üåê</span><span id="lblLang">Til</span></div>
                  <span class="badge" id="bLang">Now</span>
                </div>
                <select id="langSel" class="select">
                  <option value="uz">O‚Äòzbek</option>
                  <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                  <option value="en">English</option>
                </select>
                <div class="hint" id="hintLang">Tilni ro‚Äòyxatdan tanlang (yozib kiritish yo‚Äòq).</div>
              </div>

              <div class="hr"></div>

              <!-- REGION -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üìç</span><span id="lblRegion">Viloyat</span></div>
                  <span class="badge" id="bRegion">Next</span>
                </div>
                <select id="regionSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintRegion">Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.</div>
              </div>

              <!-- UNIT -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üèô</span><span id="lblUnit">Tuman/Shahar</span></div>
                  <span class="badge" id="bUnit">Next</span>
                </div>
                <select id="unitSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintUnit">Viloyatni tanlasangiz, shu viloyatga tegishli tuman/shaharlar chiqadi.</div>
              </div>

              <!-- ORG -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üèõ</span><span id="lblOrg">Muassasa</span></div>
                  <span class="badge" id="bOrg">Next</span>
                </div>
                <select id="orgSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintOrg">Hozircha test uchun faqat Chinoz tumani (Toshkent viloyati) muassasalari bor.</div>
              </div>

              <button id="saveBtn" class="btn" disabled>‚úÖ Tanlovni saqlash</button>
              <div id="toast" class="toast hidden"></div>

              <!-- ===== Added: NAVBAT / TICKET PANEL ===== -->
              <div class="hr"></div>

              <div class="ticketBox">
                <div class="row" style="margin-bottom:8px;">
                  <div class="label"><span class="icon">üé´</span><span id="lblTicket">Navbat</span></div>
                  <span class="badge" id="ticketState">‚Äî</span>
                </div>

                <button id="takeBtn" class="btn" disabled>üéü Navbat olish</button>

                <div id="ticketInfo" class="hidden" style="margin-top:12px;">
                  <div class="ticketTop">
                    <div>
                      <div class="ticketNo" id="ticketNo">‚Äî</div>
                      <div class="ticketMeta" id="ticketMeta">‚Äî</div>
                    </div>
                    <div style="text-align:right;">
                      <div class="badge" id="nowServingBadge">Now: ‚Äî</div>
                      <div class="ticketMeta" style="margin-top:8px;" id="etaText">ETA: ‚Äî</div>
                    </div>
                  </div>

                  <div class="kpiGrid">
                    <div class="kpi">
                      <div class="k">Oldinda</div>
                      <div class="v" id="aheadKpi">‚Äî</div>
                    </div>
                    <div class="kpi">
                      <div class="k">Keyinda</div>
                      <div class="v" id="behindKpi">‚Äî</div>
                    </div>
                    <div class="kpi">
                      <div class="k">O‚Äòrtacha (3‚Äì4)</div>
                      <div class="v" id="avgKpi">‚Äî</div>
                    </div>
                    <div class="kpi">
                      <div class="k">Holat</div>
                      <div class="v" id="statusKpi">‚Äî</div>
                    </div>
                  </div>

                  <div id="warnBox" class="warn hidden"></div>

                  <div class="subActions">
                    <button id="refreshBtn" class="btn2">üîÑ Yangilash</button>
                    <button id="cancelBtn" class="btn2">üóë Bekor</button>
                  </div>
                </div>
              </div>
              <!-- ===== /Added ===== -->

            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-inner side">
          <div class="mini">
            <h3 id="howTitle">‚ö° Qanday ishlaydi?</h3>
            <p id="howText">Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa</p>
          </div>

          <div class="mini">
            <h3>üîí Xavfsiz</h3>
            <p id="safeText">Tanlov localStorage‚Äôda saqlanadi. Serverga faqat kerakli ma‚Äôlumot yuboriladi.</p>
          </div>

          <div class="mini">
            <h3>üì≤ Telegram bot</h3>
            <p id="botText">Telegram bot orqali ham navbat olishingiz mumkin (tezkor va qulay).</p>
          </div>

          <div class="footer">¬© NAVBATUZ ‚Ä¢ Render + PostgreSQL ‚Ä¢ Web + Telegram</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== UI TEXTS (100% label tarjima) ======
    const UI = {
      uz: {
        heroTitle: "Navbatni tez va oson oling.",
        heroSub: "Tilni tanlang, keyin viloyat ‚Üí tuman/shahar ‚Üí muassasani ro‚Äòyxatdan (scroll/select) tanlang.",
        status: "Online ‚Ä¢ Ready",
        lblLang: "Til",
        lblRegion: "Viloyat",
        lblUnit: "Tuman/Shahar",
        lblOrg: "Muassasa",
        hintLang: "Tilni ro‚Äòyxatdan tanlang (yozib kiritish yo‚Äòq).",
        hintRegion: "Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.",
        hintUnit: "Viloyatni tanlasangiz, shu viloyatga tegishli tuman/shaharlar chiqadi.",
        hintOrg: "Hozircha test uchun faqat Chinoz tumani (Toshkent viloyati) muassasalari bor.",
        save: "‚úÖ Tanlovni saqlash",
        howTitle: "‚ö° Qanday ishlaydi?",
        howText: "Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa",
        safe: "Tanlov localStorage‚Äôda saqlanadi. Serverga faqat kerakli ma‚Äôlumot yuboriladi.",
        bot: "Telegram bot orqali ham navbat olishingiz mumkin (tezkor va qulay).",
        saved: "‚úÖ Saqlandi!",
        notFoundOrg: "Hozircha bu tuman/shahar uchun muassasa yo‚Äòq.",

        // Added
        take: "üéü Navbat olish",
        ticket: "Navbat",
        online: "Online ‚Ä¢ Ready",
        offline: "Offline ‚Ä¢ Tekshirilyapti‚Ä¶",
        taken: "‚úÖ Navbat olindi!",
        cancelled: "üóë Navbat bekor qilindi.",
        served: "üéâ Navbatingiz keldi!",
        missed: "‚ö†Ô∏è Navbatingiz o‚Äòtib ketgan. 5 ta keyingi navbat ichida saqlanadi.",
        autoCancelled: "‚õî 5 tadan o‚Äòtib ketdi. Navbat avtomat bekor qilindi.",
        apiFail: "Server bilan aloqa yo‚Äòq. Keyinroq urinib ko‚Äòring."
      },
      ru: {
        heroTitle: "–ü–æ–ª—É—á–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ.",
        heroSub: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫, –∑–∞—Ç–µ–º –æ–±–ª–∞—Å—Ç—å ‚Üí —Ä–∞–π–æ–Ω/–≥–æ—Ä–æ–¥ ‚Üí —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ (–≤—Å—ë —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫/scroll).",
        status: "Online ‚Ä¢ Ready",
        lblLang: "–Ø–∑—ã–∫",
        lblRegion: "–û–±–ª–∞—Å—Ç—å",
        lblUnit: "–†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥",
        lblOrg: "–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ",
        hintLang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ (–±–µ–∑ –≤–≤–æ–¥–∞).",
        hintRegion: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ ‚Äî –∑–∞—Ç–µ–º –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π.",
        hintUnit: "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏ –ø–æ—è–≤—è—Ç—Å—è —Ä–∞–π–æ–Ω—ã/–≥–æ—Ä–æ–¥–∞ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏.",
        hintOrg: "–ü–æ–∫–∞ —Ç–µ—Å—Ç: —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ß–∏–Ω–∞–∑—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ (–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å).",
        save: "‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä",
        howTitle: "‚ö° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
        howText: "–Ø–∑—ã–∫ ‚Üí –û–±–ª–∞—Å—Ç—å ‚Üí –†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥ ‚Üí –£—á—Ä–µ–∂–¥–µ–Ω–∏–µ",
        safe: "–í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage. –ù–∞ —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.",
        bot: "–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç (–±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ).",
        saved: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
        notFoundOrg: "–ü–æ–∫–∞ –Ω–µ—Ç —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞/–≥–æ—Ä–æ–¥–∞.",

        // Added
        take: "üéü –í–∑—è—Ç—å –æ—á–µ—Ä–µ–¥—å",
        ticket: "–û—á–µ—Ä–µ–¥—å",
        online: "Online ‚Ä¢ Ready",
        offline: "Offline ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶",
        taken: "‚úÖ –û—á–µ—Ä–µ–¥—å –ø–æ–ª—É—á–µ–Ω–∞!",
        cancelled: "üóë –û—á–µ—Ä–µ–¥—å –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        served: "üéâ –í–∞—à–∞ –æ—á–µ—Ä–µ–¥—å –ø–æ–¥–æ—à–ª–∞!",
        missed: "‚ö†Ô∏è –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –æ—á–µ—Ä–µ–¥—å. –î–µ—Ä–∂–∏–º –µ—â—ë –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5 —Å–ª–µ–¥—É—é—â–∏—Ö.",
        autoCancelled: "‚õî –ü—Ä–µ–≤—ã—à–µ–Ω–æ +5. –û—á–µ—Ä–µ–¥—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        apiFail: "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
      },
      en: {
        heroTitle: "Get your queue fast and easily.",
        heroSub: "Pick language first, then choose region ‚Üí district/city ‚Üí organization (all via scroll/select).",
        status: "Online ‚Ä¢ Ready",
        lblLang: "Language",
        lblRegion: "Region",
        lblUnit: "District/City",
        lblOrg: "Organization",
        hintLang: "Select language from the list (no typing).",
        hintRegion: "Choose language first, then regions will appear.",
        hintUnit: "After selecting a region, its districts/cities will appear.",
        hintOrg: "Test only: organizations exist only for Chinaz district (Tashkent region) for now.",
        save: "‚úÖ Save selection",
        howTitle: "‚ö° How it works?",
        howText: "Language ‚Üí Region ‚Üí District/City ‚Üí Organization",
        safe: "Selection is stored in localStorage. Only required data is sent to the server.",
        bot: "You can also take a ticket via Telegram bot (fast and convenient).",
        saved: "‚úÖ Saved!",
        notFoundOrg: "No organizations for this district/city yet.",

        // Added
        take: "üéü Take a ticket",
        ticket: "Queue",
        online: "Online ‚Ä¢ Ready",
        offline: "Offline ‚Ä¢ Checking‚Ä¶",
        taken: "‚úÖ Ticket taken!",
        cancelled: "üóë Ticket cancelled.",
        served: "üéâ It‚Äôs your turn!",
        missed: "‚ö†Ô∏è You missed your turn. Keeping within next 5 numbers.",
        autoCancelled: "‚õî Passed +5. Ticket auto-cancelled.",
        apiFail: "Cannot reach server. Try again later."
      }
    };

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);
    const normKey = (s) => (s || "").toString().trim();

    function setOptions(sel, items, placeholder="‚Äî") {
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      sel.appendChild(opt0);

      for (const it of items) {
        const o = document.createElement("option");
        o.value = it.value;
        o.textContent = it.label;
        sel.appendChild(o);
      }
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.add("hidden"), 2200);
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function fmtTimeFromMinutes(mins){
      if (!isFinite(mins) || mins < 0) return "‚Äî";
      const m = Math.round(mins);
      if (m < 60) return `${m} min`;
      const h = Math.floor(m/60);
      const mm = m % 60;
      return `${h} h ${mm} min`;
    }

    // ====== STATE ======
    let CFG = null;
    let regions = [];
    let unitsByRegionId = new Map(); // regionId -> units[]
    let orgsByUzKey = {};

    const state = {
      lang: localStorage.getItem("lang") || "uz",
      regionId: localStorage.getItem("regionId") || "",
      unitId: localStorage.getItem("unitId") || "",
      orgId: localStorage.getItem("orgId") || ""
    };

    // ===== Added: Ticket State =====
    const TICKET_KEY = "navbatuz_ticket";
    const AVG_KEY_PREFIX = "navbatuz_avg_"; // per org

    let ticket = null; // { orgId, ticketId, number, createdAt, status }
    let pollTimer = null;

    function getT(lang){ return UI[lang] || UI.uz; }

    function loadTicket(){
      try{
        const raw = localStorage.getItem(TICKET_KEY);
        ticket = raw ? JSON.parse(raw) : null;
      }catch(e){ ticket = null; }
    }
    function saveTicket(){
      if (!ticket) localStorage.removeItem(TICKET_KEY);
      else localStorage.setItem(TICKET_KEY, JSON.stringify(ticket));
    }

    function setOnlineBadge(isOnline){
      const t = getT(state.lang);
      $("statusText").textContent = isOnline ? t.online : t.offline;
    }

    // Rolling avg service time (seconds) from last 3-4 people:
    // - If server provides avg, we use it.
    // - Else we learn from nowServing increments timing.
    function loadAvgState(orgId){
      try{
        const raw = localStorage.getItem(AVG_KEY_PREFIX + orgId);
        return raw ? JSON.parse(raw) : { lastNowServing: null, lastTs: null, samples: [] };
      }catch(e){
        return { lastNowServing: null, lastTs: null, samples: [] };
      }
    }
    function saveAvgState(orgId, obj){
      localStorage.setItem(AVG_KEY_PREFIX + orgId, JSON.stringify(obj));
    }
    function updateLearnedAvg(orgId, nowServing){
      const s = loadAvgState(orgId);
      const ts = Date.now();

      if (typeof nowServing === "number" && isFinite(nowServing)) {
        if (s.lastNowServing !== null && nowServing > s.lastNowServing && s.lastTs) {
          const diff = ts - s.lastTs; // ms for one step or multiple steps
          const steps = nowServing - s.lastNowServing;
          const per = diff / steps; // ms per person
          const sec = Math.round(per/1000);

          // keep last 4 samples
          s.samples.push(sec);
          s.samples = s.samples.slice(-4);
        }

        // refresh anchors
        s.lastNowServing = nowServing;
        s.lastTs = ts;

        saveAvgState(orgId, s);
      }

      // compute avg (last 3-4)
      const arr = (s.samples || []).slice(-4);
      if (!arr.length) return null;
      const avg = Math.round(arr.reduce((a,b)=>a+b,0) / arr.length);
      return avg; // seconds
    }

    function getLearnedAvg(orgId){
      const s = loadAvgState(orgId);
      const arr = (s.samples || []).slice(-4);
      if (!arr.length) return null;
      return Math.round(arr.reduce((a,b)=>a+b,0) / arr.length);
    }

    // ====== DATA LOADING ======
    async function loadJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch failed: " + url);
      return await r.json();
    }

    function toUnit(obj, kind){
      // dataset fieldlar (taxminan): id, region_id, name_uz, name_oz, name_ru
      const id = obj.id ?? obj.soato_id ?? obj.soatoId ?? obj.code ?? (obj.name_uz || obj.name_ru || Math.random().toString(16).slice(2));
      return {
        id: String(id),
        region_id: String(obj.region_id ?? obj.regionId ?? obj.parent_id ?? obj.parentId ?? obj.region ?? ""),
        kind,
        name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
        name_ru: obj.name_ru ?? obj.nameRu ?? "",
        name_oz: obj.name_oz ?? obj.nameOz ?? "" // kirill
      };
    }

    function toRegion(obj){
      return {
        id: String(obj.id ?? obj.soato_id ?? obj.soatoId ?? obj.code),
        name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
        name_ru: obj.name_ru ?? obj.nameRu ?? "",
        name_oz: obj.name_oz ?? obj.nameOz ?? ""
      };
    }

    function labelByLang(obj, lang){
      // en: name_uz ni ishlatamiz (100% to‚Äòliq EN tarjima datasetda yo‚Äòq)
      if (lang === "ru") return obj.name_ru || obj.name_uz;
      if (lang === "en") return obj.name_uz || obj.name_ru;
      return obj.name_uz || obj.name_ru;
    }

    async function loadAllData(){
      CFG = await loadJSON("/geo.json");
      orgsByUzKey = CFG.orgsByUnitUzKey || {};

      // regions
      regions = (await loadJSON(CFG.sources.regions)).map(toRegion);

      // districts (katta)
      const districtsRaw = await loadJSON(CFG.sources.districts);
      const districts = (Array.isArray(districtsRaw) ? districtsRaw : []).map(x => toUnit(x, "district"));

      // cities (ba‚Äôzi repo‚Äôda juda katta bo‚Äòlishi mumkin; bo‚Äòlmasa skip)
      let cities = [];
      try {
        const citiesRaw = await loadJSON(CFG.sources.cities);
        cities = (Array.isArray(citiesRaw) ? citiesRaw : []).map(x => toUnit(x, "city"));
      } catch(e) {
        // cities.json bo‚Äòlmasa yoki juda katta bo‚Äòlsa ‚Äî districts ichida ham shaharlar aralash bo‚Äòlishi mumkin
        cities = [];
      }

      // group units by region
      unitsByRegionId = new Map();
      for (const u of [...districts, ...cities]) {
        if (!u.region_id) continue;
        if (!unitsByRegionId.has(u.region_id)) unitsByRegionId.set(u.region_id, []);
        unitsByRegionId.get(u.region_id).push(u);
      }

      // sort units
      for (const [rid, arr] of unitsByRegionId.entries()) {
        arr.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
      }
      regions.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
    }

    // ====== UI APPLY ======
    function applyLang(lang){
      const t = UI[lang] || UI.uz;

      $("heroTitle").textContent = t.heroTitle;
      $("heroSub").textContent = t.heroSub;
      $("statusText").textContent = t.status;

      $("lblLang").textContent = t.lblLang;
      $("lblRegion").textContent = t.lblRegion;
      $("lblUnit").textContent = t.lblUnit;
      $("lblOrg").textContent = t.lblOrg;

      $("hintLang").textContent = t.hintLang;
      $("hintRegion").textContent = t.hintRegion;
      $("hintUnit").textContent = t.hintUnit;
      $("hintOrg").textContent = t.hintOrg;

      $("saveBtn").textContent = t.save;
      $("howTitle").textContent = t.howTitle;
      $("howText").textContent = t.howText;
      $("safeText").textContent = t.safe;
      $("botText").textContent = t.bot;

      // Added
      $("lblTicket").textContent = t.ticket;
      $("takeBtn").textContent = t.take;
    }

    function rebuildRegions(){
      const lang = state.lang;
      const items = regions.map(r => ({ value: r.id, label: labelByLang(r, lang) }));
      setOptions($("regionSel"), items, "‚Äî");
      $("regionSel").disabled = false;

      if (state.regionId) $("regionSel").value = state.regionId;
    }

    function rebuildUnits(){
      const lang = state.lang;
      const rid = state.regionId;
      const sel = $("unitSel");

      state.unitId = "";
      state.orgId = "";
      $("orgSel").disabled = true;
      setOptions($("orgSel"), [], "‚Äî");

      if (!rid) {
        sel.disabled = true;
        setOptions(sel, [], "‚Äî");
        return;
      }

      const units = unitsByRegionId.get(String(rid)) || [];

      const items = units.map(u => {
        // tuman/shahar labelini chiroyli chiqaramiz
        const base = labelByLang(u, lang);
        const prefix = (u.kind === "city")
          ? (lang==="uz" ? "Shahar: " : lang==="ru" ? "–ì–æ—Ä–æ–¥: " : "City: ")
          : (lang==="uz" ? "Tuman: " : lang==="ru" ? "–†–∞–π–æ–Ω: " : "District: ");
        return { value: u.id, label: prefix + base };
      });

      setOptions(sel, items, "‚Äî");
      sel.disabled = false;

      if (state.unitId) sel.value = state.unitId;
    }

    function rebuildOrgs(){
      const lang = state.lang;

      const rid = state.regionId;
      const uid = state.unitId;

      if (!rid || !uid) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        return;
      }

      // region & unit ni topamiz
      const region = regions.find(r => String(r.id) === String(rid));
      const units = unitsByRegionId.get(String(rid)) || [];
      const unit = units.find(u => String(u.id) === String(uid));

      if (!region || !unit) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        return;
      }

      // MUHIM: org key har doim UZ-lotin nom bilan bo‚Äòladi (til almashsa ham muammo bo‚Äòlmaydi)
      const uzKey = normKey(region.name_uz) + "|" + normKey(unit.name_uz);
      const orgs = orgsByUzKey[uzKey] || [];

      if (!orgs.length) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        toast((UI[lang]||UI.uz).notFoundOrg);
        return;
      }

      const items = orgs.map(o => ({
        value: o.id,
        label: (o.name && o.name[lang]) ? o.name[lang] : (o.name?.uz || o.id)
      }));

      setOptions($("orgSel"), items, "‚Äî");
      $("orgSel").disabled = false;

      if (state.orgId) $("orgSel").value = state.orgId;
    }

    function updateSaveBtn(){
      const ok = !!(state.lang && state.regionId && state.unitId && state.orgId);
      $("saveBtn").disabled = !ok;
      // Added: take button enabled when org chosen
      $("takeBtn").disabled = !ok || (ticket && ticket.orgId === state.orgId && ticket.status === "active");
    }

    // ===== Added: API (flexible) =====
    async function apiPost(url, body){
      const r = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
        cache:"no-store"
      });
      if (!r.ok) throw new Error("API fail " + url);
      return await r.json();
    }
    async function apiGet(url){
      const r = await fetch(url, { cache:"no-store" });
      if (!r.ok) throw new Error("API fail " + url);
      return await r.json();
    }

    // We try multiple formats to be compatible with your backend.
    function normalizeTicketTakeResponse(j){
      // expected possible fields:
      // - ticketId / id
      // - number / ticketNo / seq
      // - nowServing / current / serving
      // - lastNumber / last / max
      // - avgServiceSec / avg_service_sec / avg
      const ticketId = j.ticketId ?? j.id ?? j.ticket_id ?? null;
      const number = Number(j.number ?? j.ticketNo ?? j.seq ?? j.ticket_number ?? j.no);
      return {
        ticketId,
        number: isFinite(number) ? number : null,
        nowServing: Number(j.nowServing ?? j.current ?? j.serving ?? j.now ?? j.activeNumber),
        lastNumber: Number(j.lastNumber ?? j.last ?? j.max ?? j.tail ?? j.lastIssued),
        avgServiceSec: Number(j.avgServiceSec ?? j.avg_service_sec ?? j.avg ?? j.avgSeconds),
        status: j.status ?? "active",
        raw: j
      };
    }

    function normalizeTicketStatusResponse(j){
      // possible:
      // { nowServing, lastNumber, queueLength, avgServiceSec, status }
      const nowServing = Number(j.nowServing ?? j.current ?? j.serving ?? j.now ?? j.activeNumber);
      const lastNumber = Number(j.lastNumber ?? j.last ?? j.max ?? j.tail ?? j.lastIssued);
      const queueLength = Number(j.queueLength ?? j.length ?? j.total ?? j.waiting);
      const avgServiceSec = Number(j.avgServiceSec ?? j.avg_service_sec ?? j.avg ?? j.avgSeconds);
      return { nowServing, lastNumber, queueLength, avgServiceSec, status: j.status ?? null, raw: j };
    }

    function getTicketOrgSafe(){
      // ticket belongs to selected org; if user changes org, we still show old ticket but disable take for other org
      return (ticket && ticket.orgId) ? ticket.orgId : state.orgId;
    }

    function computeAheadBehind(nowServing, lastNumber, myNumber){
      // nowServing: currently served number
      // lastNumber: last issued number
      // ahead: numbers before you (not served yet)
      // behind: numbers after you
      if (![nowServing,lastNumber,myNumber].every(x=>isFinite(x))) return { ahead:null, behind:null };
      const ahead = Math.max(0, myNumber - nowServing);
      const behind = Math.max(0, lastNumber - myNumber);
      return { ahead, behind };
    }

    function setTicketUIVisible(on){
      $("ticketInfo").classList.toggle("hidden", !on);
    }

    function setWarn(msg){
      const w = $("warnBox");
      if (!msg) { w.classList.add("hidden"); w.textContent=""; return; }
      w.textContent = msg;
      w.classList.remove("hidden");
    }

    function setTicketStateBadge(txt){
      $("ticketState").textContent = txt || "‚Äî";
    }

    function renderTicketStatus(data){
      // data: { nowServing, lastNumber, queueLength, avgServiceSec }
      const lang = state.lang;
      const t = getT(lang);

      if (!ticket || !ticket.number) {
        setTicketUIVisible(false);
        setTicketStateBadge("‚Äî");
        return;
      }

      const my = Number(ticket.number);
      const nowServing = isFinite(data?.nowServing) ? data.nowServing : null;

      // Update learned avg based on nowServing ticks
      let learnedAvg = null;
      const orgId = ticket.orgId;
      if (orgId && isFinite(nowServing)) learnedAvg = updateLearnedAvg(orgId, nowServing);

      // avg service seconds: prefer server, else learned
      let avgSec = null;
      if (isFinite(data?.avgServiceSec) && data.avgServiceSec > 0) avgSec = Math.round(data.avgServiceSec);
      else avgSec = learnedAvg ?? getLearnedAvg(orgId);

      // lastNumber: prefer server; else estimate with queueLength (if provided)
      let lastNumber = isFinite(data?.lastNumber) ? data.lastNumber : null;
      if (!isFinite(lastNumber) && isFinite(data?.queueLength) && isFinite(nowServing)) {
        // if queueLength counts including nowServing..last => last = nowServing + queueLength - 1
        lastNumber = nowServing + Math.max(0, data.queueLength - 1);
      }

      // KPIs
      const { ahead, behind } = computeAheadBehind(nowServing, lastNumber, my);

      // Determine status (served / active / missed / cancelled)
      let uiStatus = "Active";
      let badge = "Active";
      let etaMin = null;

      setWarn(null);

      if (isFinite(nowServing)) {
        $("nowServingBadge").textContent = "Now: " + nowServing;
      } else {
        $("nowServingBadge").textContent = "Now: ‚Äî";
      }

      // If it's your turn:
      if (isFinite(nowServing) && my === nowServing) {
        uiStatus = t.served;
        badge = "NOW";
        setWarn(t.served);
      }

      // If you are ahead (not yet):
      if (isFinite(nowServing) && my > nowServing) {
        uiStatus = "Waiting";
        badge = "Waiting";
      }

      // Missed logic: if my < nowServing
      if (isFinite(nowServing) && my < nowServing) {
        const diff = nowServing - my; // how many numbers passed after yours
        if (diff <= 5) {
          uiStatus = "Missed (grace)";
          badge = "GRACE +" + (5 - diff);
          setWarn(`${t.missed} (Qolgan: ${5 - diff} ta)`);
        } else {
          uiStatus = "Auto-cancelled";
          badge = "CANCELLED";
          setWarn(t.autoCancelled);
          ticket.status = "cancelled";
          saveTicket();
          // try cancel on server (if endpoint exists)
          tryCancelOnServer().catch(()=>{});
        }
      }

      // ETA based on avgSec and ahead
      if (avgSec && isFinite(ahead)) {
        etaMin = (ahead * avgSec) / 60;
      }

      $("ticketNo").textContent = "#" + my;
      $("ticketMeta").textContent = `ORG: ${ticket.orgId} ‚Ä¢ ${new Date(ticket.createdAt||Date.now()).toLocaleString()}`;
      $("aheadKpi").textContent = (ahead===null ? "‚Äî" : ahead);
      $("behindKpi").textContent = (behind===null ? "‚Äî" : behind);
      $("avgKpi").textContent = avgSec ? `${avgSec}s` : "‚Äî";
      $("statusKpi").textContent = uiStatus;
      $("etaText").textContent = "ETA: " + (etaMin===null ? "‚Äî" : fmtTimeFromMinutes(etaMin));

      setTicketStateBadge(badge);
      setTicketUIVisible(true);

      // take button state
      $("takeBtn").disabled = true;
    }

    async function takeTicket(){
      const lang = state.lang;
      const t = getT(lang);

      if (!state.orgId) return;

      $("takeBtn").disabled = true;
      setTicketStateBadge("‚Ä¶");

      try{
        setOnlineBadge(true);

        // Most common: POST /api/take { orgId, lang, regionId, unitId }
        const j = await apiPost("/api/take", {
          orgId: state.orgId,
          lang: state.lang,
          regionId: state.regionId,
          unitId: state.unitId
        });

        const norm = normalizeTicketTakeResponse(j);
        if (!norm.number) throw new Error("Bad take response");

        ticket = {
          orgId: state.orgId,
          ticketId: norm.ticketId || null,
          number: norm.number,
          createdAt: Date.now(),
          status: "active"
        };
        saveTicket();

        toast(t.taken);

        // render immediately with data we already have
        renderTicketStatus({
          nowServing: isFinite(norm.nowServing) ? norm.nowServing : null,
          lastNumber: isFinite(norm.lastNumber) ? norm.lastNumber : norm.number,
          avgServiceSec: isFinite(norm.avgServiceSec) ? norm.avgServiceSec : null
        });

        startPolling();
      }catch(e){
        console.error(e);
        setOnlineBadge(false);
        toast(t.apiFail);
        setTicketStateBadge("‚Äî");
        $("takeBtn").disabled = false;
      }
    }

    async function fetchTicketStatus(){
      if (!ticket || !ticket.orgId) return;
      const orgId = ticket.orgId;

      // Try best-known endpoint patterns
      // 1) /api/ticket?orgId=...&ticket=...
      // 2) /api/ticket/{ticketId}
      // 3) /api/ticket?orgId=...
      let j = null;
      try{
        if (ticket.ticketId) {
          try{
            j = await apiGet(`/api/ticket/${encodeURIComponent(ticket.ticketId)}`);
          }catch(_){
            j = await apiGet(`/api/ticket?orgId=${encodeURIComponent(orgId)}&ticketId=${encodeURIComponent(ticket.ticketId)}&number=${encodeURIComponent(ticket.number)}`);
          }
        } else {
          j = await apiGet(`/api/ticket?orgId=${encodeURIComponent(orgId)}&number=${encodeURIComponent(ticket.number)}`);
        }
      }catch(e){
        // last fallback: org only
        j = await apiGet(`/api/ticket?orgId=${encodeURIComponent(orgId)}`);
      }

      const norm = normalizeTicketStatusResponse(j);
      setOnlineBadge(true);
      renderTicketStatus(norm);
    }

    function startPolling(){
      stopPolling();
      // Poll every 5s for fresh queue status
      pollTimer = setInterval(()=> {
        fetchTicketStatus().catch((e)=>{
          console.error(e);
          setOnlineBadge(false);
        });
      }, 5000);

      // initial fetch
      fetchTicketStatus().catch((e)=>{
        console.error(e);
        setOnlineBadge(false);
      });
    }

    function stopPolling(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    async function tryCancelOnServer(){
      if (!ticket) return;
      // optional endpoint: POST /api/cancel { orgId, ticketId, number }
      // if your backend uses different name, we keep it safe.
      try{
        await apiPost("/api/cancel", {
          orgId: ticket.orgId,
          ticketId: ticket.ticketId,
          number: ticket.number
        });
      }catch(e){
        // ignore
      }
    }

    async function cancelTicket(){
      const t = getT(state.lang);
      if (!ticket) return;

      $("cancelBtn").disabled = true;
      try{
        await tryCancelOnServer();
      }catch(_){}
      ticket.status = "cancelled";
      saveTicket();
      stopPolling();

      setTicketStateBadge("CANCELLED");
      $("statusKpi").textContent = "Cancelled";
      setWarn(null);
      toast(t.cancelled);

      // enable take again if selection ok
      updateSaveBtn();
      $("takeBtn").disabled = !(state.lang && state.regionId && state.unitId && state.orgId);
    }

    function syncTicketButtons(){
      // If there is an active ticket for current org => hide take
      if (ticket && ticket.status === "active") {
        $("takeBtn").disabled = true;
        setTicketUIVisible(true);
        setTicketStateBadge("Active");
        startPolling();
      } else {
        setTicketUIVisible(false);
        setTicketStateBadge("‚Äî");
        updateSaveBtn();
      }
    }

    // ====== EVENTS ======
    $("langSel").addEventListener("change", () => {
      state.lang = $("langSel").value;
      localStorage.setItem("lang", state.lang);
      applyLang(state.lang);

      // rebuild labels
      rebuildRegions();
      rebuildUnits();
      rebuildOrgs();
      updateSaveBtn();

      // rerender ticket labels
      if (ticket && ticket.status === "active") {
        fetchTicketStatus().catch(()=>{});
      }
    });

    $("regionSel").addEventListener("change", () => {
      state.regionId = $("regionSel").value;
      localStorage.setItem("regionId", state.regionId);

      state.unitId = "";
      state.orgId = "";
      localStorage.removeItem("unitId");
      localStorage.removeItem("orgId");

      rebuildUnits();
      rebuildOrgs();
      updateSaveBtn();
    });

    $("unitSel").addEventListener("change", () => {
      state.unitId = $("unitSel").value;
      localStorage.setItem("unitId", state.unitId);

      state.orgId = "";
      localStorage.removeItem("orgId");

      rebuildOrgs();
      updateSaveBtn();
    });

    $("orgSel").addEventListener("change", () => {
      state.orgId = $("orgSel").value;
      localStorage.setItem("orgId", state.orgId);
      updateSaveBtn();

      // If ticket exists for different org, keep it but allow take for new org (only if no active ticket)
      if (ticket && ticket.status === "active" && ticket.orgId !== state.orgId) {
        // We don't auto-cancel; show warning to user via UI
        setWarn(null);
      }
    });

    $("saveBtn").addEventListener("click", async () => {
      const lang = state.lang;
      localStorage.setItem("navbatuz_selection", JSON.stringify(state));
      toast((UI[lang]||UI.uz).saved);
      updateSaveBtn();
    });

    // Added events
    $("takeBtn").addEventListener("click", () => takeTicket());
    $("refreshBtn").addEventListener("click", () => {
      fetchTicketStatus().catch((e)=>{
        console.error(e);
        setOnlineBadge(false);
        toast(getT(state.lang).apiFail);
      });
    });
    $("cancelBtn").addEventListener("click", () => cancelTicket());

    // ====== BOOT ======
    (async function boot(){
      try{
        $("langSel").value = state.lang;
        applyLang(state.lang);

        // yuklash
        await loadAllData();

        rebuildRegions();

        // restore previous selection
        if (state.regionId) $("regionSel").value = state.regionId;

        rebuildUnits();
        if (state.unitId) $("unitSel").value = state.unitId;

        rebuildOrgs();
        if (state.orgId) $("orgSel").value = state.orgId;

        updateSaveBtn();

        // Added: restore ticket
        loadTicket();
        if (ticket && ticket.status === "active") {
          // If selection differs, still keep ticket active
          syncTicketButtons();
        } else {
          ticket = null;
          saveTicket();
          syncTicketButtons();
        }

      } catch(e){
        console.error(e);
        toast("Data yuklanmadi. geo.json yoki internet tekshir.");
        setOnlineBadge(false);
      }
    })();
  </script>
</body>
</html>

const r = await fetch("/api/ticket/served", {
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAVBATUZ</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg0:#050712;
      --bg1:#070a18;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.70);
      --muted2: rgba(234,240,255,.52);
      --shadow: 0 30px 100px rgba(0,0,0,.60);
      --r: 22px;

      --a1: rgba(120,82,255,.95);
      --a2: rgba(0,199,255,.70);
      --a3: rgba(0,255,163,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(120,82,255,.30), transparent 55%),
        radial-gradient(900px 650px at 90% 30%, rgba(0,199,255,.20), transparent 55%),
        radial-gradient(900px 650px at 55% 95%, rgba(0,255,163,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .noise{
      pointer-events:none;
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.35;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 44px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:16px;}
    .logo{display:flex;align-items:center;gap:12px;user-select:none}
    .mark{
      width:42px;height:42px;border-radius:16px;
      background:
        radial-gradient(10px 10px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, var(--a1), var(--a2));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 40px rgba(120,82,255,.18);
    }
    .brand{font-weight:900;letter-spacing:.7px;font-size:18px;line-height:1.1;}
    .tagline{font-size:12px;color:var(--muted2);margin-top:2px}
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(0,255,163,.95);
      box-shadow: 0 0 0 6px rgba(0,255,163,.12);
    }
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 260px at 18% 0%, rgba(120,82,255,.16), transparent 60%),
        radial-gradient(600px 240px at 90% 25%, rgba(0,199,255,.12), transparent 60%);
      pointer-events:none;
      z-index:0;
    }
    .card-inner{position:relative;z-index:1;padding:20px 18px;}
    .hero-title{font-size:34px;letter-spacing:.2px;margin:6px 0 8px;line-height:1.08;}
    .hero-sub{margin:0 0 14px;color:var(--muted);line-height:1.5;font-size:14px;max-width:62ch;}
    .panel{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(9,12,24,.50);
      padding:14px 14px;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .label{font-size:12px;color:var(--muted2);display:flex;gap:8px;align-items:center;}
    .label .icon{opacity:.9}
    .select{
      width:100%;
      appearance:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
      transition: .12s ease;
    }
    .select:focus{
      border-color: rgba(0,199,255,.35);
      box-shadow: 0 0 0 4px rgba(0,199,255,.12);
    }
    option{background:#0b1020;color:#eaf0ff;}
    .hint{font-size:12px;color:var(--muted2);margin-top:8px;line-height:1.5}
    .hr{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);margin:12px 0;}
    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      padding:13px 14px;
      border-radius:16px;
      color:#081022;
      font-weight:850;
      letter-spacing:.2px;
      background: linear-gradient(135deg, rgba(120,82,255,.95), rgba(0,199,255,.72), rgba(0,255,163,.40));
      box-shadow: 0 18px 50px rgba(0,199,255,.14);
      transition: transform .10s ease;
      margin-top:12px;
    }
    .btn:active{transform:scale(.99)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .side .mini{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:14px;margin-bottom:12px;
    }
    .mini h3{margin:0 0 8px;font-size:13px;letter-spacing:.2px;color:rgba(234,240,255,.88);}
    .mini p{margin:0;font-size:12px;color:var(--muted2);line-height:1.5;}
    .footer{margin-top:14px;color:rgba(234,240,255,.45);font-size:11px;text-align:center;}
    .badge{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.78);
      white-space:nowrap;
    }
    .stack{display:flex;flex-direction:column;gap:10px;}
    .toast{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      font-size:12px;
      color: rgba(234,240,255,.85);
    }
    .hidden{display:none !important;}
    .ticketBox{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:14px;
    }
    .ticketTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin-bottom:10px;
    }
    .ticketNo{
      font-size:30px;font-weight:900;letter-spacing:.5px;line-height:1;
    }
    .ticketMeta{
      font-size:12px;color:var(--muted2);line-height:1.45;
    }
    .kpiGrid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;
    }
    .kpi{
      border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding:10px 10px;
    }
    .kpi .k{font-size:11px;color:var(--muted2)}
    .kpi .v{font-size:14px;font-weight:800;margin-top:4px}
    .subActions{display:flex;gap:10px;margin-top:10px}
    .btn2{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      font-weight:800;
    }
    .btn2:active{transform:scale(.99)}
    .warn{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,199,0,.22);
      background: rgba(255,199,0,.08);
      padding:10px 12px;
      color: rgba(255,240,210,.92);
      font-size:12px;
      line-height:1.5;
    }
  </style>
</head>

<body>
  <div class="noise"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <div class="mark"></div>
        <div>
          <div class="brand">NAVBATUZ</div>
          <div class="tagline">Queue management system</div>
        </div>
      </div>
      <div class="pill"><div class="dot"></div><div id="statusText">Online ‚Ä¢ Ready</div></div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-inner">
          <div class="hero-title" id="heroTitle">NAVBATUZ</div>
          <p class="hero-sub" id="heroSub">‚Äî</p>

          <div class="panel">
            <div class="stack">

              <!-- LANGUAGE -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üåê</span><span id="lblLang">Til</span></div>
                  <span class="badge" id="bLang">Now</span>
                </div>
                <select id="langSel" class="select">
                  <option value="uz">O‚Äòzbek</option>
                  <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                  <option value="en">English</option>
                </select>
                <div class="hint" id="hintLang">Tilni ro‚Äòyxatdan tanlang (yozib kiritish yo‚Äòq).</div>
              </div>

              <div class="hr"></div>

              <!-- REGION -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üìç</span><span id="lblRegion">Viloyat</span></div>
                  <span class="badge" id="bRegion">Next</span>
                </div>
                <select id="regionSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintRegion">Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.</div>
              </div>

              <!-- UNIT -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üèô</span><span id="lblUnit">Tuman/Shahar</span></div>
                  <span class="badge" id="bUnit">Next</span>
                </div>
                <select id="unitSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintUnit">Viloyatni tanlasangiz, shu viloyatga tegishli tuman/shaharlar chiqadi.</div>
              </div>

              <!-- ORG -->
              <div>
                <div class="row">
                  <div class="label"><span class="icon">üèõ</span><span id="lblOrg">Muassasa</span></div>
                  <span class="badge" id="bOrg">Next</span>
                </div>
                <select id="orgSel" class="select" disabled>
                  <option value="">‚Äî</option>
                </select>
                <div class="hint" id="hintOrg">Hozircha test uchun faqat Chinoz tumani (Toshkent viloyati) muassasalari bor.</div>
              </div>
<!-- FULL NAME -->
<div style="margin-top:12px;">
  <div class="row">
    <div class="label"><span class="icon">üë§</span><span id="lblFullName">Ism familiya</span></div>
    <span class="badge" id="bName">Required</span>
  </div>
  <input id="fullNameInp" class="select" placeholder="Masalan: Ali Valiyev" />
  <div class="hint" id="hintName">Navbat olishdan oldin ism familiyangizni kiriting.</div>
</div>

              <button id="saveBtn" class="btn" disabled>‚úÖ Tanlovni saqlash</button>
              <div id="toast" class="toast hidden"></div>

              <div class="hr"></div>

              <!-- TICKET -->
              <div class="ticketBox">
                <div class="row" style="margin-bottom:8px;">
                  <div class="label"><span class="icon">üé´</span><span id="lblTicket">Navbat</span></div>
                  <span class="badge" id="ticketState">‚Äî</span>
                </div>

                <button id="takeBtn" class="btn" disabled>üéü Navbat olish</button>

                <div id="ticketInfo" class="hidden" style="margin-top:12px;">
                  <div class="ticketTop">
                    <div>
                      <div class="ticketNo" id="ticketNo">‚Äî</div>
                      <div class="ticketMeta" id="ticketMeta">‚Äî</div>
                    </div>
                    <div style="text-align:right;">
                      <div class="badge" id="nowServingBadge">Now: ‚Äî</div>
                      <div class="ticketMeta" style="margin-top:8px;" id="etaText">ETA: ‚Äî</div>
                      <div class="ticketMeta" style="margin-top:4px;" id="countdownText">Countdown: ‚Äî</div>
                    </div>
                  </div>

                  <div class="kpiGrid">
                    <div class="kpi">
                      <div class="k">Oldinda</div>
                      <div class="v" id="aheadKpi">‚Äî</div>
                    </div>
                    <div class="kpi">
                      <div class="k">Keyinda</div>
                      <div class="v" id="behindKpi">‚Äî</div>
                    </div>
                    <div class="kpi">
                      <div class="k">O‚Äòrtacha (3‚Äì4)</div>
                      <div class="v" id="avgKpi">‚Äî</div>
                    </div>
                    <div class="kpi">
                      <div class="k">Holat</div>
                      <div class="v" id="statusKpi">‚Äî</div>
                    </div>
                  </div>

                  <div id="warnBox" class="warn hidden"></div>

                  <div class="subActions">
  <button id="refreshBtn" class="btn2">üîÑ Yangilash</button>
  <button id="cancelBtn" class="btn2">üóë Bekor</button>
  <button id="servedBtn" class="btn2">‚úÖ Xizmat ko‚Äòrsatildi</button>
</div>

                </div>
              </div>
              <!-- /TICKET -->

            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-inner side">
          <div class="mini">
            <h3 id="howTitle">‚ö° Qanday ishlaydi?</h3>
            <p id="howText">Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa</p>
          </div>

          <div class="mini">
            <h3>üîî Bildirishnoma</h3>
            <p id="notifText">Navbatingiz 10 ta qolganda va bekor bo‚Äòlsa avtomatik xabar beradi (browser permission kerak).</p>
          </div>

          <div class="mini">
            <h3>üì≤ Telegram bot</h3>
            <p id="botText">Telegram bot orqali ham navbat olishingiz mumkin (tezkor va qulay).</p>
          </div>

          <div class="footer">¬© NAVBATUZ ‚Ä¢ Render + PostgreSQL ‚Ä¢ Web + Telegram</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    const UI = {
      uz: {
        heroTitle: "Navbatni tez va oson oling.",
        heroSub: "Tilni tanlang, keyin viloyat ‚Üí tuman/shahar ‚Üí muassasani ro‚Äòyxatdan (scroll/select) tanlang.",
        lblLang: "Til",
        lblRegion: "Viloyat",
        lblUnit: "Tuman/Shahar",
        lblOrg: "Muassasa",
        hintLang: "Tilni ro‚Äòyxatdan tanlang (yozib kiritish yo‚Äòq).",
        hintRegion: "Avval tilni tanlang, keyin viloyat ro‚Äòyxati chiqadi.",
        hintUnit: "Viloyatni tanlasangiz, shu viloyatga tegishli tuman/shaharlar chiqadi.",
        hintOrg: "Hozircha test uchun faqat Chinoz tumani (Toshkent viloyati) muassasalari bor.",
        save: "‚úÖ Tanlovni saqlash",
        howTitle: "‚ö° Qanday ishlaydi?",
        howText: "Til ‚Üí Viloyat ‚Üí Tuman/Shahar ‚Üí Muassasa",
        bot: "Telegram bot orqali ham navbat olishingiz mumkin (tezkor va qulay).",
        saved: "‚úÖ Saqlandi!",
        notFoundOrg: "Hozircha bu tuman/shahar uchun muassasa yo‚Äòq.",
        lblFullName: "Ism familiya",
hintName: "Navbat olishdan oldin ism familiyangizni kiriting.",
needName: "Ism familiya kiriting.",
servedBtn: "‚úÖ Xizmat ko‚Äòrsatildi",
servedOk: "‚úÖ Served qilindi (o‚Äòrtacha vaqt hisoblanadi).",

        take: "üéü Navbat olish",
        ticket: "Navbat",
        online: "Online ‚Ä¢ Ready",
        offline: "Offline ‚Ä¢ Aloqa yo‚Äòq",
        taken: "‚úÖ Navbat olindi!",
        cancelled: "üóë Navbat bekor qilindi.",
        served: "üéâ Navbatingiz keldi!",
        missed: "‚ö†Ô∏è Navbatingiz o‚Äòtib ketgan. 5 ta keyingi navbat ichida saqlanadi.",
        autoCancelled: "‚õî 5 tadan o‚Äòtib ketdi. Navbat avtomat bekor qilindi.",
        apiFail: "Server bilan aloqa yo‚Äòq. Keyinroq urinib ko‚Äòring.",
        notif10: "üîî Navbatingizga 10 ta qoldi!",
        notifCancelled: "‚õî Navbatingiz bekor qilindi.",
        notifNow: "‚úÖ Navbatingiz keldi!"
      },
      ru: {
        heroTitle: "–ü–æ–ª—É—á–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ.",
        heroSub: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫, –∑–∞—Ç–µ–º –æ–±–ª–∞—Å—Ç—å ‚Üí —Ä–∞–π–æ–Ω/–≥–æ—Ä–æ–¥ ‚Üí —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ (–≤—Å—ë —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫/scroll).",
        lblLang: "–Ø–∑—ã–∫",
        lblRegion: "–û–±–ª–∞—Å—Ç—å",
        lblUnit: "–†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥",
        lblOrg: "–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ",
        hintLang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ (–±–µ–∑ –≤–≤–æ–¥–∞).",
        hintRegion: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ ‚Äî –∑–∞—Ç–µ–º –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π.",
        hintUnit: "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏ –ø–æ—è–≤—è—Ç—Å—è —Ä–∞–π–æ–Ω—ã/–≥–æ—Ä–æ–¥–∞ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏.",
        hintOrg: "–ü–æ–∫–∞ —Ç–µ—Å—Ç: —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ß–∏–Ω–∞–∑—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ (–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å).",
        save: "‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä",
        howTitle: "‚ö° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
        howText: "–Ø–∑—ã–∫ ‚Üí –û–±–ª–∞—Å—Ç—å ‚Üí –†–∞–π–æ–Ω/–ì–æ—Ä–æ–¥ ‚Üí –£—á—Ä–µ–∂–¥–µ–Ω–∏–µ",
        bot: "–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç (–±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ).",
        saved: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
        notFoundOrg: "–ü–æ–∫–∞ –Ω–µ—Ç —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞/–≥–æ—Ä–æ–¥–∞.",
        lblFullName: "–ò–º—è –§–∞–º–∏–ª–∏—è",
hintName: "–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤–∑—è—Ç—å –æ—á–µ—Ä–µ–¥—å, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é.",
needName: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é.",
servedBtn: "‚úÖ –û–±—Å–ª—É–∂–µ–Ω–æ",
servedOk: "‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ–±—Å–ª—É–∂–µ–Ω–æ (—Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–∏—Ç—Å—è).",

        take: "üéü –í–∑—è—Ç—å –æ—á–µ—Ä–µ–¥—å",
        ticket: "–û—á–µ—Ä–µ–¥—å",
        online: "Online ‚Ä¢ Ready",
        offline: "Offline ‚Ä¢ –ù–µ—Ç —Å–≤—è–∑–∏",
        taken: "‚úÖ –û—á–µ—Ä–µ–¥—å –ø–æ–ª—É—á–µ–Ω–∞!",
        cancelled: "üóë –û—á–µ—Ä–µ–¥—å –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        served: "üéâ –í–∞—à–∞ –æ—á–µ—Ä–µ–¥—å –ø–æ–¥–æ—à–ª–∞!",
        missed: "‚ö†Ô∏è –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –æ—á–µ—Ä–µ–¥—å. –î–µ—Ä–∂–∏–º –µ—â—ë –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5 —Å–ª–µ–¥—É—é—â–∏—Ö.",
        autoCancelled: "‚õî –ü—Ä–µ–≤—ã—à–µ–Ω–æ +5. –û—á–µ—Ä–µ–¥—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        apiFail: "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        notif10: "üîî –î–æ –≤–∞—à–µ–π –æ—á–µ—Ä–µ–¥–∏ –æ—Å—Ç–∞–ª–æ—Å—å 10!",
        notifCancelled: "‚õî –í–∞—à–∞ –æ—á–µ—Ä–µ–¥—å –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        notifNow: "‚úÖ –í–∞—à–∞ –æ—á–µ—Ä–µ–¥—å –ø–æ–¥–æ—à–ª–∞!"
      },
      en: {
        heroTitle: "Get your queue fast and easily.",
        heroSub: "Pick language first, then choose region ‚Üí district/city ‚Üí organization (all via scroll/select).",
        lblLang: "Language",
        lblRegion: "Region",
        lblUnit: "District/City",
        lblOrg: "Organization",
        hintLang: "Select language from the list (no typing).",
        hintRegion: "Choose language first, then regions will appear.",
        hintUnit: "After selecting a region, its districts/cities will appear.",
        hintOrg: "Test only: organizations exist only for Chinaz district (Tashkent region) for now.",
        save: "‚úÖ Save selection",
        howTitle: "‚ö° How it works?",
        howText: "Language ‚Üí Region ‚Üí District/City ‚Üí Organization",
        bot: "You can also take a ticket via Telegram bot (fast and convenient).",
        saved: "‚úÖ Saved!",
        notFoundOrg: "No organizations for this district/city yet.",
        lblFullName: "Full name",
hintName: "Enter your full name before taking a ticket.",
needName: "Enter full name.",
servedBtn: "‚úÖ Served",
servedOk: "‚úÖ Marked served (average time will improve).",

        take: "üéü Take a ticket",
        ticket: "Queue",
        online: "Online ‚Ä¢ Ready",
        offline: "Offline ‚Ä¢ No connection",
        taken: "‚úÖ Ticket taken!",
        cancelled: "üóë Ticket cancelled.",
        served: "üéâ It‚Äôs your turn!",
        missed: "‚ö†Ô∏è You missed your turn. Keeping within next 5 numbers.",
        autoCancelled: "‚õî Passed +5. Ticket auto-cancelled.",
        apiFail: "Cannot reach server. Try again later.",
        notif10: "üîî Only 10 left before your turn!",
        notifCancelled: "‚õî Your ticket was cancelled.",
        notifNow: "‚úÖ It‚Äôs your turn!"
      }
    };

    const $ = (id) => document.getElementById(id);
    const normKey = (s) => (s || "").toString().trim();

    function setOptions(sel, items, placeholder="‚Äî") {
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      sel.appendChild(opt0);
      for (const it of items) {
        const o = document.createElement("option");
        o.value = it.value;
        o.textContent = it.label;
        sel.appendChild(o);
      }
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.add("hidden"), 2200);
    }

    function fmtTimeFromMinutes(mins){
      if (!isFinite(mins) || mins < 0) return "‚Äî";
      const m = Math.round(mins);
      if (m < 60) return `${m} min`;
      const h = Math.floor(m/60);
      const mm = m % 60;
      return `${h} h ${mm} min`;
    }

    function fmtCountdown(ms){
      if (!Number.isFinite(ms) || ms <= 0) return "00:00:00";
      let s = Math.floor(ms / 1000);
      const days = Math.floor(s / 86400); s -= days*86400;
      const hrs = Math.floor(s / 3600); s -= hrs*3600;
      const mins = Math.floor(s / 60); s -= mins*60;
      const pad = (n)=> String(n).padStart(2,"0");
      if (days > 0) return `${days}d ${pad(hrs)}:${pad(mins)}:${pad(s)}`;
      return `${pad(hrs)}:${pad(mins)}:${pad(s)}`;
    }

    // ===== Notifications =====
    function getT(lang){ return UI[lang] || UI.uz; }

    async function ensureNotifPermission(){
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;
      try{
        const p = await Notification.requestPermission();
        return p === "granted";
      }catch(e){ return false; }
    }

    function pushNotif(title, body, tag){
      const t = getT(state.lang);
      if (!("Notification" in window)) {
        toast(body || title);
        return;
      }
      if (Notification.permission !== "granted") {
        toast(body || title);
        return;
      }
      try{
        new Notification(title, { body, tag });
      }catch(e){
        toast(body || title);
      }
    }

    // ===== State/data =====
    let CFG = null;
    let regions = [];
    let unitsByRegionId = new Map();
    let orgsByUzKey = {};

    const state = {
  lang: localStorage.getItem("lang") || "uz",
  regionId: localStorage.getItem("regionId") || "",
  unitId: localStorage.getItem("unitId") || "",
  orgId: localStorage.getItem("orgId") || "",
  fullName: localStorage.getItem("fullName") || ""
};


    // ===== Ticket state =====
    const TICKET_KEY = "navbatuz_ticket";
    const AVG_KEY_PREFIX = "navbatuz_avg_";
    let ticket = null;

    // countdown internals
    let pollTimer = null;
    let countdownTimer = null;
    let etaEndTs = null; // Date.now()+etaMs
    let lastAhead = null;
    let notified10 = false;
    let notifiedNow = false;
    let notifiedCancelled = false;

    function loadTicket(){
      try{
        const raw = localStorage.getItem(TICKET_KEY);
        ticket = raw ? JSON.parse(raw) : null;
      }catch(e){ ticket = null; }
    }
    function saveTicket(){
      if (!ticket) localStorage.removeItem(TICKET_KEY);
      else localStorage.setItem(TICKET_KEY, JSON.stringify(ticket));
    }

    function setOnlineBadge(isOnline){
      const t = getT(state.lang);
      $("statusText").textContent = isOnline ? t.online : t.offline;
    }

    // ===== API =====
    async function apiGet(path){
      const r = await fetch(API_BASE + path, { cache:"no-store" });
      if (!r.ok) throw new Error("API GET fail " + path);
      return await r.json();
    }
    async function apiPost(path, body){
      const r = await fetch(API_BASE + path, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
        cache:"no-store"
      });
      if (!r.ok) throw new Error("API POST fail " + path);
      return await r.json();
    }

    // ===== fetch JSON with fallback (fix 404 master/main) =====
    async function fetchJsonSmart(url){
      const tries = [];
      if (url) tries.push(url);

      // master -> main
      if (url && url.includes("/master/")) tries.push(url.replace("/master/","/main/"));
      if (url && url.includes("/main/")) tries.push(url.replace("/main/","/master/"));

      // JSON -> json (case)
      if (url && url.includes("/JSON/")) tries.push(url.replace("/JSON/","/json/"));
      if (url && url.includes("/json/")) tries.push(url.replace("/json/","/JSON/"));

      // remove double slashes
      const uniq = [...new Set(tries)].filter(Boolean);

      let lastErr = null;
      for (const u of uniq){
        try{
          const res = await fetch(u, { cache:"no-store" });
          if (!res.ok) { lastErr = new Error(`Fetch ${u} -> ${res.status}`); continue; }
          return await res.json();
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("fetchJsonSmart failed");
    }

    // ===== Rolling avg learning (client side fallback) =====
    function loadAvgState(orgId){
      try{
        const raw = localStorage.getItem(AVG_KEY_PREFIX + orgId);
        return raw ? JSON.parse(raw) : { lastNowServing: null, lastTs: null, samples: [] };
      }catch(e){
        return { lastNowServing: null, lastTs: null, samples: [] };
      }
    }
    function saveAvgState(orgId, obj){
      localStorage.setItem(AVG_KEY_PREFIX + orgId, JSON.stringify(obj));
    }
    function updateLearnedAvg(orgId, nowServing){
      const s = loadAvgState(orgId);
      const ts = Date.now();
      if (typeof nowServing === "number" && isFinite(nowServing)) {
        if (s.lastNowServing !== null && nowServing > s.lastNowServing && s.lastTs) {
          const diff = ts - s.lastTs;
          const steps = nowServing - s.lastNowServing;
          const per = diff / steps;
          const sec = Math.round(per/1000);
          s.samples.push(sec);
          s.samples = s.samples.slice(-4);
        }
        s.lastNowServing = nowServing;
        s.lastTs = ts;
        saveAvgState(orgId, s);
      }
      const arr = (s.samples || []).slice(-4);
      if (!arr.length) return null;
      return Math.round(arr.reduce((a,b)=>a+b,0) / arr.length);
    }
    function getLearnedAvg(orgId){
      const s = loadAvgState(orgId);
      const arr = (s.samples || []).slice(-4);
      if (!arr.length) return null;
      return Math.round(arr.reduce((a,b)=>a+b,0) / arr.length);
    }

    // ===== Data helpers =====
    function toUnit(obj, kind){
      const id = obj.id ?? obj.soato_id ?? obj.soatoId ?? obj.code ?? (obj.name_uz || obj.name_ru || Math.random().toString(16).slice(2));
      return {
        id: String(id),
        region_id: String(obj.region_id ?? obj.regionId ?? obj.parent_id ?? obj.parentId ?? obj.region ?? ""),
        kind,
        name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
        name_ru: obj.name_ru ?? obj.nameRu ?? "",
        name_oz: obj.name_oz ?? obj.nameOz ?? ""
      };
    }
    function toRegion(obj){
      return {
        id: String(obj.id ?? obj.soato_id ?? obj.soatoId ?? obj.code),
        name_uz: obj.name_uz ?? obj.nameUz ?? obj.name ?? "",
        name_ru: obj.name_ru ?? obj.nameRu ?? "",
        name_oz: obj.name_oz ?? obj.nameOz ?? ""
      };
    }
    function labelByLang(obj, lang){
      if (lang === "ru") return obj.name_ru || obj.name_uz;
      if (lang === "en") return obj.name_uz || obj.name_ru;
      return obj.name_uz || obj.name_ru;
    }

    async function loadAllData(){
      CFG = await apiGet("/api/geo");
      orgsByUzKey = CFG.orgsByUnitUzKey || {};

      const regionsRaw = await fetchJsonSmart(CFG.sources?.regions);
      regions = (Array.isArray(regionsRaw) ? regionsRaw : []).map(toRegion);

      const districtsRaw = await fetchJsonSmart(CFG.sources?.districts);
      const districts = (Array.isArray(districtsRaw) ? districtsRaw : []).map(x => toUnit(x, "district"));

      let cities = [];
      try {
        const citiesRaw = await fetchJsonSmart(CFG.sources?.cities);
        cities = (Array.isArray(citiesRaw) ? citiesRaw : []).map(x => toUnit(x, "city"));
      } catch(e) {
        cities = [];
      }

      unitsByRegionId = new Map();
      for (const u of [...districts, ...cities]) {
        if (!u.region_id) continue;
        if (!unitsByRegionId.has(u.region_id)) unitsByRegionId.set(u.region_id, []);
        unitsByRegionId.get(u.region_id).push(u);
      }
      for (const [rid, arr] of unitsByRegionId.entries()) {
        arr.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
      }
      regions.sort((a,b)=> (a.name_uz || "").localeCompare(b.name_uz || ""));
    }

    // ===== UI apply =====
    function applyLang(lang){
      const t = UI[lang] || UI.uz;

      $("heroTitle").textContent = t.heroTitle;
      $("heroSub").textContent = t.heroSub;

      $("lblLang").textContent = t.lblLang;
      $("lblRegion").textContent = t.lblRegion;
      $("lblUnit").textContent = t.lblUnit;
      $("lblOrg").textContent = t.lblOrg;

      $("hintLang").textContent = t.hintLang;
      $("hintRegion").textContent = t.hintRegion;
      $("hintUnit").textContent = t.hintUnit;
      $("hintOrg").textContent = t.hintOrg;

      $("saveBtn").textContent = t.save;
      $("howTitle").textContent = t.howTitle;
      $("howText").textContent = t.howText;
      $("botText").textContent = t.bot;

      $("lblTicket").textContent = t.ticket;
      $("takeBtn").textContent = t.take;
      $("lblFullName").textContent = t.lblFullName;
$("hintName").textContent = t.hintName;

    }

    function rebuildRegions(){
      const lang = state.lang;
      const items = regions.map(r => ({ value: r.id, label: labelByLang(r, lang) }));
      setOptions($("regionSel"), items, "‚Äî");
      $("regionSel").disabled = false;
      if (state.regionId) $("regionSel").value = state.regionId;
    }

    function rebuildUnits(){
      const lang = state.lang;
      const rid = state.regionId;
      const sel = $("unitSel");

      state.unitId = "";
      state.orgId = "";
      $("orgSel").disabled = true;
      setOptions($("orgSel"), [], "‚Äî");

      if (!rid) {
        sel.disabled = true;
        setOptions(sel, [], "‚Äî");
        return;
      }

      const units = unitsByRegionId.get(String(rid)) || [];
      const items = units.map(u => {
        const base = labelByLang(u, lang);
        const prefix = (u.kind === "city")
          ? (lang==="uz" ? "Shahar: " : lang==="ru" ? "–ì–æ—Ä–æ–¥: " : "City: ")
          : (lang==="uz" ? "Tuman: " : lang==="ru" ? "–†–∞–π–æ–Ω: " : "District: ");
        return { value: u.id, label: prefix + base };
      });

      setOptions(sel, items, "‚Äî");
      sel.disabled = false;
      if (state.unitId) sel.value = state.unitId;
    }

    function rebuildOrgs(){
      const lang = state.lang;
      const rid = state.regionId;
      const uid = state.unitId;

      if (!rid || !uid) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        return;
      }

      const region = regions.find(r => String(r.id) === String(rid));
      const units = unitsByRegionId.get(String(rid)) || [];
      const unit = units.find(u => String(u.id) === String(uid));

      if (!region || !unit) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        return;
      }

      const uzKey = normKey(region.name_uz) + "|" + normKey(unit.name_uz);
      const orgs = orgsByUzKey[uzKey] || [];

      if (!orgs.length) {
        $("orgSel").disabled = true;
        setOptions($("orgSel"), [], "‚Äî");
        toast((UI[lang]||UI.uz).notFoundOrg);
        return;
      }

      const items = orgs.map(o => ({
        value: o.id,
        label: (o.name && o.name[lang]) ? o.name[lang] : (o.name?.uz || o.id)
      }));

      setOptions($("orgSel"), items, "‚Äî");
      $("orgSel").disabled = false;
      if (state.orgId) $("orgSel").value = state.orgId;
    }

    function setTicketUIVisible(on){
      $("ticketInfo").classList.toggle("hidden", !on);
    }
    function setWarn(msg){
      const w = $("warnBox");
      if (!msg) { w.classList.add("hidden"); w.textContent=""; return; }
      w.textContent = msg;
      w.classList.remove("hidden");
    }
    function setTicketStateBadge(txt){
      $("ticketState").textContent = txt || "‚Äî";
    }

   function updateSaveBtn(){
  const okSelect = !!(state.lang && state.regionId && state.unitId && state.orgId);
  const okName = !!(state.fullName && state.fullName.length >= 3);

  $("saveBtn").disabled = !(okSelect && okName);

  const hasActive = (ticket && ticket.status === "active");
  $("takeBtn").disabled = !(okSelect && okName) || hasActive;
}


    function computeAheadBehind(nowServing, lastNumber, myNumber){
      if (![nowServing,lastNumber,myNumber].every(x=>isFinite(x))) return { ahead:null, behind:null };
      const ahead = Math.max(0, myNumber - nowServing);
      const behind = Math.max(0, lastNumber - myNumber);
      return { ahead, behind };
    }

    function resetNotifsIfNewTicket(){
      notified10 = false;
      notifiedNow = false;
      notifiedCancelled = false;
    }

    function startCountdown(){
      stopCountdown();
      countdownTimer = setInterval(()=>{
        if (!etaEndTs) { $("countdownText").textContent = "Countdown: ‚Äî"; return; }
        const left = etaEndTs - Date.now();
        $("countdownText").textContent = "Countdown: " + (left <= 0 ? "00:00:00" : fmtCountdown(left));
      }, 1000);
    }
    function stopCountdown(){
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
    }

    function maybeNotify(ahead, statusKpiText, badge){
      const t = getT(state.lang);
      if (!ticket || ticket.status !== "active") return;

      // 10 ta oldin
      if (ahead === 10 && !notified10) {
        notified10 = true;
        pushNotif("NAVBATUZ", t.notif10, "navbatuz-10");
      }

      // navbat keldi
      if (badge === "NOW" && !notifiedNow) {
        notifiedNow = true;
        pushNotif("NAVBATUZ", t.notifNow, "navbatuz-now");
      }

      // cancelled
      if ((badge === "CANCELLED") && !notifiedCancelled) {
        notifiedCancelled = true;
        pushNotif("NAVBATUZ", t.notifCancelled, "navbatuz-cancel");
      }
    }

    function renderTicketStatus(data){
      const t = getT(state.lang);

      if (!ticket || !ticket.number) {
        setTicketUIVisible(false);
        setTicketStateBadge("‚Äî");
        $("etaText").textContent = "ETA: ‚Äî";
        $("countdownText").textContent = "Countdown: ‚Äî";
        stopCountdown();
        return;
      }

      const my = Number(ticket.number);
      const nowServing = isFinite(data?.nowServing) ? data.nowServing : null;

      // server ticket status (missed/cancelled/served) bo'lsa olamiz:
      const serverTicketStatus = data?.ticket?.status || null;

      let learnedAvg = null;
      const orgId = ticket.orgId;
      if (orgId && isFinite(nowServing)) learnedAvg = updateLearnedAvg(orgId, nowServing);

      let avgSec = null;
      if (isFinite(data?.avgServiceSec) && data.avgServiceSec > 0) avgSec = Math.round(data.avgServiceSec);
      else avgSec = learnedAvg ?? getLearnedAvg(orgId);

      let lastNumber = isFinite(data?.lastNumber) ? data.lastNumber : my;
      const { ahead, behind } = computeAheadBehind(nowServing, lastNumber, my);

      let uiStatus = "Waiting";
      let badge = "Waiting";
      let etaMin = null;

      setWarn(null);
      $("nowServingBadge").textContent = isFinite(nowServing) ? ("Now: " + nowServing) : "Now: ‚Äî";

      // ‚úÖ serverdan cancelled/missed kelgan bo'lsa shuni ustun qo'yamiz
      if (serverTicketStatus === "cancelled") {
        uiStatus = "Auto-cancelled";
        badge = "CANCELLED";
        setWarn(t.autoCancelled);
        ticket.status = "cancelled";
        saveTicket();
        stopPolling();
        updateSaveBtn();
      } else if (serverTicketStatus === "served") {
        uiStatus = t.served;
        badge = "NOW";
        setWarn(t.served);
      } else if (serverTicketStatus === "missed") {
        uiStatus = "Missed (grace)";
        badge = "GRACE";
        if (isFinite(nowServing)) {
          const diff = nowServing - my;
          const leftGrace = Math.max(0, 5 - diff);
          setWarn(`${t.missed} (Qolgan: ${leftGrace} ta)`);
        } else {
          setWarn(t.missed);
        }
      } else {
        // client logic fallback
        if (isFinite(nowServing) && my === nowServing) {
          uiStatus = t.served;
          badge = "NOW";
          setWarn(t.served);
        } else if (isFinite(nowServing) && my > nowServing) {
          uiStatus = "Waiting";
          badge = "Waiting";
        } else if (isFinite(nowServing) && my < nowServing) {
          const diff = nowServing - my;
          if (diff <= 5) {
            uiStatus = "Missed (grace)";
            badge = "GRACE";
            setWarn(`${t.missed} (Qolgan: ${5 - diff} ta)`);
          } else {
            uiStatus = "Auto-cancelled";
            badge = "CANCELLED";
            setWarn(t.autoCancelled);
            ticket.status = "cancelled";
            saveTicket();
            tryCancelOnServer().catch(()=>{});
            stopPolling();
            updateSaveBtn();
          }
        }
      }

      if (avgSec && isFinite(ahead)) etaMin = (ahead * avgSec) / 60;

      // countdown end time
      if (avgSec && isFinite(ahead)) {
        const etaMs = Math.max(0, Math.round(ahead * avgSec * 1000));
        etaEndTs = Date.now() + etaMs;
        startCountdown();
      } else {
        etaEndTs = null;
        stopCountdown();
      }

      $("ticketNo").textContent = "#" + my;
      $("ticketMeta").textContent = `ORG: ${ticket.orgId} ‚Ä¢ ${new Date(ticket.createdAt||Date.now()).toLocaleString()}`;
      $("aheadKpi").textContent = (ahead===null ? "‚Äî" : ahead);
      $("behindKpi").textContent = (behind===null ? "‚Äî" : behind);
      $("avgKpi").textContent = avgSec ? `${avgSec}s` : "‚Äî";
      $("statusKpi").textContent = uiStatus;
      $("etaText").textContent = "ETA: " + (etaMin===null ? "‚Äî" : fmtTimeFromMinutes(etaMin));

      setTicketStateBadge(badge);
      setTicketUIVisible(true);
      $("takeBtn").disabled = true;

      // notifications
      if (ahead !== null) lastAhead = ahead;
      maybeNotify(ahead, uiStatus, badge);
    }

    // ===== Ticket API logic =====
   if (!state.fullName || state.fullName.length < 3) {
  toast(getT(state.lang).needName);
  updateSaveBtn();
  return;
}

const j = await apiPost("/api/take", {
  orgId: state.orgId,
  platform: "web",
  userId: null,
  fullName: state.fullName
});


        if (!j || !j.ok) throw new Error(j?.error || "take failed");

        const num = Number(j.number ?? j.ticket?.number);
        if (!isFinite(num) || num <= 0) throw new Error("bad number");

        const nowServing = Number(j.nowServing ?? j.ticket?.nowServing ?? (j.ticket?.currentNumber ? (j.ticket.currentNumber+1) : null));
        const lastNumber = Number(j.lastNumber ?? j.ticket?.lastNumber ?? j.ticket?.number ?? num);
        const avgServiceSec = Number(j.avgServiceSec ?? j.ticket?.avgServiceSec ?? null);

        ticket = {
          orgId: state.orgId,
          ticketId: j.ticketId ?? j.ticket?.id ?? null,
          number: num,
          createdAt: Date.now(),
          status: "active"
        };
        saveTicket();
        resetNotifsIfNewTicket();

        toast(t.taken);
        setOnlineBadge(true);

        // notification permission so'raymiz (faqat ticket olinganda)
        ensureNotifPermission().catch(()=>{});

        renderTicketStatus({ nowServing, lastNumber, avgServiceSec, ticket: j.ticket || null });
        startPolling();
      }catch(e){
        console.error(e);
        setOnlineBadge(false);
        toast(t.apiFail);
        setTicketStateBadge("‚Äî");
        updateSaveBtn();
      }
    }

    async function fetchTicketStatus(){
      if (!ticket || !ticket.orgId) return;
      const orgId = ticket.orgId;

      let j = null;
      try{
        if (ticket.ticketId) {
          j = await apiGet(`/api/ticket/${encodeURIComponent(ticket.ticketId)}`);
        } else {
          j = await apiGet(`/api/ticket?orgId=${encodeURIComponent(orgId)}&number=${encodeURIComponent(ticket.number)}`);
        }
      } catch (e) {
        j = await apiGet(`/api/ticket?orgId=${encodeURIComponent(orgId)}&number=${encodeURIComponent(ticket.number)}`);
      }

      if (!j || !j.ok) throw new Error(j?.error || "status fail");

      const nowServing = Number(j.nowServing ?? j.ticket?.nowServing ?? (j.ticket?.currentNumber ? (j.ticket.currentNumber+1) : null));
      const lastNumber = Number(j.lastNumber ?? j.ticket?.lastNumber ?? null);
      const avgServiceSec = Number(j.avgServiceSec ?? j.ticket?.avgServiceSec ?? null);

      setOnlineBadge(true);
      renderTicketStatus({ nowServing, lastNumber, avgServiceSec, ticket: j.ticket || null });
    }

    function startPolling(){
      stopPolling();
      pollTimer = setInterval(()=> {
        fetchTicketStatus().catch((e)=>{
          console.error(e);
          setOnlineBadge(false);
        });
      }, 5000);

      fetchTicketStatus().catch((e)=>{
        console.error(e);
        setOnlineBadge(false);
      });
    }

    function stopPolling(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
      stopCountdown();
    }

    async function tryCancelOnServer(){
      if (!ticket) return;
      try{
        await apiPost("/api/cancel", {
          orgId: ticket.orgId,
          number: ticket.number
        });
      }catch(e){}
    }

    async function cancelTicket(){
      const t = getT(state.lang);
      if (!ticket) return;

      $("cancelBtn").disabled = true;
      try{ await tryCancelOnServer(); } catch(_){}

      ticket.status = "cancelled";
      saveTicket();
      stopPolling();

      setTicketStateBadge("CANCELLED");
      $("statusKpi").textContent = "Cancelled";
      setWarn(null);
      toast(t.cancelled);
      pushNotif("NAVBATUZ", t.notifCancelled, "navbatuz-cancel-user");

      $("cancelBtn").disabled = false;
      updateSaveBtn();
    }

    // ===== Events =====
    $("langSel").addEventListener("change", () => {
      state.lang = $("langSel").value;
      localStorage.setItem("lang", state.lang);
      applyLang(state.lang);

      rebuildRegions();
      rebuildUnits();
      rebuildOrgs();
      updateSaveBtn();

      if (ticket && ticket.status === "active") fetchTicketStatus().catch(()=>{});
    });
$("fullNameInp").addEventListener("input", () => {
  state.fullName = ($("fullNameInp").value || "").trim().replace(/\s+/g, " ").slice(0, 80);
  localStorage.setItem("fullName", state.fullName);
  updateSaveBtn();
});

    $("regionSel").addEventListener("change", () => {
      state.regionId = $("regionSel").value;
      localStorage.setItem("regionId", state.regionId);

      state.unitId = "";
      state.orgId = "";
      localStorage.removeItem("unitId");
      localStorage.removeItem("orgId");

      rebuildUnits();
      rebuildOrgs();
      updateSaveBtn();
    });

    $("unitSel").addEventListener("change", () => {
      state.unitId = $("unitSel").value;
      localStorage.setItem("unitId", state.unitId);

      state.orgId = "";
      localStorage.removeItem("orgId");

      rebuildOrgs();
      updateSaveBtn();
    });

    $("orgSel").addEventListener("change", () => {
      state.orgId = $("orgSel").value;
      localStorage.setItem("orgId", state.orgId);
      updateSaveBtn();
    });

    $("saveBtn").addEventListener("click", () => {
      localStorage.setItem("navbatuz_selection", JSON.stringify(state));
      toast(getT(state.lang).saved);
      updateSaveBtn();
    });

    $("takeBtn").addEventListener("click", () => takeTicket());
    $("refreshBtn").addEventListener("click", () => {
      fetchTicketStatus().catch((e)=>{
        console.error(e);
        setOnlineBadge(false);
        toast(getT(state.lang).apiFail);
      });
    });
    $("cancelBtn").addEventListener("click", () => cancelTicket());
    $("servedBtn").addEventListener("click", async () => {
  if (!ticket?.ticketId) {
    toast("ticketId yo‚Äòq");
    return;
  }

  try{
    const j = await apiPost("/api/ticket/served", {
      ticketId: ticket.ticketId
    });

    if (!j.ok) throw new Error(j.error || "served error");

    toast(getT(state.lang).servedOk);

    // statusni yangilaymiz
    fetchTicketStatus().catch(()=>{});

  }catch(e){
    console.error(e);
    toast("Served xato");
  }
});


    // ===== Boot =====
    (async function boot(){
      try{
        $("langSel").value = state.lang;
        applyLang(state.lang);
$("fullNameInp").value = state.fullName || "";

        try {
          await apiGet("/api/health");
          setOnlineBadge(true);
        } catch(e) {
          setOnlineBadge(false);
        }

        await loadAllData();

        rebuildRegions();
        if (state.regionId) $("regionSel").value = state.regionId;

        rebuildUnits();
        if (state.unitId) $("unitSel").value = state.unitId;

        rebuildOrgs();
        if (state.orgId) $("orgSel").value = state.orgId;

        loadTicket();
        if (ticket && ticket.status === "active") {
          setTicketUIVisible(true);
          setTicketStateBadge("Active");
          updateSaveBtn();
          startPolling();
        } else {
          ticket = null;
          saveTicket();
          setTicketUIVisible(false);
          setTicketStateBadge("‚Äî");
          updateSaveBtn();
        }
      } catch(e){
        console.error(e);
        toast(getT(state.lang).apiFail);
        setOnlineBadge(false);
      }
    })();
  </script>
</body>
</html>


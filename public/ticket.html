<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ticket</title>
  <style>
    body{ font-family: Arial, sans-serif; background:#0f172a; color:#fff; margin:0; padding:24px; }
    .wrap{ max-width:720px; margin:0 auto; }
    .card{ background:#1e293b; border-radius:16px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .btn{ border:0; border-radius:12px; padding:12px 16px; font-size:16px; cursor:pointer; }
    .btnGreen{ background:#16a34a; color:#fff; }
    .btnBlue{ background:#2563eb; color:#fff; }
    .muted{ opacity:.8; font-size:14px; }
    .err{ background:#7f1d1d; padding:12px; border-radius:12px; }
    canvas{ background:#fff; border-radius:14px; display:block; width:100%; max-width:520px; margin:16px auto 0; }
    .title{ font-size:22px; font-weight:700; margin:0 0 6px; }
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
    .box{ background:#0b1224; border-radius:12px; padding:12px; }
    .box b{ display:block; font-size:13px; opacity:.85; margin-bottom:6px; }
    .box span{ font-size:18px; }
    .toplink{ color:#93c5fd; text-decoration:none; }
    .toplink:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="top">
        <div class="title" id="tTitle">Ticket</div>
        <div class="muted" id="tSub">—</div>
        <div class="muted" style="margin-top:6px;">
          <a class="toplink" href="/" id="goHome">Asosiy sahifa</a>
        </div>
      </div>

      <div id="errorBox" class="err" style="display:none; margin-top:12px;"></div>

      <div class="kv">
        <div class="box"><b id="lNumber">Raqam</b><span id="vNumber">—</span></div>
        <div class="box"><b id="lStatus">Holat</b><span id="vStatus">—</span></div>
        <div class="box"><b id="lNow">Hozir</b><span id="vNow">—</span></div>
        <div class="box"><b id="lRemain">Oldinda</b><span id="vRemain">—</span></div>
        <div class="box"><b id="lName">Ism familiya</b><span id="vName">—</span></div>
        <div class="box"><b id="lETA">ETA</b><span id="vETA">—</span></div>
      </div>

      <canvas id="ticketCanvas" width="700" height="900"></canvas>

      <div class="row" style="margin-top:14px;">
        <button class="btn btnGreen" id="btnServed">✅ Xizmat ko‘rsatildi</button>
        <button class="btn btnBlue" id="btnJpg">⬇️ JPG yuklab olish</button>
      </div>

      <div class="muted" id="servedNote" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
  const lang = (localStorage.getItem("lang") || "uz").toLowerCase();
  const T = {
    uz: {
      ticket: "Ticket",
      loading: "Yuklanmoqda...",
      noId: "ID topilmadi. QR link: ticket.html?id=XXXX",
      number: "Raqam",
      status: "Holat",
      now: "Hozir",
      remain: "Oldinda",
      name: "Ism familiya",
      eta: "ETA",
      servedBtn: "✅ Xizmat ko‘rsatildi",
      jpgBtn: "⬇️ JPG yuklab olish",
      servedWarn: "Diqqat: bosilsa served deb belgilanadi va o‘rtacha vaqt hisoblanadi.",
      confirmServed: "Rostdan ham served qilasizmi?",
      statusMap: { waiting:"Waiting", missed:"Missed", cancelled:"Cancelled", served:"Served" },
      openMain: "Asosiy sahifa"
    },
    ru: {
      ticket: "Талон",
      loading: "Загрузка...",
      noId: "Нет ID. QR ссылка: ticket.html?id=XXXX",
      number: "Номер",
      status: "Статус",
      now: "Сейчас",
      remain: "Перед вами",
      name: "Имя Фамилия",
      eta: "ETA",
      servedBtn: "✅ Обслужено",
      jpgBtn: "⬇️ Скачать JPG",
      servedWarn: "Внимание: отметит как обслужено и будет считаться в среднем времени.",
      confirmServed: "Точно отметить как обслужено?",
      statusMap: { waiting:"Ожидание", missed:"Пропущен", cancelled:"Отменён", served:"Обслужен" },
      openMain: "Главная"
    },
    en: {
      ticket: "Ticket",
      loading: "Loading...",
      noId: "Missing ID. QR link: ticket.html?id=XXXX",
      number: "Number",
      status: "Status",
      now: "Now",
      remain: "Ahead",
      name: "Full name",
      eta: "ETA",
      servedBtn: "✅ Served",
      jpgBtn: "⬇️ Download JPG",
      servedWarn: "Warning: marks served and used for average service time.",
      confirmServed: "Mark as served?",
      statusMap: { waiting:"Waiting", missed:"Missed", cancelled:"Cancelled", served:"Served" },
      openMain: "Home"
    }
  };
  const tr = T[lang] || T.uz;

  document.title = tr.ticket;
  document.getElementById("tTitle").textContent = tr.ticket;
  document.getElementById("lNumber").textContent = tr.number;
  document.getElementById("lStatus").textContent = tr.status;
  document.getElementById("lNow").textContent = tr.now;
  document.getElementById("lRemain").textContent = tr.remain;
  document.getElementById("lName").textContent = tr.name;
  document.getElementById("lETA").textContent = tr.eta;
  document.getElementById("btnServed").textContent = tr.servedBtn;
  document.getElementById("btnJpg").textContent = tr.jpgBtn;
  document.getElementById("servedNote").textContent = tr.servedWarn;
  document.getElementById("goHome").textContent = tr.openMain;

  const qs = new URLSearchParams(location.search);
  const id = qs.get("id");

  const errorBox = document.getElementById("errorBox");
  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "—";
      return d.toLocaleString();
    }catch{ return "—"; }
  }

  async function drawTicketCanvas(data){
    const c = document.getElementById("ticketCanvas");
    const ctx = c.getContext("2d");

    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,c.width,c.height);

    ctx.fillStyle = "#111827";
    ctx.font = "bold 48px Arial";
    ctx.fillText(`#${data.number ?? "-"}`, 40, 90);

    ctx.font = "24px Arial";
    ctx.fillText(`ORG: ${data.orgId || "-"}`, 40, 140);

    ctx.font = "22px Arial";
    ctx.fillText(`${tr.status}: ${data.statusText || "-"}`, 40, 185);

    ctx.font = "22px Arial";
    ctx.fillText(`${tr.now}: ${data.nowServing ?? "-"}`, 40, 225);

    ctx.font = "22px Arial";
    ctx.fillText(`${tr.remain}: ${data.remaining ?? "-"}`, 40, 265);

    ctx.font = "22px Arial";
    ctx.fillText(`${tr.name}: ${data.fullName || "-"}`, 40, 305);

    ctx.font = "22px Arial";
    ctx.fillText(`${tr.eta}: ${data.etaMinutes != null ? (data.etaMinutes + " min") : "-"}`, 40, 345);

    ctx.font = "18px Arial";
    ctx.fillText(`${fmtDate(data.createdAt)}`, 40, 385);

    if (data.qrPngBase64){
      const img = new Image();
      await new Promise((resolve)=>{ img.onload = resolve; img.onerror = resolve; img.src = data.qrPngBase64; });
      const size = 380;
      const x = Math.round((c.width - size)/2);
      const y = 430;
      ctx.drawImage(img, x, y, size, size);
      ctx.font = "18px Arial";
      ctx.fillStyle = "#111827";
      ctx.fillText(data.qrData || "", 40, 845);
    }
  }

  function downloadCanvasJpg(){
  const c = document.getElementById("ticketCanvas");
  if (!c) return;

  const dataUrl = c.toDataURL("image/jpeg", 0.95);
  const fileName = `ticket_${id || "unknown"}.jpg`;

  // ✅ 1) Android/WebView uchun: DOM'ga qo‘shib keyin click
  const a = document.createElement("a");
  a.href = dataUrl;
  a.download = fileName;
  a.target = "_blank";
  a.rel = "noopener";

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // ✅ 2) Samsung/WebView’da download ishlamasa — fallback:
  // rasmni yangi oynada ochib beradi, user "Save image" qiladi
  setTimeout(() => {
    try {
      // agar yuqoridagisi ishlamasa, rasmni ochib beramiz
      const w = window.open();
      if (w) {
        w.document.write(`<title>${fileName}</title>`);
        w.document.write(`<img src="${dataUrl}" style="width:100%;height:auto" />`);
        w.document.close();
      } else {
        // popup blok bo‘lsa — shu oynada ochamiz
        window.location.href = dataUrl;
      }
    } catch (e) {
      window.location.href = dataUrl;
    }
  }, 250);
}

  async function load(){
    if (!id){
      showError(tr.noId);
      document.getElementById("tSub").textContent = tr.openMain + ": /";
      return;
    }

    document.getElementById("tSub").textContent = tr.loading;

    const r = await fetch(`/api/ticket/${encodeURIComponent(id)}`, { cache:"no-store" });
    const j = await r.json().catch(()=>null);

    if (!r.ok || !j || !j.ok){
      showError((j && j.error) ? j.error : ("API error: " + r.status));
      return;
    }

    const t = j.ticket || {};
    const statusRaw = (t.status || "").toLowerCase();
    const statusText = (tr.statusMap[statusRaw] || t.status || "-");
    const remaining = Math.max(0, (t.number || 0) - (j.nowServing || 0));
    const fullName = t.fullName || t.full_name || "-";

    document.getElementById("tSub").textContent = `ORG: ${t.orgId || t.org_id || "-"} • ${fmtDate(t.createdAt || t.created_at)}`;
    document.getElementById("vNumber").textContent = t.number ?? "-";
    document.getElementById("vStatus").textContent = statusText;
    document.getElementById("vNow").textContent = j.nowServing ?? "-";
    document.getElementById("vRemain").textContent = remaining;
    document.getElementById("vName").textContent = fullName;

    const etaMin = (j.avgServiceSec ? Math.round((remaining * j.avgServiceSec)/60) : null);
    document.getElementById("vETA").textContent = (etaMin != null ? (etaMin + " min") : "—");

    await drawTicketCanvas({
      number: t.number,
      orgId: t.orgId || t.org_id,
      statusText,
      nowServing: j.nowServing,
      remaining,
      fullName,
      etaMinutes: etaMin,
      createdAt: t.createdAt || t.created_at,
      qrPngBase64: j.qrPngBase64 || t.qrPngBase64 || null,
      qrData: j.qrData || t.qrData || (location.origin + "/ticket.html?id=" + id)
    });
  }

  document.getElementById("btnJpg").addEventListener("click", downloadCanvasJpg);

  document.getElementById("btnServed").addEventListener("click", async () => {
    if (!id) return;
    if (!confirm(tr.confirmServed)) return;

    const r = await fetch("/api/ticket/served", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ ticketId: id }),
      cache:"no-store"
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j || !j.ok){
      alert((j && j.error) ? j.error : ("API error: " + r.status));
      return;
    }
    await load();
  });

  load();
</script>
</body>
</html>
